/*******************************************************************************
** File Name: zi_communication.c
** Copyright: 2007-2012 Nationz Technologies Corp. All rights reserved.
** Version: 1.0
** Description: This file implement the cmmb file.
********************************************************************************/

#ifdef __cplusplus
	extern "C"
	{
#endif

#include <linux/mutex.h>
#include "zi_communication.h"
#include "zi_platform.h"

extern Zi_DEVICE_HANDLE* Zi_pCmmbDevice;
Zi_INT32 Zi_irq_count = 0;
extern Zi_VOID Zi_irq_level(Zi_UINT8 iplace);


static Zi_UINT8 Zi_scConfigRegTable[6][4]={
	{REG_SC_INFO_A, REG_SC0_CONFIG_A, REG_SC0_CONFIG_B,REG_SC0_SC1_THR},
	{REG_SC_INFO_A, REG_SC1_CONFIG_A, REG_SC1_CONFIG_B,REG_SC0_SC1_THR},
	{REG_SC_INFO_B, REG_SC2_CONFIG_A, REG_SC2_CONFIG_B,REG_SC2_SC3_THR},
	{REG_SC_INFO_B, REG_SC3_CONFIG_A, REG_SC3_CONFIG_B,REG_SC2_SC3_THR},
	{REG_SC_INFO_C, REG_SC4_CONFIG_A, REG_SC4_CONFIG_B,REG_SC4_SC5_THR},
	{REG_SC_INFO_C, REG_SC5_CONFIG_A, REG_SC5_CONFIG_B,REG_SC4_SC5_THR}
};

static Zi_UINT8 Zi_scRegTable[6][3]={
	{REG_SC_01_SEED_NUM, REG_SC0_BGN_SLOT, REG_SC0_NUM},
	{REG_SC_01_SEED_NUM, REG_SC1_BGN_SLOT, REG_SC1_NUM},
	{REG_SC_23_SEED_NUM, REG_SC2_BGN_SLOT, REG_SC2_NUM},
	{REG_SC_23_SEED_NUM, REG_SC3_BGN_SLOT, REG_SC3_NUM},
	{REG_SC_45_SEED_NUM, REG_SC4_BGN_SLOT, REG_SC4_NUM},
	{REG_SC_45_SEED_NUM, REG_SC5_BGN_SLOT, REG_SC5_NUM}
};

static Zi_UINT8  Zi_dataAvailReg[6][2] = {
	{REG_CH0_DATA_AVAIL_CNT_H, REG_CH0_DATA_AVAIL_CNT_L},
	{REG_CH1_DATA_AVAIL_CNT_H, REG_CH1_DATA_AVAIL_CNT_L},
	{REG_CH2_DATA_AVAIL_CNT_H, REG_CH2_DATA_AVAIL_CNT_L},
	{REG_CH3_DATA_AVAIL_CNT_H, REG_CH3_DATA_AVAIL_CNT_L},
	{REG_CH4_DATA_AVAIL_CNT_H, REG_CH4_DATA_AVAIL_CNT_L},
	{REG_CH5_DATA_AVAIL_CNT_H, REG_CH5_DATA_AVAIL_CNT_L}
};

static Zi_UINT8  Zi_dataReg[6] = {
	REG_CH0_DATA_ADDR,
	REG_CH1_DATA_ADDR,
	REG_CH2_DATA_ADDR,
	REG_CH3_DATA_ADDR,
	REG_CH4_DATA_ADDR,
	REG_CH5_DATA_ADDR
};


static Zi_UINT8 gCoeffTable[COEFF_ARRAY_LEN]={
	5  , 5  , 3  , 81 , 56 , 99 , 29 , 201, 18 , 188, 212, 128, 13 , 0  , 189, 10 , 
	144, 150, 8  , 32 , 111, 5  , 176, 72 , 3  , 64 , 33 , 0  , 255, 252, 254, 175, 
	216, 252, 127, 182, 12 , 176, 184, 10 , 96 , 147, 8  , 0  , 109, 5  , 160, 72 , 
	3  , 80 , 35 , 1  , 15 , 255, 254, 223, 220, 252, 191, 187, 12 , 96 , 180, 10 , 
	32 , 144, 7  , 224, 108, 5  , 160, 72 , 3  , 96 , 36 , 1  , 32 , 1  , 255, 15 , 
	223, 252, 255, 191, 12 , 0  , 175, 9  , 224, 141, 7  , 192, 106, 5  , 144, 72 , 
	3  , 96 , 37 , 1  , 64 , 3  , 255, 63 , 227, 253, 63 , 195, 11 , 176, 171, 9  , 
	176, 138, 7  , 160, 105, 5  , 128, 71 , 3  , 112, 38 , 1  , 96 , 6  , 255, 111, 
	230, 253, 127, 200, 11 , 96 , 167, 9  , 112, 135, 7  , 112, 103, 5  , 112, 71 , 
	3  , 112, 40 , 1  , 128, 8  , 255, 159, 234, 253, 191, 204, 11 , 16 , 162, 9  , 
	48 , 132, 7  , 80 , 102, 5  , 112, 71 , 3  , 128, 41 , 1  , 160, 11 , 255, 207, 
	237, 253, 239, 208, 10 , 192, 158, 9  , 0  , 129, 7  , 48 , 101, 5  , 96 , 71 , 
	3  , 144, 42 , 1  , 176, 13 , 255, 255, 240, 254, 47 , 213, 10 , 96 , 153, 8  , 
	192, 127, 7  , 16 , 99 , 5  , 80 , 71 , 3  , 144, 43 , 1  , 208, 15 , 0  , 31 , 
	244, 254, 111, 217, 10 , 16 , 149, 8  , 128, 124, 6  , 240, 98 , 5  , 64 , 71 , 
	3  , 160, 44 , 1  , 240, 18 , 0  , 79 , 247, 254, 175, 221, 9  , 192, 145, 8  , 
	80 , 121, 6  , 208, 96 , 5  , 64 , 71 , 3  , 160, 45 , 2  , 16 , 20 , 0  , 127, 
	251, 254, 239, 226, 9  , 112, 140, 8  , 16 , 118, 6  , 160, 95 , 5  , 48 , 71 , 
	3  , 176, 47 , 2  , 32 , 22 , 0  , 175, 254, 255, 47 , 230, 9  , 32 , 136, 7  , 
	224, 115, 6  , 128, 93 , 5  , 32 , 71 , 3  , 176, 48 , 2  , 64 , 25 , 0  , 208, 
	1  , 255, 111, 235, 8  , 208, 132, 7  , 160, 112, 6  , 96 , 92 , 5  , 16 , 71 , 
	3  , 192, 49 , 2  , 96 , 27 , 1  , 0  , 5  , 255, 175, 239, 8  , 128, 128, 7  , 
	112, 109, 6  , 64 , 90 , 5  , 0  , 70 , 3  , 192, 50 , 2  , 128, 29 , 1  , 48 , 
	8  , 255, 239, 243, 8  , 48 , 123, 7  , 48 , 107, 6  , 32 , 89 , 5  , 0  , 70 , 
	3  , 208, 51 , 2  , 144, 31 , 1  , 96 , 12 , 0  , 47 , 248, 7  , 224, 119, 7  , 
	0  , 104, 6  , 0  , 87 , 4  , 240, 70 , 3  , 208, 52 , 2  , 176, 34 , 1  , 128, 
	15 , 0  , 111, 252, 7  , 144, 115, 6  , 192, 101, 5  , 208, 86 , 4  , 224, 70 , 
	3  , 224, 53 , 2  , 208, 36 , 1  , 176, 18 , 0  , 160, 1  , 7  , 80 , 111, 6  , 
	128, 98 , 5  , 176, 84 , 4  , 208, 70 , 3  , 224, 54 , 2  , 224, 38 , 1  , 224, 
	22 , 0  , 224, 5  , 7  , 0  , 107, 6  , 80 , 95 , 5  , 144, 83 , 4  , 192, 69 , 
	3  , 240, 55 , 3  , 0  , 41 , 2  , 16 , 25 , 1  , 32 , 10 , 6  , 176, 102, 6  , 
	16 , 92 , 5  , 112, 81 , 4  , 176, 69 , 3  , 240, 56 , 3  , 32 , 43 , 2  , 64 , 
	29 , 1  , 80 , 14 , 6  , 96 , 98 , 5  , 224, 90 , 5  , 80 , 80 , 4  , 176, 69 , 
	3  , 240, 57 , 3  , 48 , 45 , 2  , 112, 32 , 1  , 144, 19 , 6  , 16 , 94 , 5  , 
	176, 87 , 5  , 48 , 78 , 4  , 160, 69 , 4  , 0  , 58 , 3  , 80 , 47 , 2  , 160, 
	36 , 1  , 208, 23 , 5  , 208, 90 , 5  , 112, 84 , 5  , 0  , 77 , 4  , 144, 69 , 
	4  , 0  , 59 , 3  , 112, 50 , 2  , 192, 39 , 2  , 16 , 28 , 5  , 128, 86 , 5  , 
	64 , 81 , 4  , 224, 75 , 4  , 128, 68 , 4  , 16 , 60 , 3  , 128, 52 , 2  , 240, 
	42 , 2  , 80 , 32 , 5  , 48 , 82 , 5  , 0  , 78 , 4  , 192, 74 , 4  , 112, 68 , 
	4  , 16 , 61 , 3  , 160, 54 , 3  , 32 , 46 , 2  , 144, 37 , 4  , 224, 78 , 4  , 
	208, 75 , 4  , 160, 72 , 4  , 96 , 68 , 4  , 16 , 62 , 3  , 176, 56 , 3  , 80 , 
	49 , 2  , 208, 41 , 4  , 160, 74 , 4  , 144, 73 , 4  , 128, 71 , 4  , 80 , 67 , 
	4  , 32 , 63 , 3  , 208, 58 , 3  , 128, 53 , 3  , 16 , 46 , 4  , 80 , 70 , 4  , 
	96 , 70 , 4  , 80 , 69 , 4  , 64 , 67 , 4  , 32 , 64 , 3  , 240, 61 , 3  , 160, 
	56 , 3  , 80 , 50 , 4  , 0  , 65 , 4  , 32 , 67 , 4  , 48 , 67 , 4  , 48 , 67 , 
	4  , 32 , 65 , 4  , 0  , 63 , 3  , 208, 59 , 3  , 144, 55 , 3  , 192, 61 , 3  , 
	240, 64 , 4  , 16 , 66 , 4  , 32 , 67 , 4  , 48 , 66 , 4  , 32 , 65 , 4  , 0  , 
	63 , 3  , 208, 60 , 3  , 112, 57 , 3  , 176, 61 , 3  , 240, 64 , 4  , 16 , 66 , 
	4  , 48 , 67 , 4  , 48 , 67 , 4  , 48 , 66 , 4  , 16 , 64 , 24 , 241, 58 , 14 , 
	128, 157, 5  , 160, 34 , 255, 111, 215, 252, 95 , 191, 252, 79 , 211, 254, 144, 
	4  , 2  , 16 , 63 , 23 , 113, 44 , 14 , 32 , 158, 6  , 0  , 43 , 0  , 31 , 226, 
	252, 255, 199, 252, 159, 213, 254, 128, 0  , 1  , 176, 55 , 21 , 241, 30 , 13 , 
	192, 158, 6  , 96 , 52 , 0  , 207, 237, 253, 159, 207, 252, 255, 215, 254, 127, 
	252, 1  , 80 , 48 , 20 , 129, 15 , 13 , 96 , 159, 6  , 176, 61 , 1  , 111, 248, 
	254, 63 , 215, 253, 79 , 218, 254, 111, 249, 0  , 240, 40 , 19 , 33 , 2  , 13 , 
	0  , 158, 6  , 240, 69 , 2  , 0  , 3  , 254, 223, 223, 253, 175, 220, 254, 111, 
	245, 0  , 144, 32 , 17 , 192, 244, 12 , 144, 158, 7  , 64 , 76 , 2  , 160, 13 , 
	255, 111, 231, 254, 15 , 224, 254, 111, 243, 0  , 64 , 25 , 16 , 96 , 230, 12 , 
	32 , 157, 7  , 112, 84 , 3  , 48 , 23 , 0  , 15 , 239, 254, 111, 227, 254, 127, 
	240, 255, 240, 18 , 15 , 32 , 217, 11 , 192, 156, 7  , 176, 90 , 3  , 192, 32 , 
	0  , 159, 248, 254, 207, 231, 254, 127, 238, 255, 160, 11 , 13 , 208, 203, 11 , 
	80 , 154, 7  , 224, 96 , 4  , 64 , 41 , 1  , 32 , 0  , 255, 47 , 234, 254, 143, 
	236, 255, 96 , 4  , 12 , 160, 190, 10 , 208, 152, 8  , 0  , 102, 4  , 192, 50 , 
	1  , 176, 8  , 255, 159, 238, 254, 175, 235, 255, 31 , 253, 11 , 112, 178, 10 , 
	96 , 150, 8  , 32 , 107, 5  , 48 , 59 , 2  , 64 , 16 , 255, 255, 243, 254, 207, 
	234, 254, 239, 246, 10 , 80 , 165, 9  , 240, 148, 8  , 64 , 112, 5  , 160, 67 , 
	2  , 208, 24 , 0  , 111, 247, 254, 239, 233, 254, 175, 240, 9  , 48 , 153, 9  , 
	128, 145, 8  , 80 , 116, 6  , 16 , 75 , 3  , 80 , 31 , 0  , 207, 252, 255, 15 , 
	233, 254, 127, 234, 8  , 32 , 141, 9  , 0  , 142, 8  , 96 , 120, 6  , 112, 83 , 
	3  , 208, 39 , 1  , 48 , 1  , 255, 63 , 233, 254, 79 , 229, 7  , 32 , 129, 8  , 
	144, 139, 8  , 96 , 123, 6  , 192, 90 , 4  , 80 , 47 , 1  , 144, 6  , 255, 111, 
	233, 254, 47 , 223, 6  , 32 , 117, 8  , 32 , 135, 8  , 96 , 126, 7  , 16 , 96 , 
	4  , 192, 54 , 2  , 0  , 11 , 255, 159, 234, 254, 15 , 219, 5  , 48 , 106, 7  , 
	160, 131, 8  , 80 , 129, 7  , 96 , 102, 5  , 48 , 61 , 2  , 112, 16 , 255, 207, 
	235, 253, 239, 214, 4  , 80 , 95 , 7  , 48 , 127, 8  , 64 , 131, 7  , 160, 108, 
	5  , 160, 68 , 2  , 208, 22 , 0  , 15 , 236, 253, 223, 210, 3  , 128, 85 , 6  , 
	192, 123, 8  , 48 , 132, 7  , 224, 113, 6  , 0  , 75 , 3  , 48 , 27 , 0  , 79 , 
	238, 253, 207, 207, 2  , 176, 75 , 6  , 64 , 119, 8  , 32 , 133, 8  , 16 , 118, 
	6  , 96 , 81 , 3  , 160, 33 , 0  , 143, 240, 253, 207, 204, 1  , 240, 65 , 5  , 
	208, 114, 8  , 0  , 133, 8  , 64 , 123, 6  , 192, 88 , 4  , 0  , 38 , 0  , 207, 
	243, 253, 207, 201, 1  , 64 , 56 , 5  , 96 , 109, 7  , 208, 133, 8  , 96 , 127, 
	7  , 16 , 94 , 4  , 96 , 44 , 1  , 15 , 245, 253, 223, 199, 0  , 160, 47 , 4  , 
	240, 104, 7  , 176, 133, 8  , 112, 130, 7  , 96 , 99 , 4  , 192, 49 , 1  , 95 , 
	249, 253, 239, 198, 0  , 0  , 38 , 4  , 128, 99 , 7  , 128, 132, 8  , 144, 133, 
	7  , 160, 105, 5  , 32 , 55 , 1  , 175, 252, 253, 255, 197, 255, 112, 30 , 4  , 
	16 , 94 , 7  , 64 , 131, 8  , 144, 135, 7  , 224, 110, 5  , 112, 60 , 1  , 240, 
	0  , 254, 31 , 197, 254, 240, 23 , 3  , 176, 89 , 7  , 16 , 129, 8  , 144, 137, 
	8  , 16 , 114, 5  , 208, 66 , 2  , 64 , 4  , 254, 79 , 197, 254, 112, 15 , 3  , 
	64 , 84 , 6  , 208, 127, 8  , 144, 139, 8  , 64 , 118, 6  , 32 , 71 , 2  , 144, 
	8  , 254, 127, 198, 254, 16 , 9  , 2  , 224, 78 , 6  , 144, 125, 8  , 128, 140, 
	8  , 112, 122, 6  , 96 , 77 , 2  , 224, 13 , 254, 175, 200, 253, 176, 2  , 2  , 
	128, 73 , 6  , 80 , 122, 8  , 112, 140, 8  , 144, 126, 6  , 176, 82 , 3  , 48 , 
	18 , 254, 239, 202, 253, 95 , 253, 2  , 32 , 68 , 6  , 0  , 119, 8  , 80 , 140, 
	8  , 176, 129, 6  , 240, 87 , 3  , 144, 23 , 255, 47 , 205, 253, 31 , 247, 1  , 
	192, 62 , 5  , 192, 115, 8  , 48 , 140, 8  , 192, 131, 7  , 48 , 92 , 3  , 224, 
	28 , 255, 127, 209, 252, 223, 242, 1  , 112, 57 , 5  , 112, 111, 8  , 16 , 139, 
	8  , 192, 133, 7  , 112, 96 , 4  , 64 , 34 , 255, 223, 213, 40 , 129, 123, 8  , 
	239, 237, 250, 111, 172, 253, 208, 19 , 3  , 32 , 48 , 1  , 63 , 239, 253, 175, 
	224, 255, 224, 38 , 35 , 129, 114, 11 , 0  , 27 , 252, 143, 183, 253, 63 , 255, 
	2  , 16 , 41 , 1  , 143, 252, 254, 111, 227, 255, 112, 27 , 30 , 209, 103, 12 , 
	208, 69 , 254, 191, 197, 252, 223, 238, 0  , 240, 33 , 1  , 192, 7  , 255, 31 , 
	231, 255, 48 , 17 , 26 , 81 , 88 , 14 , 80 , 109, 0  , 207, 214, 252, 191, 224, 
	255, 240, 23 , 1  , 208, 16 , 255, 207, 237, 255, 0  , 7  , 22 , 33 , 72 , 15 , 
	144, 144, 2  , 239, 233, 252, 223, 213, 255, 16 , 13 , 1  , 192, 24 , 0  , 111, 
	243, 254, 239, 254, 18 , 33 , 53 , 16 , 112, 176, 4  , 239, 253, 253, 47 , 205, 
	254, 48 , 3  , 1  , 144, 29 , 0  , 255, 250, 254, 239, 245, 14 , 129, 32 , 17 , 
	32 , 204, 6  , 208, 20 , 253, 175, 200, 253, 143, 248, 1  , 80 , 32 , 1  , 96 , 
	1  , 254, 255, 238, 11 , 33 , 10 , 17 , 112, 228, 8  , 160, 43 , 254, 95 , 199, 
	252, 255, 238, 0  , 240, 33 , 1  , 208, 8  , 255, 31 , 231, 8  , 16 , 242, 17 , 
	144, 247, 10 , 80 , 67 , 255, 63 , 201, 252, 143, 228, 0  , 128, 32 , 2  , 32 , 
	14 , 255, 79 , 227, 5  , 64 , 217, 17 , 97 , 6  , 11 , 208, 91 , 0  , 63 , 206, 
	252, 79 , 219, 0  , 0  , 30 , 2  , 80 , 20 , 255, 127, 223, 2  , 208, 192, 16 , 
	241, 17 , 13 , 48 , 116, 1  , 111, 215, 252, 47 , 211, 255, 128, 25 , 2  , 96 , 
	26 , 255, 207, 221, 0  , 176, 166, 16 , 65 , 23 , 14 , 96 , 139, 2  , 175, 226, 
	252, 63 , 205, 254, 240, 20 , 2  , 96 , 30 , 0  , 31 , 221, 254, 224, 140, 15 , 
	113, 25 , 15 , 96 , 162, 4  , 15 , 241, 252, 143, 201, 254, 112, 13 , 2  , 64 , 
	34 , 0  , 111, 222, 253, 112, 115, 14 , 97 , 23 , 16 , 32 , 184, 5  , 112, 2  , 
	252, 255, 198, 253, 240, 5  , 2  , 16 , 35 , 0  , 175, 224, 252, 64 , 90 , 13 , 
	33 , 16 , 16 , 160, 203, 6  , 240, 21 , 253, 159, 198, 253, 143, 252, 1  , 176, 
	36 , 0  , 255, 228, 251, 112, 67 , 11 , 209, 6  , 16 , 240, 220, 8  , 96 , 42 , 
	254, 111, 201, 253, 47 , 243, 1  , 80 , 35 , 1  , 79 , 234, 250, 224, 45 , 10 , 
	96 , 248, 16 , 240, 235, 9  , 192, 65 , 255, 95 , 206, 252, 239, 234, 0  , 208, 
	33 , 1  , 127, 241, 250, 144, 24 , 8  , 224, 231, 16 , 192, 247, 11 , 32 , 89 , 
	0  , 127, 214, 252, 191, 225, 0  , 64 , 28 , 1  , 175, 248, 250, 144, 6  , 7  , 
	80 , 211, 16 , 80 , 255, 12 , 96 , 113, 1  , 207, 224, 252, 191, 217, 255, 160, 
	23 , 1  , 192, 0  , 250, 207, 246, 5  , 192, 190, 15 , 177, 4  , 13 , 128, 137, 
	3  , 31 , 237, 252, 223, 210, 255, 0  , 16 , 1  , 192, 9  , 251, 47 , 233, 4  , 
	64 , 166, 14 , 225, 6  , 14 , 128, 160, 4  , 143, 252, 253, 31 , 205, 254, 96 , 
	8  , 1  , 192, 17 , 251, 191, 222, 2  , 208, 141, 13 , 225, 4  , 15 , 64 , 182, 
	6  , 0  , 14 , 253, 143, 202, 253, 208, 0  , 1  , 160, 25 , 252, 111, 214, 1  , 
	128, 116, 12 , 176, 254, 15 , 224, 203, 7  , 128, 34 , 254, 47 , 200, 253, 79 , 
	246, 1  , 112, 33 , 253, 47 , 208, 0  , 64 , 91 , 11 , 96 , 246, 16 , 64 , 221, 
	9  , 0  , 55 , 254, 239, 201, 252, 223, 237, 1  , 48 , 39 , 253, 255, 205, 255, 
	32 , 67 , 10 , 0  , 234, 16 , 112, 237, 10 , 112, 77 , 255, 207, 205, 252, 127, 
	227, 0  , 208, 45 , 254, 223, 204, 254, 48 , 43 , 8  , 144, 220, 16 , 96 , 250, 
	11 , 208, 100, 0  , 223, 211, 252, 63 , 218, 0  , 112, 48 , 255, 175, 205, 253, 
	112, 21 , 7  , 16 , 202, 16 , 17 , 3  , 13 , 16 , 123, 2  , 15 , 220, 252, 31 , 
	210, 0  , 0  , 50 , 0  , 127, 208, 252, 208, 2  , 5  , 160, 183, 15 , 161, 10 , 
	14 , 32 , 146, 3  , 79 , 231, 252, 47 , 203, 255, 128, 50 , 1  , 47 , 212, 252, 
	127, 240, 4  , 48 , 163, 14 , 225, 12 , 15 , 16 , 168, 4  , 175, 245, 252, 95 , 
	198, 255, 0  , 48 , 1  , 207, 218, 252, 63 , 225, 2  , 208, 141, 14 , 1  , 11 , 
	15 , 208, 189, 6  , 0  , 6  , 252, 207, 194, 254, 144, 43 , 2  , 95 , 225, 252, 
	31 , 213, 1  , 128, 118, 13 , 1  , 6  , 16 , 96 , 208, 7  , 96 , 24 , 253, 95 , 
	193, 254, 16 , 37 , 2  , 191, 233, 252, 47 , 204, 0  , 96 , 96 , 11 , 208, 253, 
	16 , 176, 224, 8  , 208, 45 , 254, 31 , 195, 253, 160, 28 , 48 , 33 , 96 , 1  , 
	159, 149, 251, 112, 16 , 3  , 192, 34 , 254, 239, 215, 254, 208, 19 , 1  , 208, 
	5  , 254, 191, 248, 40 , 33 , 123, 6  , 223, 203, 251, 63 , 235, 2  , 48 , 40 , 
	0  , 111, 230, 254, 96 , 0  , 1  , 80 , 16 , 255, 159, 240, 32 , 193, 139, 11 , 
	96 , 3  , 251, 143, 207, 0  , 144, 40 , 1  , 159, 246, 254, 79 , 241, 0  , 192, 
	22 , 0  , 95 , 236, 25 , 241, 144, 15 , 64 , 58 , 252, 127, 188, 255, 32 , 35 , 
	2  , 96 , 4  , 254, 95 , 230, 0  , 32 , 25 , 0  , 255, 235, 19 , 193, 138, 18 , 
	128, 113, 253, 223, 177, 253, 192, 26 , 2  , 224, 18 , 254, 175, 223, 255, 144, 
	24 , 1  , 111, 237, 14 , 49 , 124, 21 , 0  , 165, 255, 175, 174, 252, 144, 13 , 
	3  , 16 , 29 , 255, 31 , 220, 255, 16 , 20 , 1  , 175, 241, 9  , 65 , 102, 22 , 
	208, 214, 1  , 239, 181, 251, 191, 253, 2  , 224, 38 , 255, 175, 221, 254, 160, 
	14 , 1  , 207, 247, 5  , 1  , 72 , 23 , 241, 3  , 4  , 111, 196, 251, 47 , 237, 
	2  , 112, 44 , 0  , 95 , 225, 254, 80 , 7  , 1  , 191, 254, 1  , 97 , 36 , 24 , 
	81 , 42 , 7  , 47 , 219, 250, 255, 220, 1  , 176, 46 , 1  , 15 , 232, 254, 47 , 
	254, 1  , 128, 5  , 254, 112, 251, 24 , 1  , 74 , 10 , 15 , 251, 251, 63 , 205, 
	0  , 192, 45 , 1  , 175, 242, 254, 31 , 246, 1  , 32 , 12 , 252, 64 , 207, 23 , 
	1  , 98 , 12 , 208, 32 , 251, 239, 193, 255, 176, 40 , 2  , 47 , 253, 254, 63 , 
	237, 0  , 176, 18 , 250, 192, 161, 21 , 97 , 113, 15 , 144, 75 , 253, 15 , 184, 
	254, 128, 30 , 2  , 144, 9  , 254, 127, 230, 0  , 32 , 24 , 249, 224, 115, 19 , 
	65 , 118, 18 , 16 , 122, 254, 175, 181, 253, 96 , 18 , 2  , 192, 21 , 254, 239, 
	225, 255, 144, 27 , 249, 160, 70 , 16 , 161, 113, 20 , 48 , 170, 0  , 175, 184, 
	252, 96 , 3  , 2  , 192, 32 , 255, 127, 222, 255, 0  , 28 , 249, 224, 29 , 13 , 
	193, 98 , 21 , 208, 218, 3  , 15 , 194, 251, 159, 242, 2  , 112, 41 , 0  , 31 , 
	222, 254, 128, 27 , 250, 175, 249, 10 , 177, 74 , 22 , 225, 7  , 5  , 191, 212, 
	251, 15 , 225, 1  , 240, 47 , 0  , 191, 225, 254, 32 , 23 , 251, 191, 219, 7  , 
	145, 42 , 23 , 97 , 46 , 8  , 143, 236, 250, 239, 208, 1  , 48 , 50 , 1  , 111, 
	231, 253, 224, 18 , 252, 255, 196, 4  , 161, 3  , 23 , 33 , 78 , 11 , 80 , 12 , 
	251, 63 , 194, 0  , 80 , 48 , 1  , 255, 239, 253, 192, 10 , 254, 95 , 181, 1  , 
	224, 217, 22 , 81 , 102, 14 , 16 , 49 , 251, 255, 183, 255, 80 , 42 , 2  , 127, 
	249, 253, 224, 1  , 255, 191, 173, 255, 128, 171, 20 , 225, 115, 16 , 144, 89 , 
	253, 47 , 177, 254, 64 , 33 , 2  , 192, 5  , 254, 47 , 248, 0  , 255, 173, 253, 
	144, 126, 18 , 225, 118, 18 , 176, 132, 254, 207, 177, 253, 48 , 20 , 2  , 208, 
	17 , 254, 159, 239, 1  , 255, 178, 252, 32 , 82 , 16 , 145, 111, 20 , 112, 176, 
	0  , 223, 183, 252, 80 , 4  , 2  , 176, 28 , 255, 47 , 230, 2  , 207, 188, 251, 
	48 , 42 , 13 , 225, 94 , 21 , 160, 217, 3  , 47 , 196, 251, 175, 243, 2  , 96 , 
	37 , 255, 207, 224, 3  , 79 , 202, 250, 192, 7  , 11 , 33 , 69 , 22 , 65 , 0  , 
	5  , 191, 216, 251, 79 , 225, 1  , 224, 44 , 0  , 127, 220, 3  , 127, 219, 250, 
	207, 234, 8  , 81 , 36 , 22 , 97 , 33 , 8  , 95 , 241, 251, 63 , 209, 1  , 32 , 
	48 , 1  , 47 , 218, 3  , 111, 236, 251, 47 , 211, 5  , 144, 254, 21 , 225, 60 , 
	10 , 240, 16 , 251, 143, 195, 0  , 64 , 49 , 1  , 223, 220, 3  , 47 , 253, 251, 
	223, 195, 3  , 0  , 213, 20 , 241, 80 , 13 , 128, 51 , 252, 63 , 184, 255, 80 , 
	45 , 2  , 95 , 224, 2  , 160, 13 , 252, 191, 185, 0  , 192, 170, 19 , 129, 92 , 
	15 , 208, 90 , 253, 95 , 178, 254, 96 , 38 , 2  , 191, 231, 1  , 240, 26 , 253, 
	207, 182, 254, 208, 127, 17 , 177, 95 , 17 , 224, 130, 254, 223, 177, 253, 112, 
	28 , 2  , 255, 240, 1  , 48 , 36 , 254, 223, 184, 253, 80 , 85 , 15 , 145, 90 , 
	19 , 144, 171, 0  , 191, 183, 252, 160, 14 , 2  , 255, 251, 0  , 112, 43 , 255, 
	239, 191, 252, 32 , 46 , 13 , 49 , 78 , 20 , 224, 211, 2  , 239, 194, 251, 255, 
	254, 2  , 176, 7  , 255, 176, 47 , 0  , 239, 202, 251, 112, 11 , 10 , 177, 57 , 
	21 , 160, 249, 5  , 95 , 213, 251, 143, 237, 2  , 64 , 19 , 51 , 193, 48 , 252, 
	127, 150, 0  , 96 , 66 , 1  , 31 , 215, 254, 64 , 21 , 1  , 255, 249, 254, 79 , 
	254, 1  , 159, 250, 41 , 241, 124, 3  , 95 , 167, 253, 80 , 37 , 2  , 143, 244, 
	253, 255, 252, 1  , 144, 12 , 255, 15 , 242, 0  , 176, 7  , 32 , 225, 177, 9  , 
	175, 199, 251, 32 , 7  , 3  , 48 , 15 , 254, 31 , 233, 0  , 240, 25 , 255, 223, 
	235, 255, 208, 16 , 24 , 161, 208, 15 , 95 , 244, 249, 255, 232, 3  , 64 , 36 , 
	254, 159, 219, 0  , 64 , 31 , 0  , 159, 232, 255, 32 , 21 , 17 , 33 , 219, 20 , 
	80 , 44 , 249, 191, 203, 2  , 176, 52 , 255, 95 , 212, 255, 112, 32 , 1  , 63 , 
	234, 254, 144, 23 , 10 , 129, 209, 24 , 96 , 108, 250, 143, 179, 1  , 160, 60 , 
	0  , 79 , 212, 254, 192, 28 , 1  , 191, 240, 254, 64 , 20 , 4  , 225, 181, 27 , 
	112, 177, 252, 95 , 163, 0  , 64 , 61 , 1  , 79 , 218, 254, 32 , 20 , 2  , 15 , 
	248, 254, 32 , 15 , 0  , 65 , 136, 29 , 80 , 248, 255, 47 , 157, 254, 160, 54 , 
	2  , 63 , 229, 253, 192, 8  , 2  , 0  , 1  , 254, 64 , 7  , 252, 177, 77 , 29 , 
	241, 59 , 2  , 207, 163, 252, 240, 39 , 2  , 239, 245, 253, 175, 251, 1  , 208, 
	11 , 254, 175, 254, 250, 97 , 8  , 29 , 65 , 118, 7  , 15 , 184, 251, 112, 17 , 
	3  , 80 , 8  , 253, 207, 238, 1  , 96 , 20 , 255, 47 , 245, 249, 32 , 190, 27 , 
	81 , 164, 11 , 175, 218, 250, 127, 246, 3  , 64 , 26 , 254, 79 , 226, 0  , 176, 
	27 , 255, 223, 238, 248, 240, 116, 24 , 65 , 194, 16 , 64 , 9  , 250, 15 , 218, 
	2  , 208, 43 , 255, 15 , 217, 255, 224, 30 , 0  , 159, 232, 249, 160, 47 , 20 , 
	97 , 205, 20 , 128, 67 , 250, 111, 192, 1  , 240, 55 , 255, 255, 214, 255, 16 , 
	30 , 1  , 79 , 229, 251, 15 , 243, 15 , 241, 196, 24 , 32 , 132, 251, 159, 170, 
	0  , 176, 61 , 0  , 255, 216, 254, 80 , 25 , 1  , 223, 230, 252, 207, 197, 11 , 
	81 , 168, 26 , 192, 200, 253, 175, 157, 255, 48 , 59 , 1  , 255, 223, 253, 192, 
	17 , 2  , 63 , 234, 254, 175, 166, 6  , 209, 124, 28 , 81 , 9  , 0  , 143, 155, 
	253, 160, 50 , 2  , 207, 234, 253, 112, 7  , 2  , 95 , 241, 0  , 111, 150, 2  , 
	209, 68 , 28 , 161, 68 , 4  , 15 , 166, 252, 48 , 34 , 3  , 79 , 249, 253, 111, 
	251, 2  , 47 , 250, 1  , 239, 148, 255, 113, 4  , 27 , 209, 116, 7  , 223, 189, 
	251, 16 , 12 , 3  , 112, 10 , 253, 191, 239, 1  , 176, 4  , 3  , 15 , 158, 252, 
	224, 193, 25 , 241, 152, 11 , 239, 224, 250, 111, 243, 3  , 64 , 26 , 254, 63 , 
	229, 1  , 16 , 14 , 3  , 175, 177, 251, 32 , 127, 23 , 49 , 173, 15 , 208, 15 , 
	250, 95 , 217, 2  , 160, 41 , 255, 15 , 221, 0  , 80 , 22 , 3  , 223, 202, 250, 
	48 , 65 , 19 , 193, 178, 19 , 128, 70 , 250, 239, 193, 1  , 176, 51 , 255, 255, 
	218, 255, 112, 28 , 3  , 143, 229, 250, 16 , 11 , 15 , 225, 168, 22 , 176, 131, 
	252, 63 , 174, 0  , 96 , 56 , 0  , 255, 218, 254, 160, 32 , 2  , 240, 0  , 250, 
	159, 222, 11 , 209, 144, 25 , 32 , 195, 254, 79 , 162, 254, 240, 55 , 1  , 255, 
	223, 253, 240, 31 , 2  , 16 , 25 , 251, 159, 189, 7  , 193, 106, 26 , 193, 2  , 
	1  , 15 , 160, 253, 112, 47 , 2  , 207, 232, 253, 112, 27 , 1  , 0  , 44 , 252, 
	255, 168, 3  , 225, 57 , 27 , 97 , 62 , 4  , 95 , 169, 252, 16 , 33 , 3  , 95 , 
	245, 253, 48 , 20 , 255, 240, 58 , 254, 127, 159, 0  , 129, 1  , 27 , 17 , 113, 
	8  , 31 , 190, 250, 240, 13 , 3  , 144, 4  , 253, 64 , 10 , 254, 240, 64 , 0  , 
	15 , 162, 253, 176, 195, 25 , 177, 153, 12 , 47 , 224, 250, 79 , 245, 3  , 112, 
	20 , 253, 175, 253, 254, 32 , 62 , 1  , 111, 173, 251, 160, 132, 23 , 97 , 178, 
	16 , 32 , 14 , 250, 47 , 220, 2  , 224, 35 , 254, 95 , 241, 253, 144, 54 , 2  , 
	143, 192, 250, 96 , 71 , 20 , 65 , 188, 19 , 240, 70 , 250, 207, 195, 1  , 240, 
	47 , 255, 79 , 229, 253, 80 , 41 , 3  , 79 , 216, 249, 224, 17 , 16 , 145, 180, 
	23 , 48 , 133, 252, 47 , 175, 0  , 160, 55 , 0  , 111, 220, 253, 96 , 24 , 3  , 
	159, 241, 250, 31 , 228, 12 , 129, 155, 25 , 176, 200, 254, 79 , 161, 255, 16 , 
	57 , 1  , 143, 214, 253, 192, 6  , 3  , 112, 10 , 250, 255, 194, 8  , 81 , 115, 
	27 , 65 , 9  , 1  , 31 , 158, 253, 128, 52 , 2  , 159, 213, 55 , 1  , 0  , 249, 
	79 , 196, 3  , 240, 30 , 253, 79 , 236, 2  , 32 , 14 , 254, 79 , 246, 1  , 144, 
	5  , 254, 128, 11 , 43 , 161, 134, 0  , 15 , 157, 0  , 160, 55 , 255, 111, 218, 
	0  , 128, 29 , 255, 143, 234, 0  , 144, 17 , 255, 63 , 253, 33 , 1  , 230, 7  , 
	15 , 148, 253, 144, 62 , 1  , 111, 213, 255, 16 , 33 , 0  , 191, 229, 255, 144, 
	22 , 0  , 15 , 242, 23 , 50 , 33 , 13 , 255, 167, 250, 240, 52 , 3  , 15 , 219, 
	253, 224, 29 , 1  , 175, 232, 254, 192, 22 , 0  , 207, 236, 14 , 114, 55 , 20 , 
	127, 212, 249, 32 , 30 , 4  , 47 , 234, 253, 16 , 18 , 2  , 79 , 240, 254, 48 , 
	16 , 1  , 111, 234, 6  , 242, 42 , 26 , 16 , 26 , 248, 127, 253, 4  , 143, 255, 
	252, 208, 2  , 2  , 143, 252, 253, 240, 7  , 1  , 207, 236, 0  , 225, 251, 30 , 
	128, 114, 249, 15 , 216, 4  , 16 , 22 , 253, 47 , 241, 2  , 64 , 10 , 254, 31 , 
	252, 1  , 223, 242, 252, 113, 177, 33 , 64 , 213, 251, 31 , 182, 2  , 224, 44 , 
	253, 255, 226, 1  , 160, 22 , 254, 143, 242, 1  , 159, 251, 249, 177, 82 , 34 , 
	49 , 58 , 254, 159, 155, 1  , 0  , 59 , 255, 79 , 215, 0  , 176, 31 , 255, 79 , 
	233, 1  , 16 , 4  , 248, 144, 232, 33 , 33 , 151, 3  , 111, 144, 254, 176, 65 , 
	0  , 207, 211, 255, 144, 35 , 0  , 63 , 229, 0  , 80 , 14 , 248, 224, 127, 30 , 
	49 , 226, 9  , 31 , 153, 252, 80 , 58 , 2  , 79 , 215, 254, 96 , 32 , 1  , 47 , 
	229, 255, 112, 21 , 250, 80 , 31 , 25 , 178, 19 , 15 , 47 , 185, 250, 64 , 40 , 
	3  , 159, 227, 253, 112, 23 , 1  , 239, 234, 254, 176, 24 , 252, 111, 210, 20 , 
	50 , 36 , 21 , 31 , 239, 248, 224, 12 , 4  , 95 , 246, 252, 240, 10 , 2  , 127, 
	244, 254, 16 , 24 , 254, 207, 156, 14 , 34 , 21 , 26 , 48 , 56 , 248, 175, 234, 
	4  , 96 , 12 , 252, 239, 249, 2  , 128, 0  , 253, 208, 19 , 0  , 255, 128, 8  , 
	49 , 232, 30 , 32 , 143, 249, 159, 199, 3  , 176, 34 , 253, 95 , 233, 2  , 64 , 
	13 , 253, 224, 11 , 2  , 175, 125, 2  , 225, 162, 32 , 112, 235, 251, 239, 169, 
	2  , 96 , 52 , 254, 79 , 220, 1  , 144, 24 , 254, 64 , 1  , 3  , 191, 141, 254, 
	145, 76 , 33 , 1  , 68 , 255, 127, 150, 0  , 112, 63 , 255, 159, 212, 0  , 160, 
	31 , 255, 15 , 247, 4  , 31 , 172, 251, 128, 237, 31 , 193, 147, 4  , 15 , 146, 
	254, 64 , 64 , 1  , 15 , 211, 255, 128, 34 , 255, 239, 237, 3  , 223, 211, 249, 
	176, 143, 29 , 1  , 208, 9  , 95 , 160, 252, 32 , 54 , 2  , 111, 218, 254, 112, 
	31 , 0  , 223, 231, 2  , 255, 251, 249, 48 , 56 , 24 , 241, 247, 14 , 239, 195, 
	250, 80 , 34 , 3  , 143, 231, 253, 144, 23 , 1  , 191, 228, 1  , 192, 30 , 249, 
	207, 240, 19 , 242, 4  , 20 , 79 , 249, 249, 48 , 6  , 4  , 47 , 249, 253, 0  , 
	11 , 2  , 95 , 230, 0  , 112, 57 , 251, 47 , 186, 14 , 113, 247, 25 , 16 , 63 , 
	249, 15 , 230, 4  , 48 , 14 , 252, 255, 252, 2  , 175, 236, 255, 32 , 73 , 253, 
	15 , 152, 8  , 241, 208, 28 , 224, 146, 249, 255, 197, 3  , 128, 35 , 253, 95 , 
	237, 2  , 143, 245, 254, 32 , 76 , 255, 31 , 139, 3  , 209, 148, 31 , 80 , 234, 
	252, 63 , 168, 2  , 64 , 52 , 254, 63 , 224, 2  , 0  , 1  , 253, 112, 68 , 1  , 
	15 , 145, 255, 113, 71 , 32 , 49 , 66 , 255, 191, 150, 0  , 96 , 62 , 255, 111, 
	215, 1  , 32 , 13 , 253, 48 , 50 , 2  , 159, 166, 252, 32 , 239, 31 , 113, 145, 
	4  , 63 , 147, 254, 64 , 63 , 0  , 223, 212, 0  , 0  , 24 , 253, 96 , 27 , 3  , 
	159, 197, 250, 0  , 150, 29 , 1  , 208, 9  , 143, 161, 252, 16 , 54 , 2  , 79 , 
	216, 254, 208, 32 , 254, 0  , 1  , 4  , 15 , 233, 249, 32 , 65 , 25 , 65 , 250, 
	15 , 47 , 196, 250, 48 , 35 , 3  , 143, 227, 253, 192, 35 , 254, 223, 233, 3  , 
	192, 12 , 249, 95 , 249, 20 , 98 , 10 , 20 , 191, 251, 249, 0  , 7  , 4  , 79 , 
	243, 252, 240, 32 , 255, 223, 214, 2  , 240, 41 , 250, 143, 193, 14 , 241, 254, 
	25 , 144, 66 , 248, 223, 230, 4  , 96 , 8  , 252, 144, 25 , 0  , 207, 203, 1  , 
	208, 61 , 252, 95 , 156, 9  , 97 , 215, 29 , 112, 150, 249, 207, 197, 3  , 208, 
	29 , 252, 176, 12 , 1  , 159, 201, 0  , 128, 70 , 254, 111, 141, 4  , 33 , 153, 
	31 , 224, 239, 252, 31 , 168, 2  , 144, 47 , 253, 111, 253, 58 , 48 , 191, 247, 
	192, 19 , 3  , 111, 213, 255, 64 , 37 , 255, 79 , 235, 1  , 96 , 4  , 254, 192, 
	11 , 0  , 143, 244, 44 , 177, 145, 251, 143, 187, 4  , 96 , 2  , 253, 16 , 24 , 
	1  , 95 , 226, 0  , 16 , 24 , 255, 15 , 246, 1  , 111, 244, 32 , 50 , 42 , 1  , 
	127, 128, 3  , 144, 42 , 252, 64 , 3  , 2  , 175, 229, 254, 224, 33 , 255, 175, 
	232, 1  , 175, 248, 20 , 194, 137, 8  , 255, 104, 1  , 96 , 71 , 252, 191, 236, 
	3  , 47 , 242, 254, 16 , 30 , 0  , 111, 226, 1  , 95 , 255, 10 , 194, 172, 17 , 
	127, 121, 254, 96 , 84 , 254, 47 , 216, 2  , 192, 4  , 253, 176, 19 , 1  , 31 , 
	228, 0  , 160, 7  , 2  , 146, 146, 25 , 239, 182, 251, 48 , 76 , 0  , 63 , 205, 
	1  , 160, 23 , 253, 240, 2  , 1  , 159, 237, 255, 192, 13 , 252, 162, 65 , 33 , 
	96 , 28 , 248, 176, 47 , 2  , 143, 205, 0  , 16 , 37 , 254, 191, 240, 1  , 191, 
	252, 254, 224, 16 , 249, 33 , 195, 38 , 176, 162, 247, 176, 1  , 4  , 95 , 219, 
	254, 80 , 42 , 255, 223, 225, 1  , 96 , 12 , 254, 80 , 15 , 248, 1  , 43 , 40 , 
	241, 55 , 248, 255, 202, 5  , 63 , 245, 252, 224, 36 , 1  , 47 , 217, 0  , 160, 
	25 , 254, 32 , 10 , 249, 0  , 144, 39 , 161, 197, 252, 207, 152, 4  , 192, 22 , 
	252, 32 , 19 , 2  , 63 , 220, 255, 176, 33 , 254, 112, 2  , 251, 112, 8  , 35 , 
	2  , 56 , 2  , 239, 119, 2  , 240, 53 , 252, 95 , 252, 2  , 223, 232, 254, 208, 
	33 , 255, 63 , 249, 254, 111, 166, 27 , 226, 124, 10 , 191, 115, 0  , 16 , 74 , 
	253, 143, 228, 2  , 207, 250, 254, 32 , 25 , 0  , 63 , 241, 1  , 47 , 112, 19 , 
	82 , 139, 19 , 15 , 148, 252, 208, 79 , 255, 111, 210, 2  , 16 , 15 , 253, 224, 
	10 , 1  , 47 , 237, 3  , 47 , 102, 10 , 178, 101, 26 , 207, 216, 249, 208, 65 , 
	1  , 143, 201, 0  , 208, 33 , 254, 47 , 249, 1  , 223, 237, 4  , 47 , 126, 3  , 
	18 , 20 , 33 , 16 , 58 , 247, 240, 34 , 3  , 127, 205, 255, 96 , 44 , 254, 223, 
	233, 2  , 47 , 241, 4  , 31 , 173, 253, 33 , 164, 37 , 16 , 176, 247, 207, 247, 
	4  , 191, 222, 253, 240, 44 , 255, 223, 223, 1  , 239, 249, 3  , 47 , 229, 249, 
	65 , 36 , 38 , 113, 46 , 249, 159, 200, 5  , 15 , 248, 252, 240, 35 , 0  , 255, 
	219, 1  , 64 , 3  , 1  , 176, 26 , 247, 160, 164, 37 , 17 , 167, 253, 143, 157, 
	4  , 32 , 23 , 252, 144, 16 , 1  , 239, 224, 0  , 64 , 13 , 0  , 0  , 66 , 247, 
	240, 48 , 33 , 18 , 12 , 3  , 143, 130, 2  , 48 , 52 , 252, 239, 249, 2  , 127, 
	236, 255, 48 , 20 , 254, 128, 87 , 249, 239, 211, 26 , 242, 82 , 11 , 15 , 127, 
	255, 96 , 72 , 254, 15 , 225, 2  , 159, 254, 254, 48 , 23 , 253, 112, 88 , 252, 
	191, 149, 19 , 82 , 110, 19 , 79 , 157, 252, 64 , 78 , 255, 207, 206, 2  , 0  , 
	17 , 253, 144, 21 , 253, 16 , 70 , 255, 239, 122, 11 , 66 , 91 , 27 , 79 , 222, 
	249, 96 , 66 , 1  , 207, 197, 1  , 0  , 35 , 253, 128, 14 , 253, 80 , 38 , 2  , 
	175, 128, 3  , 162, 27 , 33 , 224, 63 , 247, 160, 36 , 3  , 159, 201, 255, 160, 
	45 , 254, 0  , 3  , 254, 32 , 1  , 4  , 143, 158, 253, 113, 182, 38 , 64 , 184, 
	247, 143, 247, 4  , 207, 219, 254, 48 , 46 , 255, 15 , 246, 255, 95 , 224, 5  , 
	63 , 204, 249, 65 , 57 , 39 , 177, 57 , 249, 159, 197, 5  , 15 , 248, 253, 16 , 
	36 , 0  , 95 , 235, 0  , 143, 201, 4  , 191, 254, 247, 96 , 182, 37 , 241, 178, 
	253, 239, 153, 4  , 16 , 25 , 252, 144, 17 , 1  , 175, 229, 1  , 143, 192, 3  , 
	80 , 40 , 247, 176, 63 , 33 , 98 , 20 , 4  , 15 , 126, 2  , 0  , 55 , 252, 223, 
	249, 2  , 175, 228, 2  , 31 , 197, 1  , 96 , 67 , 249, 159, 223, 26 , 194, 81 , 
	11 , 111, 125, 255, 64 , 76 , 253, 223, 225, 3  , 31 , 233, 2  , 63 , 215, 255, 
	96 , 77 , 252, 127, 158, 19 , 2  , 100, 19 , 63 , 156, 252, 64 , 81 , 255, 111, 
	207, 2  , 239, 244, 1  , 223, 240, 253, 176, 69 , 255, 159, 128, 11 , 2  , 74 , 
	26 , 143, 221, 249, 176, 68 , 1  , 79 , 199, 2  , 0  , 3  , 1  , 16 , 10 , 252, 
	176, 49 , 2  , 95 , 129, 3  , 178, 9  , 32 , 144, 59 , 248, 16 , 37 , 3  , 31 , 
	203, 0  , 160, 17 , 0  , 48 , 32 , 252, 112, 20 , 4  , 79 , 155, 253, 209, 168, 
	36 , 160, 176, 248, 15 , 249, 4  , 95 , 219, 255, 0  , 29 , 60 , 112, 121, 248, 
	240, 73 , 254, 207, 233, 2  , 111, 231, 0  , 0  , 20 , 254, 144, 10 , 0  , 111, 
	239, 1  , 15 , 248, 45 , 145, 152, 246, 128, 21 , 3  , 79 , 191, 2  , 64 , 7  , 
	253, 224, 34 , 255, 95 , 242, 1  , 175, 234, 0  , 144, 2  , 31 , 114, 113, 249, 
	47 , 209, 6  , 15 , 184, 0  , 224, 35 , 252, 240, 29 , 0  , 95 , 227, 1  , 255, 
	241, 255, 208, 11 , 18 , 82 , 252, 0  , 143, 144, 6  , 191, 207, 255, 0  , 51 , 
	253, 48 , 11 , 1  , 111, 222, 1  , 127, 255, 255, 32 , 15 , 7  , 3  , 44 , 11 , 
	175, 104, 5  , 15 , 253, 253, 48 , 51 , 254, 143, 244, 2  , 15 , 229, 0  , 96 , 
	14 , 254, 176, 15 , 254, 82 , 251, 24 , 239, 112, 1  , 32 , 49 , 252, 48 , 33 , 
	0  , 127, 224, 1  , 255, 246, 255, 48 , 25 , 254, 176, 9  , 249, 2  , 110, 37 , 
	175, 185, 252, 16 , 90 , 252, 144, 0  , 2  , 111, 214, 1  , 48 , 11 , 254, 48 , 
	27 , 255, 48 , 0  , 247, 113, 164, 46 , 240, 66 , 247, 96 , 100, 254, 127, 219, 
	3  , 143, 220, 255, 224, 30 , 253, 224, 19 , 0  , 15 , 246, 248, 240, 202, 50 , 
	112, 249, 244, 240, 72 , 1  , 63 , 192, 3  , 127, 241, 254, 128, 39 , 254, 80 , 
	3  , 0  , 255, 239, 252, 80 , 14 , 47 , 97 , 184, 246, 48 , 12 , 3  , 255, 185, 
	2  , 32 , 13 , 253, 128, 35 , 255, 111, 241, 1  , 159, 238, 0  , 15 , 144, 38 , 
	226, 90 , 251, 159, 193, 5  , 159, 202, 0  , 0  , 38 , 253, 96 , 19 , 0  , 191, 
	227, 1  , 191, 243, 2  , 239, 91 , 27 , 50 , 193, 4  , 95 , 128, 5  , 143, 238, 
	253, 208, 50 , 254, 47 , 252, 1  , 207, 224, 1  , 79 , 252, 4  , 95 , 101, 14 , 
	178, 222, 15 , 47 , 97 , 3  , 112, 27 , 252, 48 , 47 , 255, 143, 231, 2  , 79 , 
	231, 0  , 96 , 6  , 4  , 63 , 153, 3  , 130, 177, 26 , 127, 116, 255, 224, 68 , 
	251, 208, 27 , 1  , 47 , 217, 2  , 15 , 246, 255, 96 , 15 , 2  , 239, 224, 251, 
	34 , 68 , 36 , 143, 193, 251, 176, 91 , 252, 207, 253, 2  , 143, 215, 1  , 32 , 
	10 , 254, 144, 19 , 0  , 224, 36 , 246, 97 , 168, 43 , 160, 70 , 247, 240, 88 , 
	254, 239, 220, 3  , 63 , 226, 255, 192, 27 , 254, 32 , 17 , 254, 208, 83 , 245, 
	96 , 246, 46 , 128, 244, 246, 32 , 54 , 1  , 191, 196, 2  , 239, 248, 254, 96 , 
	38 , 254, 64 , 10 , 253, 96 , 99 , 247, 160, 75 , 44 , 113, 178, 247, 111, 250, 
	4  , 111, 189, 1  , 160, 19 , 253, 112, 36 , 255, 15 , 255, 252, 208, 83 , 251, 
	239, 194, 37 , 162, 93 , 252, 111, 178, 6  , 15 , 204, 255, 160, 42 , 253, 64 , 
	22 , 0  , 47 , 243, 253, 80 , 44 , 0  , 191, 112, 27 , 82 , 209, 4  , 255, 118, 
	5  , 207, 240, 253, 144, 53 , 254, 0  , 0  , 1  , 95 , 235, 254, 175, 252, 4  , 
	127, 91 , 15 , 146, 245, 15 , 223, 92 , 3  , 112, 29 , 252, 32 , 47 , 255, 127, 
	232, 2  , 47 , 234, 0  , 47 , 212, 6  , 95 , 121, 4  , 178, 198, 27 , 31 , 119, 
	255, 160, 70 , 251, 208, 26 , 1  , 63 , 215, 2  , 79 , 239, 1  , 143, 190, 6  , 
	15 , 183, 252, 98 , 78 , 36 , 191, 202, 251, 64 , 93 , 252, 239, 250, 2  , 159, 
	211, 1  , 191, 250, 2  , 79 , 190, 4  , 15 , 253, 247, 145, 169, 43 , 16 , 80 , 
	247, 176, 87 , 255, 15 , 219, 3  , 79 , 220, 0  , 160, 7  , 2  , 79 , 210, 1  , 
	32 , 55 , 246, 80 , 244, 45 , 64 , 246, 246, 32 , 52 , 1  , 207, 197, 2  , 255, 
	242, 255, 64 , 19 , 1  , 159, 241, 254, 80 , 89 , 247, 240, 75 , 42 , 241, 167, 
	247, 175, 249, 4  , 79 , 191, 1  , 160, 14 , 254, 16 , 25 , 0  , 128, 18 , 252, 
	64 , 92 , 251, 143, 199, 36 , 130, 70 , 252, 175, 181, 5  , 191, 206, 255, 176, 
	39 , 253, 96 , 23 , 255, 96 , 43 , 251, 112, 69 , 255, 207, 118, 26 , 242, 185, 
	5  , 15 , 121, 5  , 143, 240, 253, 160, 55 , 253, 128, 14 , 254, 112, 54 , 252, 
	32 , 28 , 3  , 111, 94 , 15 , 226, 231, 15 , 239, 94 , 3  , 112, 28 , 252, 32 , 
	54 , 254, 112, 0  , 254, 16 , 47 , 253, 239, 238, 5  , 159, 120, 5  , 34 , 198, 
	27 , 127, 117, 255, 176, 69 , 251, 176, 35 , 0  , 15 , 240, 254, 80 , 27 , 0  , 
	47 , 203, 5  , 223, 180, 252, 130, 90 , 37 , 175, 200, 251, 64 , 93 , 252, 176, 
	2  , 1  , 191, 229, 255, 0  , 0  , 2  , 63 , 187, 4  , 95 , 251, 247, 81 , 183, 
	44 , 96 , 82 , 247, 128, 89 , 254, 239, 222, 2  , 255, 225, 62 , 144, 52 , 252, 
	128, 55 , 252, 224, 41 , 254, 48 , 17 , 255, 191, 251, 0  , 207, 240, 1  , 15 , 
	242, 0  , 175, 250, 47 , 49 , 137, 242, 240, 138, 250, 144, 45 , 255, 111, 240, 
	2  , 31 , 214, 2  , 175, 220, 1  , 175, 240, 0  , 96 , 1  , 31 , 114, 165, 240, 
	160, 132, 252, 0  , 16 , 1  , 63 , 215, 3  , 79 , 204, 2  , 207, 224, 1  , 47 , 
	250, 255, 208, 8  , 16 , 51 , 103, 246, 112, 52 , 255, 239, 228, 2  , 207, 206, 
	2  , 239, 219, 1  , 143, 245, 0  , 0  , 8  , 255, 64 , 12 , 3  , 35 , 169, 4  , 
	111, 183, 4  , 111, 194, 3  , 47 , 222, 1  , 47 , 252, 255, 128, 16 , 254, 208, 
	18 , 255, 16 , 10 , 250, 19 , 83 , 24 , 15 , 71 , 7  , 31 , 191, 1  , 192, 1  , 
	254, 176, 33 , 253, 176, 34 , 254, 64 , 19 , 255, 96 , 3  , 246, 130, 116, 43 , 
	223, 40 , 5  , 223, 229, 255, 0  , 41 , 252, 176, 54 , 253, 16 , 35 , 254, 176, 
	8  , 0  , 31 , 249, 248, 17 , 82 , 57 , 95 , 137, 0  , 176, 36 , 252, 80 , 65 , 
	252, 48 , 48 , 254, 0  , 16 , 255, 255, 248, 0  , 223, 242, 252, 128, 74 , 60 , 
	80 , 96 , 249, 240, 90 , 251, 48 , 59 , 253, 144, 19 , 255, 255, 244, 1  , 63 , 
	234, 1  , 63 , 242, 1  , 47 , 155, 53 , 1  , 115, 245, 0  , 105, 252, 80 , 25 , 
	0  , 47 , 236, 1  , 239, 223, 1  , 255, 232, 1  , 15 , 248, 4  , 47 , 88 , 38 , 
	162, 121, 244, 208, 68 , 255, 95 , 233, 2  , 175, 208, 2  , 239, 218, 1  , 191, 
	241, 0  , 80 , 2  , 4  , 191, 109, 21 , 147, 53 , 250, 223, 244, 3  , 31 , 192, 
	4  , 15 , 201, 2  , 159, 231, 0  , 160, 1  , 255, 128, 11 , 3  , 79 , 183, 5  , 
	179, 125, 6  , 223, 150, 6  , 15 , 177, 3  , 191, 220, 1  , 0  , 1  , 255, 48 , 
	18 , 254, 208, 15 , 0  , 176, 14 , 250, 19 , 63 , 23 , 31 , 80 , 6  , 159, 196, 
	1  , 144, 1  , 254, 208, 28 , 254, 16 , 28 , 254, 176, 13 , 254, 48 , 79 , 244, 
	114, 134, 39 , 239, 81 , 3  , 255, 249, 254, 112, 42 , 253, 16 , 44 , 253, 192, 
	25 , 255, 32 , 5  , 252, 192, 99 , 245, 1  , 127, 52 , 223, 183, 254, 144, 58 , 
	251, 176, 67 , 252, 128, 40 , 254, 128, 10 , 0  , 31 , 249, 252, 224, 74 , 249, 
	240, 115, 57 , 192, 128, 248, 96 , 107, 250, 160, 62 , 253, 176, 16 , 0  , 31 , 
	244, 1  , 15 , 240, 254, 96 , 21 , 0  , 79 , 167, 53 , 17 , 131, 244, 96 , 112, 
	252, 16 , 27 , 0  , 15 , 238, 1  , 191, 227, 1  , 159, 238, 0  , 95 , 225, 5  , 
	31 , 68 , 40 , 130, 124, 245, 48 , 63 , 255, 159, 232, 2  , 143, 211, 2  , 175, 
	222, 1  , 127, 244, 1  , 239, 194, 6  , 223, 73 , 23 , 243, 44 , 252, 15 , 230, 
	3  , 175, 189, 4  , 15 , 204, 2  , 111, 233, 0  , 160, 0  , 2  , 127, 193, 5  , 
	111, 149, 7  , 179, 105, 8  , 47 , 135, 6  , 143, 173, 3  , 191, 220, 1  , 15 , 
	255, 255, 128, 11 , 1  , 255, 219, 2  , 15 , 249, 251, 67 , 41 , 23 , 159, 74 , 
	6  , 223, 194, 1  , 191, 255, 255, 16 , 22 , 254, 144, 19 , 0  , 176, 1  , 254, 
	80 , 77 , 244, 162, 123, 39 , 47 , 85 , 3  , 239, 248, 254, 160, 37 , 253, 112, 
	37 , 254, 48 , 18 , 255, 48 , 35 , 251, 192,
	115, 244, 49 , 135, 51 , 31 , 193, 254, 80 , 58 , 251, 208, 63 , 252, 208, 37 , 
	254, 160, 9  , 254, 48 , 52 , 251, 64 , 100, 248, 128, 135, 56 , 16 , 138, 248, 
	16 , 108, 250, 160, 61 , 253, 160, 18 , 255, 207, 251, 254, 0  , 44 , 252, 224, 
	45 , 254, 255, 185, 52 , 81 , 140, 244, 0  , 115, 251, 224, 30 , 255, 191, 245, 
	1  , 47 , 238, 254, 192, 18 , 255, 175, 234, 4  , 175, 73 , 40 , 194, 136, 244, 
	224, 66 , 255, 95 , 237, 2  , 47 , 219, 2  , 15 , 233, 255, 255, 243, 2  , 79 , 
	187, 7  , 95 , 64 , 24 , 163, 56 , 252, 15 , 230, 3  , 143, 192, 3  , 207, 208, 
	2  , 31 , 238, 1  , 31 , 221, 3  , 159, 175, 6  , 143, 133, 8  , 131, 111, 8  , 
	143, 132, 6  , 175, 172, 3  , 207, 218, 1  , 63 , 251, 1  , 175, 216, 3  , 79 , 
	199, 3  , 63 , 234, 251, 243, 37 , 24 , 15 , 70 , 7  , 31 , 190, 2  , 15 , 247, 
	255, 176, 11 , 1  , 127, 228, 1  , 175, 243, 255, 16 , 66 , 245, 50 , 113, 39 , 
	31 , 83 , 4  , 47 , 241, 255, 48 , 26 , 254, 64 , 23 , 0  , 191, 251, 255, 112, 
	32 , 251, 224, 113, 244, 97 , 128, 50 , 95 , 191, 254, 160, 51 , 252, 112, 52 , 
	253, 128, 26 , 63 , 208, 3  , 255, 208, 3  , 255, 208, 3  , 255, 208, 3  , 255, 
	208, 3  , 255, 208, 3  , 255, 208, 3  , 255, 208, 3  , 50 , 49 , 35 , 247, 160, 
	91 , 251, 144, 59 , 252, 208, 45 , 253, 112, 37 , 253, 224, 32 , 254, 48 , 27 , 
	254, 96 , 24 , 34 , 114, 79 , 242, 224, 133, 249, 192, 81 , 251, 176, 60 , 252, 
	176, 48 , 253, 64 , 40 , 253, 176, 34 , 254, 0  , 30 , 17 , 3  , 94 , 244, 176, 
	105, 251, 64 , 60 , 252, 224, 43 , 253, 160, 34 , 254, 32 , 27 , 254, 112, 23 , 
	254, 176, 20 , 0  , 51 , 253, 0  , 63 , 253, 0  , 63 , 253, 0  , 63 , 253, 0  , 
	63 , 253, 0  , 63 , 253, 0  , 63 , 253, 0  , 63 , 253, 244, 179, 201, 21 , 127, 
	101, 6  , 143, 177, 4  , 31 , 201, 3  , 15 , 213, 2  , 127, 221, 2  , 15 , 226, 
	1  , 191, 231, 242, 98 , 180, 45 , 127, 3  , 9  , 239, 140, 5  , 223, 178, 4  , 
	63 , 197, 3  , 95 , 208, 2  , 191, 217, 2  , 79 , 223, 247, 241, 59 , 61 , 111, 
	53 , 7  , 79 , 174, 4  , 15 , 203, 2  , 223, 217, 2  , 47 , 225, 1  , 191, 231,
	1  , 111, 236, 255, 208, 3  , 63 , 208, 3  , 255, 208, 3  , 255, 208, 3  , 255, 208, 
	3  , 255, 208, 3  , 255, 208, 3  , 255, 208, 3  , 5  , 111, 91 , 54 , 129, 49 , 
	247, 128, 90 , 251, 192, 55 , 253, 16 , 40 , 253, 192, 32 , 254, 48 , 26 , 254, 
	128, 22 , 6  , 239, 63 , 37 , 194, 115, 242, 128, 133, 249, 240, 77 , 252, 0  , 
	55 , 253, 0  , 42 , 253, 160, 34 , 254, 16 , 28 , 4  , 175, 136, 18 , 35 , 125, 
	244, 144, 103, 251, 128, 56 , 253, 32 , 38 , 253, 240, 29 , 254, 112, 23 , 254, 
	192, 18 , 0  , 63 , 253, 0  , 51 , 253, 0  , 63 , 253, 0  , 63 , 253, 0  , 63 , 
	253, 0  , 63 , 253, 0  , 63 , 253, 0  , 63 , 253, 252, 16 , 96 , 244, 179, 178, 
	20 , 127, 111, 5  , 255, 185, 3  , 159, 208, 2  , 159, 220, 2  , 15 , 227, 1  , 
	175, 232, 250, 160, 126, 242, 98 , 162, 43 , 95 , 19 , 9  , 31 , 151, 5  , 47 , 
	188, 3  , 175, 206, 2  , 207, 217, 2  , 63 , 225, 252, 96 , 81 , 247, 209, 57 , 
	59 , 207, 62 , 6  , 223, 180, 3  , 175, 209, 2  , 127, 223, 1  , 223, 231, 1  , 
	111, 236, 255, 208, 3  , 255, 208, 3  , 63 , 208, 3  , 255, 208, 3  , 255, 208, 
	3  , 255, 208, 3  , 255, 208, 3  , 255, 208, 3  , 2  , 207, 195, 5  , 207, 84 , 55 , 
	129, 49 , 247, 160, 87 , 251, 240, 52 , 253, 80 , 37 , 254, 0  , 28 , 254, 112, 
	23 , 3  , 223, 175, 7  , 111, 54 , 38 , 194, 120, 242, 160, 130, 250, 48 , 73 , 
	252, 64 , 50 , 253, 80 , 38 , 253, 240, 29 , 2  , 191, 200, 4  , 239, 131, 18 , 
	147, 130, 244, 176, 101, 251, 176, 53 , 253, 96 , 35 , 254, 32 , 25 , 254, 160, 
	19 , 0  , 63 , 253, 0  , 63 , 253, 0  , 51 , 253, 0  , 63 , 253, 0  , 63 , 253, 
	0  , 63 , 253, 0  , 63 , 253, 0  , 63 , 253, 253, 176, 48 , 251, 224, 99 , 244, 
	147, 174, 20 , 31 , 116, 5  , 175, 189, 3  , 95 , 212, 2  , 95 , 224, 1  , 207, 
	231, 252, 160, 68 , 250, 96 , 129, 242, 66 , 160, 42 , 159, 27 , 8  , 175, 157, 
	4  , 223, 194, 3  , 79 , 212, 2  , 111, 222, 253, 160, 47 , 252, 48 , 84 , 247, 
	161, 59 , 59 , 63 , 67 , 6  , 159, 184, 3  , 111, 213, 2  , 63 , 226, 1  , 159, 
	234, 255, 208, 3  , 255, 208, 3  , 255, 208, 3  , 63 , 208, 3  , 255, 208, 3  , 
	255, 208, 3  , 255, 208, 3  , 255, 208, 3  , 1  , 239, 219, 2  , 255, 192, 5  , 
	255, 81 , 55 , 241, 47 , 247, 192, 84 , 252, 32 , 49 , 253, 128, 34 , 254, 48 , 
	26 , 2  , 191, 204, 4  , 31 , 170, 7  , 175, 49 , 39 , 50 , 119, 242, 208, 126, 
	250, 96 , 69 , 252, 128, 46 , 253, 144, 34 , 1  , 255, 218, 2  , 239, 197, 5  , 
	47 , 127, 18 , 211, 130, 244, 224, 98 , 251, 208, 50 , 253, 128, 32 , 254, 80 , 
	23 , 0  , 63 , 253, 0  , 63 , 253, 0  , 63 , 253, 0  , 51 , 253, 0  , 63 , 253, 
	0  , 63 , 253, 0  , 63 , 253, 0  , 63 , 253, 254, 80 , 32 , 253, 128, 51 , 251, 
	176, 101, 244, 99 , 175, 19 , 223, 119, 5  , 127, 192, 3  , 47 , 215, 2  , 47 , 
	227, 253, 128, 48 , 252, 96 , 72 , 250, 32 , 133, 242, 2 , 163, 42 , 63 , 32 ,
	8  , 95 , 162, 4  , 143, 198, 3  , 15 , 216, 254, 48 , 34 , 253, 112, 50 , 252, 
	0  , 87 , 247, 113, 61 , 58 , 255, 70 , 6  , 95 , 187, 3  , 63 , 216, 2  , 15 , 229
};

static Zi_UINT8 BBLutTable[] = 
{
	0xcf,
	0xce,
	0xcd,
	0xcc,
	0xcb,
	0xca,
	0xc9,
	0xc8,
	0xc7,
	0xc6,
	0xc5,
	0xc4,
	0xc3,
	0xc2,
	0xc1,
	0xc0,
	0xbf,
	0xbe,
	0xbd,
	0xbc,
	0xbb,
	0xba,
	0xb9,
	0xb8,
	0xb7,
	0xb6,
	0xb5,
	0xb4,
	0xb3,
	0xb2,
	0xb1,
	0xb0,
	0xaf,
	0xae,
	0xad,
	0xac,
	0xab,
	0xaa,
	0xa9,
	0xa8,
	0xa7,
	0xa6,
	0xa5,
	0xa4,
	0xa3,
	0xa2,
	0xa1,
	0xa0,
	0x9f,
	0x9e,
	0x9d,
	0x9c,
	0x9b,
	0x9a,
	0x99,
	0x98,
	0x97,
	0x96,
	0x95,
	0x94,
	0x93,
	0x92,
	0x91,
	0x90,
	0x8f,
	0x8e,
	0x8d,
	0x8c,
	0x8b,
	0x8a,
	0x89,
	0x88,
	0x87,
	0x86,
	0x85,
	0x84,
	0x83,
	0x82,
	0x81,
	0x80,
	0x7f,
	0x7e,
	0x7d,
	0x7c,
	0x7b,
	0x7a,
	0x79,
	0x78,
	0x77,
	0x76,
	0x75,
	0x74,
	0x73,
	0x72,
	0x71,
	0x70,
	0x6f,
	0x6e,
	0x6d,
	0x6c,
	0x6b,
	0x6a,
	0x69,
	0x68,
	0x67,
	0x66,
	0x65,
	0x64,
	0x63,
	0x62,
	0x61,
	0x60,
	0x5f,
	0x5e,
	0x5d,
	0x5c,
	0x5b,
	0x5a,
	0x59,
	0x58,
	0x57,
	0x56,
	0x55,
	0x54,
	0x53,
	0x52,
	0x51,
	0x50,
	0x4f,
	0x4e,
	0x4d,
	0x4c,
	0x4b,
	0x4a,
	0x49,
	0x48,
	0x47,
	0x46,
	0x45,
	0x44,
	0x43,
	0x42,
	0x41,
	0x40,
	0x3f,
	0x3e,
	0x3d,
	0x3c,
	0x3b,
	0x3a,
	0x39,
	0x38,
	0x37,
	0x36,
	0x35,
	0x34,
	0x33,
	0x32,
	0x31,
	0x30,
	0x2f,
	0x2e,
	0x2d,
	0x2c,
	0x2b,
	0x2a,
	0x29,
	0x28,
	0x27,
	0x26,
	0x25,
	0x24,
	0x23,
	0x22,
	0x21,
	0x20,
	0x1f,
	0x1e,
	0x1d,
	0x1c,
	0x1b,
	0x1a,
	0x19,
	0x18,
	0x17,
	0x16,
	0x15,
	0x14,
	0x13,
	0x12,
	0x11,
	0x10,
	0x0f,
	0x0e,
	0x0d,
	0x0c,
	0x0b,
	0x0a,
	0x09,
	0x08,
	0x07,
	0x06,
	0x05,
	0x04,
	0x03,
	0x02,
	0x01,
	0x00
};

static Zi_UINT8 Tuner_reg_table[] = {
	// PolluxII reg init
	0x00, 0x00, // soft-reset all fsm
	// PMU setup
	0x07, 0xff, // set LPC control
	0x08, 0xff, // set LPC control
	0x09, 0xff, // set LPC control
	0x0a, 0x7f, // turn on LTA_LDO
	0x0b, 0xe9, // rbus rfrssi range and rect_tune
	0x0c, 0x50, // turn on LO buffer, set SW tuning = 00
	0x0d, 0x9b, // set LPF clk 27MHz
	0x2b, 0x02, // set LTALDO to 1.4V, LDOIF to 1.2V, LDORF to 1.4V
	//
	// LPF setup
	0x24, 0x00, // set ACS LPF_BW offset to 500kHz
	0x26, 0x00, // Set BW = 8MHz
	0x27, 0x02, // 
	//
	// Syn setup
	0x13, 0x08, // set LOLDO voltage to 1.2V, LO to UHF path
	0x20, 0x00, // set VHF_cap value
	0x21, 0x0f, // set UHF_cap value
	0x22, 0x06, // set Harm_cap value
	0x2a, 0x03, // enable ifrssi Vout, turn off test module
	0x2d, 0x28, // bypass sc
	//
	// system bring-up
	0x02, 0x00, // release init_cfg
	0x00, 0x0e, // release fd, sdm, sc fsm(FD starts to work after reset release)
	0x03, 0x08, // start afc
	//
	// AGC mode setup
	0x39, 0x28, //, 0x1E, // ACS high
	0x38, 0x26, //, 0x19, // ACS low
	//
	0x37, 0x58, // ALT high
	0x36, 0x50, // ALT low
	//
	0x3a, 0x16, // 14, //, 0x16, // tia_gain_acs_low_thd, can enter ACS mode
	0x3b, 0x1d, //, 0x1f, //0x1f??? tia_gain_acs_high_thd, can not exit ACS mode by this condition
	0x3C, 0x00, // lna_far_thd, Far condition 
	0x3d, 0x0a, //, 0x14, // tia gain far low thd
	0x3e, 0x15, // tia gain far high thd
	0x3f, 0x70, //, 0x8c, // alpf_voltage_low_thd
	0x40, 0x90, //, 0x90, // alpf_voltage_high_thd
	//
	// AGC setup
	//, 0x3f, 0x64, // set agc_alpf_voltage_low_thd
	0x41, 0x9d, // set AGC mode to normal with lta, inter-hold, far, alt and acs
	0x42, 0x09, //
	0x43, 0x77, //
	0x46, 0x14, // set LNA cfg
	0x47, 0x0f, // GSM mode, tia_bw_ctrl, tia_buf_cap_en and lo_filter_mode
	0x48, 0x65, // turn off RSSI calibration
	0x49, 0xaa, // agc rfrssi gain and bias
	0x4a, 0xc5, // agc ifrssi gain = mid
	0x50, 0x45, // set tia_pout_cn
	0x51, 0x30, // set tia_pout_n1
	0x52, 0x2b, // set tia_pout_n2 , // shuld be smaller than pout_n1
	0x53, 0x2b, // set tia_pout_far, // shuld be equal to pout_n2
	0x54, 0x05, // set tia_pout large range
	0x55, 0x03, // set tia_lock_range to +/-2dB
	0x56, 0x4a, // set tia_settle_tw to 64us/256us , 0x68
	0x57, 0x1f, // TIA protect 
	0x58, 0x00, // TIA BW = 6M
	0x59, 0xbb, // 0xaa->0xbb @201106211,Psig=-76,Pint=-18 set rf_settle_tw
	0x5a, 0xff, // LTA fail num = 15, LNA fial num =10
	0x5c, 0xda, // set lta_n2far_pout_offset to 6dB
	0x5d, 0xe0, // set lna_n2far_pout_offset to 6dB
	0xae, 0x92, // set saradc sample tw to 18us/2us
	0xaf, 0x36, // set rf_sample_num to 8/32 samples(320us*4 = 1.2ms)  , 0x35
	0xb0, 0x38, // set tia_sample_num to 16/512 samples(10mS)   , 0x49
	0xb2, 0x40, // set BBAGC to PWM mode, positive polarity; set PWM sample number to 1
	0x32, 0x74, // DCOC always enable
	//
	0xB8, 0x37, // LTA tbl size = 4, LNA tbl size = 8
	//
	// AGC Table Setup
	0xba, 0x1f, // mixer max gain
	0xbb, 0x16, // mixer max gain protect
	0xbc, 0x00, // mixer min gain
	0xbd, 0x16, // Mixer 1st gain
	0xbe, 0x09, // LTA 1st gain
	0xbf, 0x60, // LTA 2nd gain
	0xc0, 0x64, // LTA 3rd gain
	0xc1, 0x52, // LTA 4th gain
	//
	//////////////////////////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////////////////////////
	// AGC param setup
	//// 754M
	0xE8, 0x8F, //
	0xE9, 0x81, //
	0xEA, 0x84, //
	0xEB, 0x7A, //
	0xEC, 0x82, //
	0xED, 0x84, //
	0xEE, 0x84, //
	0xEF, 0x82, //
	0xCE, 0x9D, //
	0xCF, 0x90, //
	0xD0, 0x7C, //
	0xD1, 0x62, //
	0xF0, 0x17, //
	0xF1, 0x0F, //
	0xF2, 0x12, //
	0xF3, 0x0E, //
	0xF4, 0x0E, //
	0xF5, 0x0F, //
	0xF6, 0x0D, //
	0xF7, 0x11, //
	0xD3, 0x20, //
	0xD4, 0x0A, //
	0xD5, 0x15, //
	0xD6, 0x35, //
	//
	//
	////////////////////////////////////////////////////////////////////////////////////////////////////
	////////////////////////////////////////////////////////////////////////////////////////////////////
	//
	//LNA gain config
	//
	0xd8, 0x73, // lna_gain_0
	0xE0, 0x14, // lna ip2 cfg0
	0xE1, 0x33, //
	0xE2, 0x71, //
	0xE3, 0x71, //
	0xE4, 0x71, //
	0xE5, 0x61, //
	0xE6, 0x30, //
	0xE7, 0x30, //
	//
	0xF8, 0x14, // lna ip3 cfg0
	0xF9, 0x33, //
	0xFA, 0x71, //
	0xFB, 0x71, // LNA addr = 03, Gain = 04, IP3 cfg
	0xFC, 0x71, //
	0xFD, 0x61, //
	0xFE, 0x30, //
	0xFF, 0x30, //
	////////////////////////////////////////////////////////////////////////////////////////////////
	// Start AGC, FD
	0x00, 0x0f, // release AGC_FSM
	0x03, 0x01, // start AGC
	0x00, 0x07, // reset FD
	0x00, 0x0F, // release FD
	0x1f, 0x00, // set DAC output to 0

#ifdef _CHIP_SEL_NZ0255_	 //0255,0265
	0x0f, 0xff,	  //  4X6
	0x20, 0x02,
	0x21, 0x00,
	0x22, 0x04,
	0x31, 0x13
#endif

#ifdef _CHIP_SEL_NZ0266_	 //0266
	0x0f, 0x1f,	  //  6X6
	0x20, 0x0,
	0x21, 0x0,
	0x22, 0x0,
	0x31, 0x13
#endif

};

////////////////////////////////////////////////////////////////////////
static DEFINE_MUTEX(Zi_spilock);
Zi_RETURN_CODE Zi_SpiCmd52(Zi_HANDLE hDevice, Zi_UINT8 rwIndicator, Zi_UINT8 regFuncNum, 
				Zi_UINT32 regAddr, Zi_UINT8 *pRegVal)
{
	Zi_RETURN_CODE eRtnCode = Zi_GENERAL_ERROR;
	Zi_DEVICE_HANDLE *pDevice = (Zi_DEVICE_HANDLE *)hDevice;
	const Zi_UINT8 stuffBit = 0;
	const Zi_UINT8 rawFlag = 0;
	const Zi_UINT8 crc7Bit = 0;
	const Zi_UINT8 startBit =0;
	const Zi_UINT8 endBit= 1;
	const Zi_UINT8 directionBit =1;
	const Zi_UINT8 cmdIndx = 52;				/* cmd52 */
	Zi_UINT8 cmd52[6] = {0, 0, 0, 0, 0, 0};
	Zi_UINT8 j;

	if (NULL == pDevice)
	{
		return Zi_GENERAL_ERROR;
	}
	
	if((regFuncNum > REG_PAGE_FUNC1) || (rwIndicator > CTRL_PATH_WRITEREG) || 
		((regFuncNum == REG_PAGE_FUNC1) && (regAddr > 0x00ff)))
	{
		Zi_log("The argument is error!!!\n");
		return Zi_GENERAL_ERROR;
	}

	if(!pDevice->pDevTxBuffer || !pDevice->pDevRxBuffer)
	{
		return Zi_GENERAL_ERROR;
	}

	mutex_lock(&Zi_spilock);
	
	Zi_memset(pDevice->pDevTxBuffer, 0xff, 32);
	Zi_memset(pDevice->pDevRxBuffer, 0xff, 32);

	/*Packet CMD52
	|-------|-------|---------------|---------------|-------|-------|-------|-------|
	|S	|D	|Command Index	|R/W flag	|stuff	|address	|CRC7	|E	|
	|-------|-------|---------------|---------------|-------|-------|-------|-------|
	|1bit	|1bit	|6bit		|1bit		|1bit	|17bit	|7bit	|1bit	|
	|-------|-------|---------------|---------------|-------|-------|-------|-------|
	*/	
	
	cmd52[0] = (Zi_UINT8)((startBit << 7) | (directionBit << 6) | (cmdIndx));
	
	cmd52[1] = (Zi_UINT8)((rwIndicator << 7) | (regFuncNum << 4) | (rawFlag << 3) | stuffBit | (Zi_UINT8)(regAddr >> 15));

	cmd52[2] = (Zi_UINT8)(regAddr >> 7) & 0xff;

	cmd52[3] = ((Zi_UINT8)(regAddr << 1) & 0x0ff) | stuffBit;

	if(CTRL_PATH_READREG == rwIndicator)
	{
		cmd52[4] = 0;
	}
	else
	{
		cmd52[4] = *pRegVal;
	}

	cmd52[5] = ((Zi_UINT8)(crc7Bit << 1) | endBit);	/* Default the chip work on NO-CRC mode.*/
	
	Zi_memcpy(pDevice->pDevTxBuffer, cmd52, 6);

	eRtnCode = Zi_SpiTxRx(7, pDevice->pDevTxBuffer, 32, pDevice->pDevRxBuffer);
	
	/*when reset spi via function0 register 0x06, no response,return ok!*/
	if((SPI_MAC_RESET_REG == regAddr) && (REG_PAGE_FUNC0 == regFuncNum) &&  (CTRL_PATH_WRITEREG == rwIndicator))
	{
		Zi_log("Zi_RTN_OK");
		mutex_unlock(&Zi_spilock);
		return eRtnCode;
	}

	j =0;
	while (0xff == pDevice->pDevRxBuffer[j])
	{
		if (j > 30)
		{
			Zi_log("Can't find data!\n");
			mutex_unlock(&Zi_spilock);
			return Zi_GENERAL_ERROR;
		}
		j++;
	}

	if((CTRL_PATH_READREG == rwIndicator) && (0x00 == pDevice->pDevRxBuffer[j]))
	{
		*pRegVal = pDevice->pDevRxBuffer[j+1];
	}

	mutex_unlock(&Zi_spilock);
	return eRtnCode;
}

////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_SpiCmd53(Zi_HANDLE hDevice, Zi_UINT8 rwFlag, Zi_UINT8 burstMode, Zi_UINT32 bufferAddr, 
				Zi_UINT16 byteCnt, Zi_UINT8 *pBurstDataIn)
{
	Zi_RETURN_CODE eRtnCode = Zi_GENERAL_ERROR;
	Zi_DEVICE_HANDLE* pDevice = (Zi_DEVICE_HANDLE *) hDevice;
	const Zi_UINT8 startBit = 0;
	const Zi_UINT8 endBit = 1;
	const Zi_UINT8 directionBit = 1;
	const Zi_UINT8 cmdIndx = 53;				/* cmd53 */
	const Zi_UINT8 funcNum = REG_PAGE_FUNC1;
	const Zi_UINT8 incAddr = SPI_FIXED_ADDRESS;		/* Fixed Address access */
	const Zi_UINT8 crc7Bit = 0;
	Zi_UINT8 cmd53[6] = {0, 0, 0, 0, 0, 0};
	Zi_UINT32 txLen;
	Zi_UINT32 j = 0;
	Zi_UINT16 byteBlockCount = 0;
	Zi_UINT8  tmp;

	if (NULL == pDevice)
	{
		return Zi_GENERAL_ERROR;
	}

	if (BLOCK_MODE == burstMode)
	{
		byteBlockCount = 1;
		/* set cmd53 read block length */
		tmp = (Zi_UINT8)(byteCnt & 0xff);
		eRtnCode = Zi_SpiCmd52(pDevice, CTRL_PATH_WRITEREG, REG_PAGE_FUNC0, 0x110, &tmp);
		tmp =  (Zi_UINT8)(byteCnt >> 8);
		eRtnCode = Zi_SpiCmd52(pDevice, CTRL_PATH_WRITEREG, REG_PAGE_FUNC0, 0x111, &tmp);
	}
	else
	{
		Zi_log("Isn't BLOCK_MODE!\n");
		return Zi_GENERAL_ERROR;
	}

	if(!pDevice->pDevTxBuffer || !pDevice->pDevRxBuffer)
	{
		return Zi_GENERAL_ERROR;
	}

	mutex_lock(&Zi_spilock);

	txLen = LENGTH_CMD53_NCR_R5_NAC + byteCnt;
	Zi_memset(pDevice->pDevTxBuffer, 0xff, txLen);
	Zi_memset(pDevice->pDevRxBuffer, 0xff, txLen);

	/*Packet CMD53
	|-------|-------|---------------|---------------|---------------|---------------|---------------|-------|---------------|-------|-------|
	|S	|D	|Command Index	|R/W flag	|Function Number	|Block Mode	|OP Code	|address	|Byte/Block count	|CRC7	|E	|
	|-------|-------|---------------|---------------|---------------|---------------|---------------|-------|---------------|-------|-------|
	|1bit	|1bit	|6bit		|1bit		|3bit		|1bit		|1bit		|17bit	|9bit		|7bit	|1bit	|
	|-------|-------|---------------|---------------|---------------|---------------|---------------|-------|---------------|-------|-------|
	*/
	
	cmd53[0] = (startBit << 7) | (directionBit << 6) | (cmdIndx);

	cmd53[1] = (Zi_UINT8)((rwFlag << 7) | (funcNum << 4) | (burstMode << 3) | (incAddr << 2) | (Zi_UINT8)(bufferAddr >> 15));

	cmd53[2] = (Zi_UINT8)(bufferAddr >> 7) & 0x0ff;

	cmd53[3] = ((Zi_UINT8)(bufferAddr << 1) & 0x0ff) | ((Zi_UINT8)(byteBlockCount >> 8));

	cmd53[4] = (Zi_UINT8)(0xff & byteBlockCount);

	cmd53[5] = (crc7Bit << 1) | (endBit);	/* default the chip work on NO-CRC mode. */

	Zi_memcpy(pDevice->pDevTxBuffer, cmd53, 6);

	eRtnCode = Zi_SpiTxRx(7, pDevice->pDevTxBuffer, txLen, pDevice->pDevRxBuffer);

	if(0 == rwFlag)	/* block read */
	{
		j=0;
		while (0xff == pDevice->pDevRxBuffer[j])
		{	/*  ++ untill receive R5 */
			if (j > 14)
			{
				Zi_log("Can't find data(all 0xff)!\n");
				mutex_unlock(&Zi_spilock);
				return Zi_GENERAL_ERROR;
			}
			j++;
		}
		while (0xfe != pDevice->pDevRxBuffer[j])
		{	/*  ++ untill receive DataHead */
			if (j > LENGTH_CMD53_NCR_R5_NAC)
			{
				Zi_log("Can't find data(!=0xfe)!\n");
				mutex_unlock(&Zi_spilock);
				return Zi_GENERAL_ERROR;
			}
			j++;
		}
		j++;
		Zi_memcpy(pBurstDataIn, (pDevice->pDevRxBuffer+j), txLen-LENGTH_CMD53_NCR_R5_NAC);
	}
	else	/* block write*/
	{
		j = 0;
		while (0xff == pDevice->pDevRxBuffer[j])
		{	/*  ++ untill receive R5 */
			if (j > 14)
			{
				Zi_log("Can't find data(all 0xff)!\n");
				mutex_unlock(&Zi_spilock);
				return Zi_GENERAL_ERROR;
			}
			j++;
		}
		while (0xff != pDevice->pDevRxBuffer[j])
		{
			if (j > LENGTH_CMD53_NCR_R5_NAC)
			{
				mutex_unlock(&Zi_spilock);
				return Zi_GENERAL_ERROR;
			}
			j++;
		}
		j++;

		Zi_memset(pDevice->pDevTxBuffer, 0xff, byteCnt+1+4);	/* for add 1 byte header 0xfe and 4 bytes for CRC check */
		Zi_memset(pDevice->pDevRxBuffer, 0xff, byteCnt+1+4);
		pDevice->pDevTxBuffer[0] = 0xfe;
		for(j = 1; j <= byteCnt; j++)
		{
			pDevice->pDevTxBuffer[j] = *pBurstDataIn ++; 
		}

		eRtnCode = Zi_SpiTxRx((byteCnt+1+1), pDevice->pDevTxBuffer, (byteCnt+1+4), pDevice->pDevRxBuffer);

		j=0;
		while (0xff == pDevice->pDevRxBuffer[j])
		{	/* ++ untill receive R5 */
			if (j >= byteCnt+1+4)
			{
				mutex_unlock(&Zi_spilock);
				return Zi_GENERAL_ERROR;
			}
			j++;
		}
		while (0xe5 != pDevice->pDevRxBuffer[j])
		{	/* ++ untill receive DataHead */
			if (j > LENGTH_CMD53_NCR_R5_NAC)
			{
				mutex_unlock(&Zi_spilock);
				return Zi_GENERAL_ERROR;
			}
			j++;
		}
	}

	mutex_unlock(&Zi_spilock);
	return eRtnCode;
}

////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_WriteReg(Zi_HANDLE hDevice, Zi_UINT8 regAddr, Zi_UINT8 regValue)
{
	Zi_RETURN_CODE eRtnCode = Zi_GENERAL_ERROR;
	if (NULL == hDevice)
	{
		return Zi_GENERAL_ERROR;
	}
	eRtnCode = Zi_SpiCmd52(hDevice, CTRL_PATH_WRITEREG, REG_PAGE_FUNC1, regAddr, &regValue);
	return eRtnCode;
}

////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_ReadReg(Zi_HANDLE hDevice, Zi_UINT8 regAddr, Zi_UINT8* regValue)
{
	Zi_RETURN_CODE eRtnCode = Zi_GENERAL_ERROR;
	if (NULL == hDevice)
	{
		return Zi_GENERAL_ERROR;
	}
	eRtnCode = Zi_SpiCmd52(hDevice, CTRL_PATH_READREG, REG_PAGE_FUNC1, regAddr, regValue);
	return eRtnCode;
}

////////////////////////////////////////////////////////////////////////
Zi_UINT8 Zi_BitSet(Zi_UINT8 inputVal, 
			Zi_UINT8 bitOffset, 
			Zi_UINT8 bitCnt, 
			Zi_UINT8 setVal)
{
	Zi_UINT8 i;
	Zi_UINT8 offsetVal;

	offsetVal = bitOffset;
	for(i = 0; i < bitCnt; i++)
	{	/* set the bit value of data 0 */
		inputVal = inputVal & (~(Zi_UINT8)(1 << bitOffset));  
		bitOffset++;
	}	   
	inputVal = inputVal | (Zi_UINT8)((setVal << offsetVal));
	return inputVal;
}

////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_WriteRegFields(	Zi_HANDLE hDevice, 
					Zi_UINT32 regAddr, 
					Zi_UINT8 bitOffset, 
					Zi_UINT8 bitCnt, 
					Zi_UINT8 regVal)
{
	Zi_UINT8 wrData;
	Zi_UINT8 value;

	if (NULL == hDevice)
	{
		return Zi_GENERAL_ERROR;
	}

	Zi_ReadReg(hDevice, regAddr, &value);
	wrData = Zi_BitSet(value, bitOffset, bitCnt, regVal);			

	return Zi_WriteReg(hDevice, regAddr, wrData);

}

////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_ReadRegFields (	Zi_HANDLE hDevice, 
					Zi_UINT32 regAddr, 
					Zi_UINT8 bitOffset, 
					Zi_UINT8 bitCnt, 
					Zi_UINT8 *pRegVal)
{
	Zi_UINT8 rdData = 0;
	Zi_UINT8 i;

	if (NULL == hDevice)
	{
		return Zi_GENERAL_ERROR;
	}

	Zi_ReadReg(hDevice, regAddr, pRegVal);
	for(i = 0; i < bitCnt; i++)
	{
		rdData |= (Zi_UINT8)((((*pRegVal) >> bitOffset) & ((Zi_UINT8)0x01)) << i);
		bitOffset++;
	}
	*pRegVal = rdData;

	return Zi_RTN_OK;

}

////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_BurstWriteReg(Zi_HANDLE hDevice, Zi_UINT8 regAddr, Zi_UINT8* data, Zi_INT32 dataLen)
{
	Zi_RETURN_CODE eRtnCode = Zi_GENERAL_ERROR;
	Zi_UINT32 i;

	if (NULL == hDevice)
	{
		return Zi_GENERAL_ERROR;
	}
	for(i = 0; i < dataLen/SPI_BURST_LEN; i++)
	{
		eRtnCode = Zi_SpiCmd53(hDevice, SPI_WRITE_FLAG, BLOCK_MODE, regAddr, SPI_BURST_LEN, data+i*SPI_BURST_LEN);
		if(Zi_RTN_OK != eRtnCode)
		{
			return Zi_GENERAL_ERROR;
		}
	}
	eRtnCode = Zi_SpiCmd53(hDevice, SPI_WRITE_FLAG, BLOCK_MODE, regAddr, (dataLen%SPI_BURST_LEN), data+i*SPI_BURST_LEN); 

	return eRtnCode;
}

////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_BurstRead(Zi_HANDLE hDevice, Zi_UINT8 bufferAddr, Zi_UINT32 burstLen, Zi_UINT8 *pBurstDataIn)
{
	Zi_RETURN_CODE eRtnCode = Zi_GENERAL_ERROR;
	Zi_UINT32 i;

	if (NULL == hDevice)
	{
		return Zi_GENERAL_ERROR;
	}

	Zi_log("Begin burstRead, burstLen = 0x%x\n", burstLen);

	for(i = 0; i < burstLen/SPI_BURST_LEN; i++)
	{
		eRtnCode = Zi_SpiCmd53(hDevice, SPI_READ_FLAG, BLOCK_MODE, bufferAddr, SPI_BURST_LEN, pBurstDataIn+i*SPI_BURST_LEN);
		if(Zi_RTN_OK != eRtnCode)
		{
			return Zi_GENERAL_ERROR;
		}
	}
	eRtnCode = Zi_SpiCmd53(hDevice, SPI_READ_FLAG, BLOCK_MODE, bufferAddr, (burstLen%SPI_BURST_LEN), pBurstDataIn+i*SPI_BURST_LEN);
	Zi_log("End burstRead!\n");
	return eRtnCode;
}

////////////////////////////////////////////////////////////////////////
Zi_UINT32 Zi_GetTickCount(Zi_HANDLE hDevice)
{
	Zi_UINT8 nTickCount;
	Zi_DEVICE_HANDLE *pDevice = (Zi_DEVICE_HANDLE *) hDevice;

	if (NULL == pDevice)
	{
		return Zi_GENERAL_ERROR;
	}
	
	Zi_ReadReg(pDevice, REG_TIMER_VAL, &nTickCount);
	if(pDevice->nTickSaved > nTickCount)
	{
		pDevice->nTickBase += 0x100 + nTickCount - pDevice->nTickSaved;
	}
	else
	{
		pDevice->nTickBase += nTickCount - pDevice->nTickSaved;
	}
	pDevice->nTickSaved = nTickCount;

	return pDevice->nTickBase*5;
}


////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_ReadTunerReg(Zi_HANDLE hDevice, Zi_UINT8 regAddr, Zi_UINT8* regValue)
{
	Zi_RETURN_CODE eRtnCode = Zi_GENERAL_ERROR;
	Zi_UINT8 ticStatus = 0;
	//Zi_UINT8 checkNum = 0;
	Zi_UINT8 count = 0;
	//Zi_UINT8 regVal = 0;
	Zi_UINT8 burstLen = 1;
	Zi_UINT32 tick;

	if (NULL == hDevice)
	{
		return Zi_GENERAL_ERROR;
	}

	/*control by tic*/
	/* write the read byte number */
	Zi_WriteRegFields(hDevice, REG_TIC_HOST_ACCESS_BYTE_NUM, 0x0, 3, burstLen);

	/*write the register address to TIC address reg*/
	Zi_WriteReg(hDevice, REG_SLAVE_RDADD, regAddr);

	/*
	  * we can read the TIC status reg to check this read operation completed or not in TIC module
	  * if ok, then we read the data reg to get the register value
	  */

	tick = Zi_GetTickCount(hDevice);
	while(Zi_GetTickCount(hDevice) - tick < 200)
	{
		eRtnCode = Zi_ReadReg(hDevice, REG_TIC_STATUS, &ticStatus);
		if(Zi_RTN_OK == eRtnCode)
		{
			if(0 != (ticStatus & 0x01))/* check bit0 of ticStatus ,if it is '1b1, then ok.*/
			{
				for(count = 0; count < burstLen; count++)
				{
					eRtnCode = Zi_ReadReg(hDevice,  (REG_SLAVE_RDDATA_A - count), (regValue + count));
					if (Zi_RTN_OK != eRtnCode)
					{
						continue;
					}
				}
				return eRtnCode;/* read tuner reg ok*/
			}
		}
	}/*end of for loop*/
	Zi_log("read the tic status time out, time is:%d!!!\n", Zi_GetTickCount(hDevice) - tick);

	return Zi_GENERAL_ERROR;
}

////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_WriteTunerReg(Zi_HANDLE hDevice, Zi_UINT8 regAddr, Zi_UINT8 regValue)
{
	Zi_RETURN_CODE eRtnCode = Zi_GENERAL_ERROR;
	Zi_UINT8 ticStatus = 0;
	//Zi_UINT8 checkNum = 0;
	Zi_UINT8 count = 0;
	Zi_UINT8 burstLen = 1;
	Zi_UINT32 tick;

	if (NULL == hDevice)
	{
		return Zi_GENERAL_ERROR;
	}

	/*control by tic*/
	/* write the write byte number */
	Zi_WriteRegFields(hDevice, REG_TIC_HOST_ACCESS_BYTE_NUM, 0x3, 3, burstLen);

	/* write the register value to TIC write data reg*/
	for(count = 0; count < burstLen; count++)
	{
		Zi_WriteReg(hDevice,  (REG_SLAVE_WRDATA_A - count), *(&regValue + count));
	}

	/* write the register address to TIC write address reg*/
	Zi_WriteReg(hDevice,  REG_SLAVE_WRADD, regAddr);

	/*we can read the TIC status reg to check this write operation completed or not*/
	tick = Zi_GetTickCount(hDevice);
	while(Zi_GetTickCount(hDevice) - tick < 200)
	{
		eRtnCode = Zi_ReadReg(hDevice, REG_TIC_STATUS, &ticStatus);
		if(Zi_RTN_OK == eRtnCode)
		{
			if(0 !=(ticStatus & 0x01)) /* check bit0 of ticStatus, if it is '1b1, then ok.*/
			{
				return eRtnCode; /* write tuner reg ok*/
			}
		}/* end of check operStatus */
	}/* end of for loop */	
	Zi_log("read the tic status time out, time is:%d!!!\n", Zi_GetTickCount(hDevice) - tick);  
	
	return Zi_GENERAL_ERROR;	
}

////////////////////////////////////////////////////////////////////////
Zi_VOID Zi_EnableInt(Zi_HANDLE hDevice, Zi_UINT8 fEnable)
{
	if (NULL == hDevice)
	{
		return;
	}
	if (fEnable)
	{
		//Zi_WriteReg(hHandle, REG_HIC1_INT_CLEAR, 0xff);  //del by mingsen
		Zi_WriteReg(hDevice, REG_HIC2_INT_CLEAR, 0xff);
		Zi_WriteReg(hDevice, REG_OTDD_INT_CLEAR, 0x7f);
		Zi_WriteReg(hDevice, REG_MISC_INT_CLEAR, 0xff);
		
		Zi_WriteReg(hDevice, REG_HIC1_INT_MASK, 0x3f); // enable SC data ready INT
		Zi_WriteReg(hDevice, REG_HIC2_INT_MASK, 0);
		Zi_WriteReg(hDevice, REG_OTDD_INT_MASK, 0x80); //enable timer INT
		Zi_WriteReg(hDevice, REG_MISC_INT_MASK, 0);
		Zi_WriteReg(hDevice, REG_SCC_INT_MASK, 0x0f);
	}
	else
	{
		Zi_WriteReg(hDevice, REG_HIC1_INT_MASK, 0x0);      //disable All interrupt
		Zi_WriteReg(hDevice, REG_HIC2_INT_MASK, 0x0);
		Zi_WriteReg(hDevice, REG_OTDD_INT_MASK, 0x0);
		Zi_WriteReg(hDevice, REG_MISC_INT_MASK, 0x0);
		Zi_WriteReg(hDevice, REG_SCC_INT_MASK, 0x0);   
	}
}

////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_SetupSlaveSpi (Zi_HANDLE hDevice)
{
	Zi_RETURN_CODE eRtnCode = Zi_GENERAL_ERROR;
	Zi_DEVICE_HANDLE *pDevice = (Zi_DEVICE_HANDLE *)hDevice;
	Zi_UINT8 regval = 0;

	if (NULL == pDevice)
	{
		return Zi_GENERAL_ERROR;
	}

	/*func1 enable write to set 0x02(func0).bit1 */
	eRtnCode = Zi_SpiCmd52(pDevice, CTRL_PATH_READREG, REG_PAGE_FUNC0, 0x02, &regval);
	regval |= 0x02;
	eRtnCode = Zi_SpiCmd52(pDevice, CTRL_PATH_WRITEREG, REG_PAGE_FUNC0, 0x02, &regval);

	//eRtnCode = Zi_SpiCmd52(pDevice, CTRL_PATH_READREG, REG_PAGE_FUNC0, 0x02, &regval);

	if(INT_USE_SPI_MAC == pDevice->tDeviceConfig.nIntType)
	{
		/*REG_PAGE_FUNC1 interrupt enable and Interrupt pin enable */
		eRtnCode = Zi_SpiCmd52(pDevice, CTRL_PATH_READREG, REG_PAGE_FUNC0, 0x04, &regval);
		regval |= 0x03;
		eRtnCode = Zi_SpiCmd52(pDevice, CTRL_PATH_WRITEREG, REG_PAGE_FUNC0, 0x04, &regval);

		/* Enable continuous SPI INT */
		eRtnCode = Zi_SpiCmd52(pDevice, CTRL_PATH_READREG, REG_PAGE_FUNC0, 0x07, &regval);
		regval |= 0xa0;
		eRtnCode = Zi_SpiCmd52(pDevice, CTRL_PATH_WRITEREG, REG_PAGE_FUNC0, 0x07, &regval);
	}

	return eRtnCode;
}

////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_StopSlaveSpi (Zi_HANDLE hDevice)
{
	Zi_RETURN_CODE eRtnCode = Zi_GENERAL_ERROR;
	Zi_UINT8 regVal;

	if (NULL == hDevice)
	{
		return Zi_GENERAL_ERROR;
	}

	eRtnCode = Zi_SpiCmd52(hDevice, CTRL_PATH_READREG,  REG_PAGE_FUNC0,  SPI_MAC_RESET_REG, &regVal);
	regVal = Zi_BitSet(regVal, 0x03, 1, 0x01);
	eRtnCode = Zi_SpiCmd52(hDevice, CTRL_PATH_WRITEREG,  REG_PAGE_FUNC0,  SPI_MAC_RESET_REG, &regVal);
	return eRtnCode;
}

////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_WriteCoeff(Zi_HANDLE hDevice)
{
	if (NULL == hDevice)
	{
		return Zi_GENERAL_ERROR;
	}
	return Zi_BurstWriteReg(hDevice, REG_COEFF_BUF, gCoeffTable, COEFF_ARRAY_LEN);
}

////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_InitScc(Zi_HANDLE hDevice, Zi_UINT8 *pBufOut, Zi_UINT32 *pBufOutLen)
{
	Zi_RETURN_CODE eRtnCode = Zi_RTN_OK;
	Zi_UINT8 sccStatus = 0;
	Zi_UINT8 ppsStatus = 0;
	Zi_UINT8 data[50];
	Zi_UINT32 tm,tm2;
	Zi_UINT8 regVal;
	Zi_UINT8 i;

	if (NULL == hDevice)
	{
		return Zi_GENERAL_ERROR;
	}

	//Pack pin define
#ifdef  _CHIP_SEL_NZ0255_  
	Zi_WriteRegFields(hDevice, REG_UAM_IO_CONFIG, 0, 1, 0);

#endif

#ifdef  _CHIP_SEL_NZ0266_
	Zi_WriteRegFields(hDevice, REG_UAM_IO_CONFIG, 0, 1, 1);
#endif

	Zi_WriteReg(hDevice, REG_TXRX_CTRL, 0x05);//  bit4=0: clk output en	   retry times =2^5

	Zi_WriteReg(hDevice, REG_RST_ASSERT_TIME, 0xff);// reset assert time
	Zi_WriteReg(hDevice, REG_CLK_DIVN, Zi_UAM_CLK_1M);//simclk = 78MHz/2/(0x1f+1)  todo:: uam clk  


	Zi_WriteReg(hDevice, REG_REQ_MAX_DELAY_H, 0x3f); //command response max delay h
	Zi_WriteReg(hDevice, REG_REQ_MAX_DELAY_L, 0xff); //delay l

	Zi_WriteReg(hDevice, REG_SOFT_RST, 0xbf); //soft reset scc
	Zi_WriteReg(hDevice, REG_SOFT_RST, 0xff);
	Zi_WriteReg(hDevice, REG_BAUD_RATE_CTRL, 0x01);//reset F/D
	Zi_WriteReg(hDevice, REG_SCC_RST_PPS_CFG, 0x1); //reset en

	tm = Zi_GetTickCount(hDevice);
	while(Zi_GetTickCount(hDevice) - tm < 4000)		//			
	{
		Zi_ReadReg(hDevice, REG_SCC_INT_STATUS, &sccStatus);
		if(sccStatus != 0)
		{
			if(REG_SCC_IR_RST_PPS_CMPLT_STATUS_BIT == (sccStatus & REG_SCC_IR_RST_PPS_CMPLT_STATUS_BIT))
 			{
				Zi_log("reset complete : 0x%x!\n", sccStatus);
				Zi_WriteReg(hDevice, REG_SCC_INT_CLEAR, 0xff);
				//Zi_ReadReg(hDevice, REG_SCC_INT_STATUS, &sccStatus);  //???

				Zi_BurstRead(hDevice, REG_7816_DATA_QUEUE, 21, data);
				*pBufOutLen = 21;
				Zi_memcpy(pBufOut, data, *pBufOutLen);

				Zi_ReadReg(hDevice,REG_UAM_BAUD_RATE, &regVal); // get buandrate from HW
#if 1 //enable pps function
				Zi_WriteReg(hDevice, REG_SOFT_RST, 0xbf);
				Zi_WriteReg(hDevice, REG_SOFT_RST, 0xff);
				Zi_WriteReg(hDevice, REG_PPS_CFG, data[2]);	//??? check euq to bdw from HW REG_UAM_BAUD_RATE
				Zi_WriteReg(hDevice, REG_SCC_RST_PPS_CFG, 0x2);
				tm2 = Zi_GetTickCount(hDevice);
				while(Zi_GetTickCount(hDevice) - tm2 < 2000)
				{
					Zi_ReadReg(hDevice, REG_SCC_INT_STATUS, &ppsStatus);
					if(REG_SCC_IR_RST_PPS_CMPLT_STATUS_BIT == (ppsStatus & REG_SCC_IR_RST_PPS_CMPLT_STATUS_BIT))
					{
						Zi_BurstRead(hDevice,REG_7816_DATA_QUEUE,21,data);
						Zi_WriteReg(hDevice, REG_BAUD_RATE_CTRL, regVal);

						break;
					}
				}
#endif
				Zi_WriteReg(hDevice, REG_SOFT_RST, 0xbf);
				Zi_WriteReg(hDevice, REG_SOFT_RST, 0xff);
				//Zi_ReadReg(hDevice, 0x3e, &regVal);
				Zi_WriteReg(hDevice, REG_SCC_INT_CLEAR, 0xff);
				eRtnCode = Zi_RTN_OK;
				break;
			}	   
			if(REG_SCC_IR_RST_PPS_NACK_STATUS_BIT == (sccStatus & REG_SCC_IR_RST_PPS_NACK_STATUS_BIT))
			{
				Zi_log("Reset no ack: 0x%x!\n", sccStatus);
			}

			if(REG_SCC_IR_RST_PPS_PERR_STATUS_BIT == (sccStatus & REG_SCC_IR_RST_PPS_PERR_STATUS_BIT))
			{
				Zi_BurstRead(hDevice,REG_7816_DATA_QUEUE, 21, data);

				//Zi_WriteReg(hDevice, 0x1a, regVal);
				Zi_WriteReg(hDevice, REG_SOFT_RST, 0xbf);
				Zi_WriteReg(hDevice, REG_SOFT_RST, 0xff);
				Zi_log("Reset perr: 0x%x!\n", sccStatus);
			}

			if(REG_SCC_IR_RST_PPS_TIME_OUT_STATUS_BIT == (sccStatus&REG_SCC_IR_RST_PPS_TIME_OUT_STATUS_BIT))
			{
				Zi_log("Reset timeout: 0x%x!\n", sccStatus);
			}

			if (sccStatus & 0x0f > 0)
			{
				Zi_log("Reset status error : 0x%x!\n", sccStatus);
			}
			
			Zi_log("Zi_InitScc fail!\n");
			Zi_BurstRead(hDevice, REG_7816_DATA_QUEUE, 21, data);			
			*pBufOutLen = 21;
			Zi_memcpy(pBufOut, data, *pBufOutLen);
 			
			Zi_WriteReg(hDevice, REG_SOFT_RST, 0xbf);
			Zi_WriteReg(hDevice, REG_SOFT_RST, 0xff);
			Zi_WriteReg(hDevice, REG_SCC_INT_CLEAR, 0xff);
			eRtnCode = Zi_GENERAL_ERROR;
			break;
		}
	}
	Zi_PrintMsg(pBufOut, *pBufOutLen, 2);
	return eRtnCode;
}

////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_InitTuner (Zi_HANDLE hDevice)
{
	Zi_RETURN_CODE eRtnCode = Zi_RTN_OK;
	Zi_UINT8 regVal;
	Zi_UINT8 h,j;
	Zi_UINT8 chipId=0;
	Zi_DEVICE_HANDLE *pDevice = (Zi_DEVICE_HANDLE *)hDevice;
	Zi_UINT32 i;

	if (NULL == pDevice)
	{
		return Zi_GENERAL_ERROR;
	}

	/* Setup tuner interface */	
	Zi_WriteReg(pDevice, REG_TIC_CONTROL, POLLUX2_CTRL_REG_VAL);
	Zi_WriteReg(pDevice, REG_SLAVE_ADD, POLLUX2_SALVE_ADDR_VAL>>1);
	Zi_WriteReg(pDevice, REG_PRESCALE_COUNTER, POLLUX2_I2CBRATE_CFIG_VAL);	   

	for (i = 0; i < sizeof(BBLutTable); i++)
	{	/* download the lut table */
		Zi_WriteReg(pDevice, REG_AGC_LUT_WRDATA, BBLutTable[sizeof(BBLutTable)-i-1]);  
		Zi_WriteReg(pDevice, REG_AGC_LUT_WRADD, i);
	}

	Zi_WriteReg(pDevice, REG_BB_AGC_ADD, 0x45); // Pollux2 BBAGC address 

	Zi_WriteReg(pDevice, REG_AGC_INIT_DB, 0x78); // BBAGC adjust initial dB
	Zi_WriteReg(pDevice, REG_AGC_MIN_DB, 0x00);  // BBAGC adjust min dB
	Zi_WriteReg(pDevice, REG_AGC_MAX_DB, 0xcf);  // BBAGC adjust max dB

	Zi_WriteReg(pDevice, REG_TUNER_MODE_ADD, 0x02); // Pollux2 LPC and Holdagc address
	Zi_WriteReg(pDevice, REG_TUNER_MODE_MASK, 0x00); // Pollux2 LPC and Holdagc control mask value

	/* Check tuner read/write */
	for(h = 1; h <= 50; h++)
	{
		Zi_ReadTunerReg(pDevice, 0x1, &chipId);
		if(chipId == 0x08)
		{
			for(j=1; j<=10; j++)
			{
				Zi_WriteTunerReg(pDevice, 0x44, 0x1a);
				Zi_ReadTunerReg(pDevice, 0x44, &regVal);
				if(0x1a == regVal)
				{
					Zi_log("Check  tuner register r/w ok, read times= %d\t write times= %d\n", h, j);
					break;
				}
				else
				{
					Zi_log("Read ok, but write tuner register error, 0x44= 0x%x! read times= %d\t write times= %d\n", regVal, h, j);
				}	
			}
			if (0x1a == regVal)
				break;
			else
			{
				Zi_log("Write tuner register error, 0x44=0x%x!\n", regVal);
			}
		}
	}

	if(chipId != 0x8 || 0x1a != regVal)
	{
		Zi_log("Read tuner chip id error 100 times, 0x1=0x%x\n", chipId);
		return Zi_GENERAL_ERROR;	
	}


	/*Init tuner*/
	eRtnCode = Zi_FlushReg(pDevice);
	return eRtnCode;
}

////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_FlushReg(Zi_HANDLE hDevice)
{
	Zi_RETURN_CODE eRtnCode = Zi_RTN_OK;

	if (NULL == hDevice)
	{
		return Zi_GENERAL_ERROR;
	}

	Zi_UINT32 i;
	for(i = 0; i < sizeof(Tuner_reg_table);)
	{
		eRtnCode = Zi_WriteTunerReg(hDevice, Tuner_reg_table[i], Tuner_reg_table[i+1]);
		if(Zi_RTN_OK != eRtnCode)
		{
			Zi_log("Write tuner reg error! \n");
			return eRtnCode;
		}
		i += 2;
	}

	return Zi_RTN_OK;
}

////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_GetChipVersion(Zi_HANDLE hDevice)
{
	Zi_UINT8 nChipVersion = 0, i;

	if (NULL == hDevice)
	{
		return Zi_GENERAL_ERROR;
	}
	
	for(i = 0; i < 100; i++)
	{
		Zi_ReadReg(hDevice, REG_CHIP_VERSION, &nChipVersion);
		if(nChipVersion == 0x21)
		{
			Zi_log("Chip version 0x%x, read times %d\n", nChipVersion, i);
			break;
		}
	}
 
	if(nChipVersion != 0x21)
	{
		Zi_log("Chip version error!\n");
		return Zi_GENERAL_ERROR;
	}

	return Zi_RTN_OK;
}

////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_SetTunerFreq (Zi_HANDLE hDevice, Zi_UINT32 freqHz)
{  
	//Zi_RETURN_CODE rtnCode = Zi_RTN_OK;
	Zi_UINT32 Flo;
	Zi_UINT32 Fv11=  39840;								   
	Zi_UINT32 Fv12=  56250;								   
	Zi_UINT32 Fv13=  79680;								   
	Zi_UINT32 Fv21=  112500;								   
	Zi_UINT32 Fv22=  159400;								  
	Zi_UINT32 Fv23=  225000;								  
	Zi_UINT32 Fv31=  318700;								  
	Zi_UINT32 Fv32=  450000;								  
	Zi_UINT32 Fv33=  637500;								  
	Zi_UINT32 Fu1= 635;								  
	Zi_UINT32 Fu2= 900;								  
	Zi_UINT32 FL1= 1300;								 
	Zi_UINT32 FL2= 1800;								 
	Zi_UINT32 FS=  2700;								 
	Zi_UINT32 Fref=  26;  // F_ref(MHz)				  
	Zi_UINT8 Scal= 18;  // Bit Num of Fractional-N of PLL  
	Zi_UINT8 reg_val;
	Zi_UINT8 reg_val_11,reg_val_12,reg_val_13;
	Zi_UINT32 VCO_SEL;
	Zi_UINT32 Fvco;
	Zi_UINT8 nDiv2,nDiv1,frac3,frac2,frac1;

	Zi_UINT32 quotientN,quatientFrac;

	Zi_UINT8 lo_path_1_2=0;
	Zi_UINT8 lo_path_4_3=0;
	Zi_UINT8 lo_path_5_7=0;
	Zi_UINT32 tick = 0;
	Zi_UINT32 tmp_tick = 0;
	Zi_RETURN_CODE eRtnCode = Zi_GENERAL_ERROR;

	if (NULL == hDevice)
	{
		return Zi_GENERAL_ERROR;
	}


	Flo = freqHz/1000;//KHz

	/*band sel*/
	if((Flo< Fv11)&&(Flo>28120))
	{
		lo_path_1_2=2;
		lo_path_4_3=0;
		lo_path_5_7=1;
		Fvco = Flo*128;
	}
	else if((Flo< Fv12))  /*VHF*/
	{   
		lo_path_1_2=1;
		lo_path_4_3=0;
		lo_path_5_7=1;
		Fvco = Flo*96;
	}
	else if((Flo<Fv13))		  /////// VHF //////////
	{  
		lo_path_1_2=2;
		lo_path_4_3=0;
		lo_path_5_7=2;
		Fvco = Flo*64;
	}
	else if((Flo<Fv21))		  /////// UHF //////////
	{
		lo_path_1_2=1;
		lo_path_4_3=0;
		lo_path_5_7=2;
		Fvco = Flo*48;
	}
	else if((Flo<Fv22))		   /////// UHF //////////
	{
		lo_path_1_2=2;
		lo_path_4_3=0;
		lo_path_5_7=4;
		Fvco = Flo*32;
	}
	else if((Flo<Fv23))		/////// LBand ////////
	{
		lo_path_1_2=1;
		lo_path_4_3=0;
		lo_path_5_7=4;	
		Fvco = Flo*24;
	}
	else if((Flo<Fv31))
	{
		lo_path_1_2=2;
		lo_path_4_3=2;
		lo_path_5_7=0;
		Fvco = Flo*16;
	}
	else if ((Flo<Fv32))
	{
		lo_path_1_2=1;
		lo_path_4_3=2;
		lo_path_5_7=0; 
		Fvco = Flo*12;
	}
	else if((Flo<Fv33))
	{
		lo_path_1_2=2;
		lo_path_4_3=1;
		lo_path_5_7=0; 
		Fvco = Flo*8;
	}
	else 
	{
		lo_path_1_2=1;
		lo_path_4_3=1;
		lo_path_5_7=0;
		Fvco = Flo*6;
	}  
	/* else
	{
	return Zi_RTN_FAIL;
	}*/
	reg_val_11 = 0xfc|lo_path_1_2;
	reg_val_13 = 0x1f&(lo_path_4_3<<3|lo_path_5_7);

	//icp config
	VCO_SEL = 5427;

	if((Fvco/1000<3631))
		VCO_SEL = 5427;
	else if((Fvco/1000<3796))
		VCO_SEL = 5042;
	else if((Fvco/1000<3971))
		VCO_SEL = 4643;
	else if ((Fvco/1000<4293))
		VCO_SEL = 4184;
	else if((Fvco/1000<4528))
		VCO_SEL = 3501;
	else if((Fvco/1000<4777))
		VCO_SEL = 3318;
	else if((Fvco/1000 <5164))
		VCO_SEL = 2946;
	else if(Fvco/1000 <5431)
		VCO_SEL = 2516;
	else 
		VCO_SEL = 2351;

	reg_val = (VCO_SEL*774+1000)/(Fref*1000*20) -3;
	//VCO 0x21 Setting
	reg_val = 0x40+reg_val;

	// Fractional-N PLL Settings	
	Zi_DivToUint24(Fvco, Fref*1000,&quotientN,&quatientFrac);

	/* 24bits quatientFrac */
	quatientFrac += 1;
	quatientFrac = quatientFrac>>1;
	nDiv2 = (Zi_UINT8)(quotientN>>8);
	nDiv1 = (Zi_UINT8)quotientN;
	frac3 = (Zi_UINT8) ((quatientFrac>>16) & 0xff); 
	frac2 = (Zi_UINT8) (quatientFrac >> 8)  & 0xff;	
	frac1 = (Zi_UINT8) (quatientFrac & 0xff);

	Zi_WriteTunerReg(hDevice,0x02,0x00); 
	Zi_WriteTunerReg(hDevice,0x12,0x05); 
	Zi_WriteTunerReg(hDevice,0x2d,0x28);  
	Zi_WriteTunerReg(hDevice,0x1e,0x10);

	Zi_WriteTunerReg(hDevice,0x10,reg_val); 

	Zi_WriteTunerReg(hDevice,0x11,(reg_val_11 & 0xef)); 
	Zi_WriteTunerReg(hDevice,0x13,reg_val_13);  

	Zi_WriteTunerReg(hDevice,0x14,nDiv2);
	Zi_WriteTunerReg(hDevice,0x15,nDiv1);
	Zi_WriteTunerReg(hDevice,0x16,frac3);
	Zi_WriteTunerReg(hDevice,0x17,frac2);
	Zi_WriteTunerReg(hDevice,0x18,frac1);


	Zi_WriteTunerReg(hDevice,0x19,0x00);
	Zi_WriteTunerReg(hDevice,0x1a,0x01); // afc setup
	Zi_WriteTunerReg(hDevice,0x1b,0x02); // afc thr
	Zi_WriteTunerReg(hDevice,0x1d,0x08); // afc_unlocknum 0x20 ---> 0x08 by jzhang
	//Zi_WriteTunerReg(hDevice,0x1e,0x10); // afc_locknum

	Zi_WriteTunerReg(hDevice,0x00,0x0d);
	Zi_Sleep(hDevice,25);
	Zi_WriteTunerReg(hDevice,0x00,0x0f);
	Zi_Sleep(hDevice,25);

	Zi_WriteTunerReg(hDevice, 0x03,0x08);//en afc

	tick = Zi_GetTickCount(hDevice);
	while(Zi_GetTickCount(hDevice) - tick < 2000)
	{
		tmp_tick = Zi_GetTickCount(hDevice);
		while(Zi_GetTickCount(hDevice) - tmp_tick < 100)
		{
			Zi_ReadTunerReg(hDevice, 0x6d, &reg_val);

			if(0xc0==(reg_val&0xc0)) //restart afc
			{
				Zi_log("Tuner 0x6d is: 0x%x!", reg_val);
				break;
			}  

		}
		if(0xc0==(reg_val&0xc0)) 
		{
			eRtnCode = Zi_RTN_OK;
			break;

		}

		Zi_WriteTunerReg(hDevice,0x02,0x03); 
		Zi_WriteTunerReg(hDevice,0x02,0x00); 
		Zi_WriteTunerReg(hDevice,0x02,0x00);
		Zi_WriteTunerReg(hDevice,0x02,0x00);
		Zi_WriteTunerReg(hDevice, 0x03,0x08);//start AFC_FSM, system	   
		Zi_log("Restart AFC, Tuner 0x6d is: 0x%x!\n",reg_val);

	}

	Zi_Sleep(hDevice, 25);

	return eRtnCode;
}

////////////////////////////////////////////////////////////////////////
Zi_UINT8 Zi_DivToUint24(Zi_UINT32 inDividend,
			Zi_UINT32 inDivisor,
			Zi_UINT32 * outQuotientN,
			Zi_UINT32 * outQuatientFrac)
{

	Zi_UINT32 remainder;
	Zi_UINT32 quotientN;
	Zi_UINT32 quatientFrac;
	/*Zi_UINT8  fracPosi;*/
	Zi_UINT8 i;
	/*Zi_UINT8 j;*/
	Zi_UINT32 divisor  = inDivisor;
	Zi_UINT32 dividend = inDividend;	   
	Zi_UINT8 scale= 18;
	if (0 == divisor)
	{
		return 0;
	} 

	quotientN = dividend/divisor;

	remainder = dividend - quotientN*divisor;

	/* @here remainder < divisor */
	if (remainder>=0x80000000)
	{
		remainder = remainder >> 1;
		divisor   = divisor >> 1;
	}

	/* @here remainder <= divisor */
	quatientFrac = 0;

	if (remainder != divisor)
	{
		for (i=0;i<(scale+1);i++)
		{
			remainder = remainder<<1;	/* remainder *= 2; */

			if (remainder >= divisor)
			{
				quatientFrac += 1;	   /* BS_ (quatientFrac,bit0) */
				remainder -= divisor;
			}

			quatientFrac = quatientFrac<<1;
		} 

		if(0xffffff==quatientFrac)
		{
			quotientN++;
			quatientFrac = 0;
		}
		else
		{
			quatientFrac = (quatientFrac+1)>>1;
		}
	}
	else   /* remainder == divisor */
	{
		quotientN++;
		quatientFrac = 0;
	}

	*outQuotientN = quotientN;
	*outQuatientFrac = quatientFrac;

	return 1;
}

////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_Sleep(Zi_HANDLE hDevice, Zi_INT32 milliSeconds)
{
	if(hDevice == NULL || milliSeconds <= 0)
		return Zi_GENERAL_ERROR;

	if(milliSeconds >= 5)
	{
		Zi_UINT32 tick = Zi_GetTickCount(hDevice);
		while(Zi_GetTickCount(hDevice) - tick < (Zi_UINT32)milliSeconds);
	}

	if(milliSeconds % 5 > 0)
	{
		Zi_INT32 i;
		//assume Zi_GetTickCount cost 1 ms?
		for(i = 0; i < milliSeconds % 5; i++)
			Zi_GetTickCount(hDevice);
	}
	return Zi_RTN_OK;
}

/////////////////////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_LockFrequency(Zi_HANDLE hDevice, Zi_UINT32 nFreqhz, Zi_UINT32 nTimeOut)
{
	Zi_DEVICE_HANDLE* pDevice = (Zi_DEVICE_HANDLE*) hDevice;
	Zi_RETURN_CODE eRtnCode = Zi_GENERAL_ERROR;	
	Zi_UINT32 nStartTime = 0;

	if (NULL == pDevice)
	{
		return Zi_GENERAL_ERROR;
	}

	Zi_ResetDevice(pDevice);

	Zi_log("Begin to search ________%d_______ KHz!\n", nFreqhz/1000);
	eRtnCode = Zi_SetTunerFreq(pDevice, nFreqhz);
	if(Zi_RTN_OK != eRtnCode)
	{
		Zi_log("Tune Freq error!\n");
		return eRtnCode;
	}	


	if(Zi_RTN_OK != Zi_SyncSignal(pDevice))
	{
		pDevice->bSystemLockStatus = FALSE;
		return Zi_GENERAL_ERROR;		 
	}

	nStartTime = Zi_GetTickCount(pDevice);
	while(Zi_GetTickCount(pDevice) < (nStartTime + nTimeOut))
	{
		eRtnCode = Zi_IsSignalLocked(pDevice);
		switch(eRtnCode)
		{
		case Zi_RTN_OK:
			pDevice->bSystemLockStatus = TRUE;
			pDevice->nCurrentFreqkhz = nFreqhz/1000;
			Zi_log("End to search ________%d_______ KHz!\n", nFreqhz/1000);
			return Zi_RTN_OK;
			break;
		case Zi_POLLING_STATUS:
			//do nothing, remain current state.
			break;
		case Zi_CLCHCRC_FAIL:			   
			break;
		case Zi_FTS_FAIL_INT:
		case Zi_TIME_OUT:
		case Zi_FTS_FAIL_CURRENT:
			pDevice->bSystemLockStatus = FALSE;
			Zi_log("End to search ________%d_______ KHz!\n", nFreqhz/1000);
			return eRtnCode; 
			break;

		default:
			break;		  	
		}
	}

	return eRtnCode;	
}
/////////////////////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_IsSignalLocked(Zi_HANDLE hDevice)
{
	Zi_DEVICE_HANDLE* pDevice = (Zi_DEVICE_HANDLE*) hDevice;
	Zi_UINT8 syncStatus,theChipStatus = 0;
	Zi_UINT8 hicIntStatus = 0;
	Zi_UINT8 miscIntStatus = 0;
	Zi_UINT8 crcStatus = 0;
	Zi_UINT8 tsdStatus = 0;
	static Zi_UINT32 nTimes = 0;
	Zi_UINT32 tm = 0;

	if (NULL == hDevice)
	{
		return Zi_GENERAL_ERROR;
	}

	Zi_ReadReg(pDevice, REG_CLP_STATUS, &syncStatus);

	if(0 != syncStatus)
	{
		//Zi_WriteReg(pDevice,REG_RF_MISC, 0x1D);

		if(REG_AGC_LOCK_BIT != (syncStatus & REG_AGC_LOCK_BIT))
		{
			Zi_log("AGC lock fail!\n");			   
		}

		if(REG_AGC_TIMEOUT_BIT == (syncStatus & REG_AGC_TIMEOUT_BIT))
		{
			Zi_log("AGC timeout!\n");			   
		}

		if (REG_FTS_FAIL_BIT == (syncStatus & REG_FTS_FAIL_BIT))
		{
			Zi_log("fts fail, sync status:0x%x!\n",syncStatus);
			return Zi_FTS_FAIL_INT;
		} 

		if (REG_FTS_PASS_BIT == (syncStatus & REG_FTS_PASS_BIT))
		{
			Zi_ReadReg(pDevice, REG_MISC_INT_STATUS, &miscIntStatus);
			Zi_ReadRegFields(pDevice,REG_TSD_STAT,6,1,&tsdStatus);
			if(REG_FDP_IR_TSD_FAIL_STATUS_BIT == (miscIntStatus&REG_FDP_IR_TSD_FAIL_STATUS_BIT))
			{
				Zi_WriteReg(pDevice, REG_MISC_INT_CLEAR, REG_FDP_IR_TSD_FAIL_CLEAR_BIT);
				Zi_log("TSD fail!  int status:0x%x!, sync status:0x%x!\n" , miscIntStatus, syncStatus);			
				return Zi_FTS_FAIL_INT;			   
			}
			else if (tsdStatus == 1)
			{
				Zi_log("TSD done!  sync status:0x%x, int status:0x%x!\n" , syncStatus, miscIntStatus);  
				return Zi_RTN_OK;
			}
			else
			{
				if(pDevice->nRefTick != 0) 
				{				
					if((Zi_GetTickCount(pDevice) - pDevice->nRefTick) > 500)
					{
						Zi_log("sync status:0x%x, tsd timeout at %d!\n" ,syncStatus, Zi_GetTickCount(hDevice));
						return Zi_TIME_OUT;
					}
					return Zi_POLLING_STATUS;

				}
				else
				{
					pDevice->nRefTick = Zi_GetTickCount(pDevice);
					return Zi_POLLING_STATUS;
				}				

			}
		}
		if(pDevice->nRefTick != 0) 
		{
			Zi_ReadReg(pDevice, REG_CLP_STATUS, &syncStatus);			 
			if((Zi_GetTickCount(pDevice) - pDevice->nRefTick) > 2000)
			{
				if(0x8 == syncStatus)
				{  
					tm = Zi_GetTickCount(pDevice);
					while(Zi_GetTickCount(pDevice) - tm < 1000)
					{
						Zi_ReadReg(pDevice, REG_CLP_STATUS, &syncStatus);
						if(0x8 != syncStatus)
						{
							pDevice->nRefTick = 0;
							theChipStatus = 1;
							break;
						}
					}
				}

				if(0 == theChipStatus)
				{
					Zi_SyncSignal(pDevice);
					Zi_Sleep(pDevice,2000);
					Zi_ReadReg(pDevice, REG_CLP_STATUS, &syncStatus);
					if (0x8 == syncStatus)
					{
						Zi_log("IC hang up, sync status:0x%x!\n", syncStatus);
						return Zi_TIME_OUT;  
					}
				}

			}
		}
		else
		{
			pDevice->nRefTick = Zi_GetTickCount(hDevice);
			return Zi_POLLING_STATUS;	
		}
	}
	return Zi_POLLING_STATUS;
}

/////////////////////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_ResetDevice(Zi_HANDLE hDevice)
{
	Zi_DEVICE_HANDLE *pDevice = (Zi_DEVICE_HANDLE *) hDevice;

	if (NULL == pDevice)
	{
		return Zi_GENERAL_ERROR;
	}
	
	Zi_WriteReg(pDevice, REG_AGC_MISC2_CTRL, 0x0e); // bypass RF holdAGC function for RF adjust gain
	//Zi_WriteRegFields(hDevice,REG_AGC_MISC_CTRL,6,2,3); 

	Zi_WriteTunerReg(pDevice, 0x2, 0x00); // release RF holdagc for RF  gain adjust   

	Zi_WriteReg(pDevice, REG_SOFT_RST, 0x50); //soft reset all module but TIC

	Zi_Sleep(pDevice,15);						   
	Zi_WriteReg(pDevice, REG_SOFT_RST, 0x40); //soft reset all module but TIC

	pDevice->nTickSaved = 0;
	Zi_WriteReg(pDevice, REG_SOFT_RST, 0XFF); //soft reset all module but TIC

	//Zi_WriteRegFields(hDevice,REG_AGC_MISC_CTRL,6,2,0);

	/* clear all interrupt */
	Zi_WriteReg(pDevice, REG_HIC1_INT_CLEAR, 0xff);

	Zi_WriteReg(pDevice, REG_HIC2_INT_CLEAR, 0xff);

	Zi_WriteReg(pDevice, REG_OTDD_INT_CLEAR, 0xff);

	Zi_WriteReg(pDevice, REG_MISC_INT_CLEAR, 0xff);

	Zi_log("Reset device ok!\n");
	return Zi_RTN_OK;
}

/////////////////////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_InitDevice(Zi_HANDLE hDevice)
{
	Zi_DEVICE_HANDLE* pDevice = (Zi_DEVICE_HANDLE*) hDevice;

	if (NULL == pDevice)
	{
		return Zi_GENERAL_ERROR;
	}

	Zi_WriteReg(pDevice,REG_LDPC_CONFIG,0x30);  // iter num SC valid,set all SC enable
	Zi_WriteRegFields(pDevice, REG_SC_INFO_C, 0x3, 3, 0x0); // set sc5 QAM and code rate
	Zi_WriteReg(pDevice, REG_SC5_BGN_SLOT, 0); // sc5 begin slot
	Zi_WriteReg(pDevice, REG_SC5_NUM, 1); // sc5 begin slot num
	Zi_WriteReg(pDevice, REG_AGC_MISC_CTRL, 0x1d); // AGC parameter set alpha coeff is 1
	//Zi_WriteReg(pDevice, REG_SC4_SC5_THR, 0x01);
	Zi_WriteRegFields(pDevice,REG_SC4_SC5_THR, 0, 4, 0x01); //THD to report interrupt when data full
	//Zi_WriteRegFields(pDevice, REG_SC_VALID_MISC, 0x5, 1, 1); // close TS0
	Zi_WriteRegFields(pDevice, REG_LDPC_CONFIG, 0, 1, 0x1); // custom set LDPC iteration limit

	//Zi_WriteReg(pDevice, REG_LDPC_STA_SIZE, 0x01);

	Zi_WriteReg(pDevice, REG_OTDD_MISC_CTRL, 0x03); // set SC5 as the CLCH

	Zi_log("Init device ok!\n");
	return Zi_RTN_OK;
}

/////////////////////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_SyncSignal(Zi_HANDLE hDevice)
{
	Zi_DEVICE_HANDLE* pDevice = (Zi_DEVICE_HANDLE*) hDevice;
	Zi_RETURN_CODE eRtnCode = Zi_RTN_OK;
	Zi_UINT32 time;
	Zi_UINT8 i=0;

	if (NULL == hDevice)
	{
		return Zi_GENERAL_ERROR;
	}
	
	time = Zi_GetTickCount(hDevice);

	Zi_ResetDevice(pDevice);
	Zi_InitDevice(pDevice);
	
	/* CTS Init */
	Zi_WriteReg(pDevice, REG_STC_PAR_TH, 0x42);  // STC thld  papr = 50
	Zi_WriteReg(pDevice, REG_STC_MISC, 0x95);  // enable STC notch and set to auto mode
	Zi_WriteReg(pDevice, REG_INITIAL, 0x1); 

	pDevice->nRefTick = 0;

	//Zi_WriteTunerReg(hDevice, 0x02,0x00);
	//Zi_WriteRegFields(hDevice,REG_AGC_MISC2_CTRL,3,1,0); //release RF holdAGC function for RF adjust gain 
	Zi_WriteReg(pDevice, REG_AGC_MISC2_CTRL, 0x02);
	return Zi_RTN_OK;
}

/////////////////////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_OpenCLCHService(Zi_HANDLE hDevice)
{
	Zi_RETURN_CODE eRtnCode = Zi_RTN_OK;
	Zi_DEVICE_HANDLE* pDevice = (Zi_DEVICE_HANDLE*)hDevice;

	if (NULL == pDevice)
	{
		return Zi_GENERAL_ERROR;
	}

	if (pDevice->bCLCHEnable == FALSE)
	{
		pDevice->bCLCHEnable = TRUE;
		Zi_SetMemForService(pDevice, 1, 5);
		Zi_WriteRegFields(pDevice, REG_SC_VALID_MISC, 5, 1, 1);
		pDevice->ActiveService[5].nActiveServiceID = 0xffff;
	}

	Zi_SetLDPCRSWindow(pDevice);
	Zi_SetSFOAheadSlot(pDevice);

	return eRtnCode;
}

/////////////////////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_StopCLCHService(Zi_HANDLE hDevice)
{
	Zi_RETURN_CODE eRtnCode = Zi_RTN_OK;
	Zi_DEVICE_HANDLE* pDevice = (Zi_DEVICE_HANDLE*) hDevice;
	Zi_UINT8 regVal = 0;

	if (NULL == pDevice)
	{
		return Zi_GENERAL_ERROR;
	}

	pDevice->bCLCHEnable = FALSE;
	Zi_ReadReg(pDevice, REG_SC_VALID_MISC, &regVal);
	if ((regVal & 0x3f) != 0x20)
	{
		Zi_WriteRegFields(pDevice, REG_SC_VALID_MISC,  5, 1, 0x0);
		Zi_WriteRegFields(pDevice, REG_OTDD_INT_CLEAR, 5, 1, 0x1);
		Zi_WriteRegFields(pDevice, REG_HIC1_INT_CLEAR, 5, 1, 0x1);
		Zi_WriteRegFields(pDevice, REG_SC5_CONFIG_B,   0, 5, 0x0);
		Zi_WriteRegFields(pDevice, REG_SC5_CONFIG_A,   0, 5, 0x0);
		pDevice->ActiveService[5].nActiveServiceID = 0x0;
	}

	Zi_SetLDPCRSWindow(pDevice);
	Zi_SetSFOAheadSlot(pDevice);
	return eRtnCode;
}


/////////////////////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_PlayService(Zi_HANDLE hDevice, Zi_UINT32 serviceID, Zi_UINT32 *channelNum)
{
	Zi_RETURN_CODE eRtnCode = Zi_RTN_OK;
	Zi_UINT8 i;
	Zi_UINT8 channelIndex;
	Zi_UINT8 regVal = 0;
	static Zi_UINT8 nRealChStartIndex = 0;
	Zi_DEVICE_HANDLE *pDevice = (Zi_DEVICE_HANDLE *)hDevice;

	if (NULL == pDevice)
	{
		return Zi_GENERAL_ERROR;
	}

	for(i = 0; i < 5; i++)
	{
		if(pDevice->ActiveService[i].nActiveServiceID == serviceID)
		{
			Zi_log("This service already open!\n");
            		return Zi_RTN_OK;
		}
	}
	for(i = 0; i < 5; i++)
	{
		channelIndex = nRealChStartIndex + i;
		if(channelIndex >= 5)
			channelIndex = channelIndex - 5;
		if(pDevice->ActiveService[channelIndex].nActiveServiceID == 0)
		{			
			//close clch to save power
			Zi_ReadReg(pDevice, REG_SC_VALID_MISC, &regVal);
			Zi_log("REG_SC_VALID_MISC = 0x%x\n", regVal);
			if ((regVal & 0x20) && ((pDevice->bCLCHEnable == FALSE) || (regVal & 0x1f)))
			{
				Zi_WriteRegFields(pDevice, REG_SC_VALID_MISC,  5, 1, 0x0);
				Zi_ReadReg(pDevice, REG_SC_VALID_MISC, &regVal);
				Zi_log("Close CLCH channel, REG_SC_VALID_MISC = 0x%x\n", regVal);
				Zi_WriteRegFields(pDevice, REG_OTDD_INT_CLEAR, 5, 1, 0x1);
				Zi_WriteRegFields(pDevice, REG_HIC1_INT_CLEAR, 5, 1, 0x1);
				Zi_WriteRegFields(pDevice, REG_SC5_CONFIG_B,   0, 5, 0x00);
				Zi_WriteRegFields(pDevice, REG_SC5_CONFIG_A,   0, 5, 0x00);
				pDevice->ActiveService[5].nActiveServiceID = 0x0;
			}

			eRtnCode = Zi_ConfigService(pDevice, serviceID, channelIndex);
			if (Zi_RTN_OK != eRtnCode)
			{
				return Zi_GENERAL_ERROR;
			}
			eRtnCode = Zi_TrigeServiceReceive(pDevice, serviceID, channelIndex);
			if (Zi_RTN_OK != eRtnCode)
			{
				Zi_log("Trigle service receive err!!!\n");
				return Zi_GENERAL_ERROR;
			}
			pDevice->ActiveService[channelIndex].nActiveServiceID = serviceID;
			nRealChStartIndex = nRealChStartIndex < 4 ? (nRealChStartIndex + 1) : 0;
			break;
		}
	}

	if(i == 5)
	{
		Zi_log("No more service channel can be used!!!\n");
		return Zi_GENERAL_ERROR;
	}

	*channelNum = channelIndex;

	Zi_SetLDPCRSWindow(pDevice);

	Zi_SetSFOAheadSlot(pDevice);

	return eRtnCode;
}

/////////////////////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_StopService(Zi_HANDLE hDevice, Zi_UINT32 serviceID)
{
	Zi_DEVICE_HANDLE* pDevice = (Zi_DEVICE_HANDLE*) hDevice;
	Zi_UINT8 i = 0;
	Zi_UINT8 channelIndex;
	Zi_UINT8 serviceNum = 0, regVal;
	Zi_UINT8* m_regTable = 0;

	if (NULL == pDevice)
	{
		return Zi_GENERAL_ERROR;
	}

	for(i = 0; i < 5; i++)
	{
		if(pDevice->ActiveService[i].nActiveServiceID == serviceID)
		{
			channelIndex = i;

			pDevice->ActiveService[channelIndex].nActiveServiceID = 0;
						
			//todo: set register to stop service receiving.
			//sc valid disable
			Zi_WriteRegFields(pDevice, REG_SC_VALID_MISC, channelIndex, 1 ,0x0);
			m_regTable = Zi_scConfigRegTable[channelIndex];
			m_regTable++;
			Zi_WriteRegFields(pDevice, *m_regTable, 0, 5, 0x00);
			m_regTable++;
			Zi_WriteRegFields(pDevice, *m_regTable, 0, 5, 0x00);
			m_regTable++;
			if (channelIndex%2 == 0)
				Zi_WriteRegFields(pDevice, *m_regTable, 4, 4, 0x00);
			else
				Zi_WriteRegFields(pDevice, *m_regTable, 0, 4, 0x00);
			m_regTable = Zi_scRegTable[channelIndex];
			if (channelIndex%2 == 0)
				Zi_WriteRegFields(pDevice,  *m_regTable, 0 ,3, 0x00);
			else
				Zi_WriteRegFields(pDevice,  *m_regTable, 3 ,3, 0x00);
			m_regTable++;
			Zi_WriteReg(pDevice, *m_regTable, 0x00);
			m_regTable++;
			Zi_WriteReg(pDevice, *m_regTable, 0x00);
			
			Zi_WriteRegFields(pDevice, REG_HIC1_INT_CLEAR, channelIndex, 1, 0x1);		

			break;
		}
	}
	if(i == 5)
	{
		Zi_log("Try to stop service which not existed!\n");
		return Zi_RTN_OK;
	}

	Zi_ReadReg(pDevice, REG_SC_VALID_MISC, &regVal);
	Zi_log("REG_SC_VALID_MISC = 0x%x\n", regVal);
	for(i = 0; i < 5; i++)
	{
		if((regVal >> i) & 0x01)
			serviceNum++;
	}
	Zi_log("Open service number = %d\n", serviceNum);
	if(((regVal & 0x3f) == 0x00) || ((serviceNum == 1) && (pDevice->bCLCHEnable == TRUE) && ((regVal & 0x20) == 0x00)))
	{
		Zi_SetMemForService(pDevice, 1, 5);
		Zi_WriteRegFields(pDevice, REG_SC_VALID_MISC, 5, 1, 0x01);
		pDevice->ActiveService[5].nActiveServiceID = 0xffff;
	}
	
	Zi_SetLDPCRSWindow(pDevice);
	Zi_SetSFOAheadSlot(pDevice);

	return Zi_RTN_OK;
}


/////////////////////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_GetTs0Data(Zi_HANDLE hDevice, Zi_UINT8 *pbuffer, Zi_UINT32 bufferlen)
{
	Zi_DEVICE_HANDLE *pDevice = (Zi_DEVICE_HANDLE *) hDevice;
	Zi_RETURN_CODE eRtnCode = Zi_RTN_OK;
	Zi_UINT8    m_intOverflow = 0;

	if (NULL == pDevice)
	{
		return Zi_GENERAL_ERROR;
	}

	if(0 == bufferlen)
	{
		Zi_WriteRegFields(pDevice, REG_HIC1_INT_CLEAR, 5, 1, 0x1);
		Zi_log("Clch data length:%d\n", bufferlen);
		return Zi_GENERAL_ERROR;
	}

	Zi_WriteRegFields(pDevice, REG_HIC1_INT_CLEAR, 5, 1, 0x1);
	 
	Zi_ReadReg(pDevice, REG_OTDD_INT_STATUS, &m_intOverflow);		
	if(m_intOverflow & 0x20)
	{
		Zi_log("Clch data overflow intr:%x\n", m_intOverflow);
		Zi_WriteRegFields(pDevice, REG_OTDD_INT_CLEAR, 5, 1, 0x1);
	}

	eRtnCode = Zi_BurstRead(pDevice, Zi_dataReg[5], bufferlen, pbuffer);
	if(Zi_RTN_OK != eRtnCode)
	{
		Zi_log("Spi read data err!\n");
		return Zi_GENERAL_ERROR;
	}
	
	return eRtnCode;
}

/////////////////////////////////////////////////////////////////////////////////////////
Zi_CMMB_INT_TYPE Zi_GetCurState(Zi_HANDLE hDevice, Zi_UINT32 *pbufferlen, Zi_UINT8 *channelNum)
{
	Zi_DEVICE_HANDLE *pDevice = (Zi_DEVICE_HANDLE *)hDevice;
	Zi_UINT8 HIC1IntStatus, HIC2IntStatus, OTDDIntStatus, MISCIntStatus, SCCIntStatus;
	Zi_UINT8 shiftNum = 0x01;
	Zi_UINT16 m_hdataCount = 0;
	Zi_UINT8 m_ldataCount = 0;
	Zi_UINT8 m_intOverflow = 0;
	Zi_UINT8 i;

	if (NULL == hDevice)
	{
		return Zi_GENERAL_ERROR;
	}

	Zi_irq_level(2);

	Zi_EnableInt(pDevice, 0);
	
	Zi_irq_level(2);
	
	Zi_ReadReg(pDevice, REG_HIC1_INT_STATUS, &HIC1IntStatus);
	Zi_ReadReg(pDevice, REG_HIC2_INT_STATUS, &HIC2IntStatus);
	Zi_ReadReg(pDevice, REG_OTDD_INT_STATUS, &OTDDIntStatus);
	Zi_ReadReg(pDevice, REG_MISC_INT_STATUS, &MISCIntStatus);
	Zi_ReadReg(pDevice, REG_SCC_INT_STATUS, &SCCIntStatus);
	Zi_log("INT_STATUS = 0x%x, 0x%x, 0x%x, 0x%x, 0x%x\n", HIC1IntStatus, HIC2IntStatus, OTDDIntStatus, MISCIntStatus, SCCIntStatus);

	if(SCCIntStatus & 0x0f)
	{
		return Zi_CMMB_SCC_TRANS_INT;
	}

	if(REG_HIC_IR_TIMEOUT_STATUS_BIT == (OTDDIntStatus & REG_HIC_IR_TIMEOUT_STATUS_BIT))
	{
		return Zi_CMMB_TIMEOUT_INTERRUPT;
	}
	
	for(i = 0; i < 6; i++)
	{
		if(HIC1IntStatus & shiftNum)
		{
			Zi_ReadReg(pDevice, Zi_dataAvailReg[i][0], (Zi_UINT8*)&m_hdataCount);
			Zi_ReadReg(pDevice, Zi_dataAvailReg[i][1], &m_ldataCount);
			*pbufferlen = ((m_hdataCount<<8)+ m_ldataCount)*4;
			*channelNum = i;
			return Zi_CMMB_SC_DAT_RDY;
		}
		shiftNum <<= 1;
	}
	
	return Zi_CMMB_UNSUPPORT_INT;
}

/////////////////////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_ConfigService(Zi_HANDLE hDevice, Zi_UINT32 serviceID, Zi_UINT8 channelIndex)
{
	Zi_UINT8  i,j = 0;
	Zi_UINT32 m_uBuffLenth = 0;
	Zi_UINT8  m_qamType = 0;
	Zi_UINT8  m_inerleaveMode = 0;
	Zi_UINT8  m_rsmode = 0;
	Zi_UINT8  m_DeblocNum = 0;
	Zi_UINT8  m_cuurStartBlk = 0;
	Zi_UINT8  m_schDataThr = 0;	
	Zi_UINT8* m_regTable = 0;
	Zi_DEVICE_HANDLE *pDevice = (Zi_DEVICE_HANDLE *)hDevice;
	Zi_CMMBSERVICE_INFO* pCmmbServiceInfo = NULL;

	if (NULL == pDevice || !pDevice->pDemuxerPrivateStruct)
	{
		return Zi_GENERAL_ERROR;
	}	

	//Get service info handle  
	pCmmbServiceInfo = ((Zi_DEMUXER_CONTEXT*)pDevice->pDemuxerPrivateStruct)->pSeviceChannelList;
	for(i = 0; i < ((Zi_DEMUXER_CONTEXT*)pDevice->pDemuxerPrivateStruct)->nServiceCount; i++)
	{
		if (serviceID == pCmmbServiceInfo->ServiceID_Cmct)
		{
			break;
		}
		pCmmbServiceInfo++;
	}
	if(i == ((Zi_DEMUXER_CONTEXT*)pDevice->pDemuxerPrivateStruct)->nServiceCount)
		return Zi_GENERAL_ERROR;

	Zi_log("ServiceId = %d: %d, %d, %d, %d, %d, %d\n", serviceID, pCmmbServiceInfo->RsDecodeType_Cmct, 
		pCmmbServiceInfo->ByteInterleaveMode_Cmct, pCmmbServiceInfo->LDPCRate_Cmct,
		pCmmbServiceInfo->ModulateType_Cmct, pCmmbServiceInfo->TsCount_Cmct, pCmmbServiceInfo->TsStartNumber_Cmct);

	//set qam type
	m_regTable = Zi_scConfigRegTable[channelIndex];
	switch(pCmmbServiceInfo->ModulateType_Cmct)
	{
		case Zi_MODULATE_TYPE_BPSK:  //BPSK
			if (channelIndex%2 == 0)
			{
				Zi_WriteRegFields(pDevice, *m_regTable, 0, 2, 0x00);
			}
			else
			{
				Zi_WriteRegFields(pDevice, *m_regTable, 3 , 2, 0x00);
			}
			Zi_WriteReg(pDevice, REG_OUT_SEL, 0x05); 
			m_qamType = 1;
			break;
		case Zi_MODULATE_TYPE_QPSK:  //QPSK
			if (channelIndex%2 == 0)
			{
				Zi_WriteRegFields(pDevice, *m_regTable, 0, 2, 0x01);
			}
			else
			{
				Zi_WriteRegFields(pDevice, *m_regTable, 3, 2, 0x01);
			}
			Zi_WriteReg(pDevice, REG_OUT_SEL, 0x05); 
			m_qamType = 2;
			break;
		case Zi_MODULATE_TYPE_16QAM: //16QAM
			if (channelIndex%2 == 0)
			{
				Zi_WriteRegFields(pDevice, *m_regTable, 0, 2, 0x02);
			}
			else
			{
				Zi_WriteRegFields(pDevice, *m_regTable, 3, 2, 0x02);

			}
			Zi_WriteReg(pDevice, REG_OUT_SEL, 0x06);

			m_qamType = 4;
			break;
		default:
			Zi_log("Illegal QamType!\n");
			return Zi_GENERAL_ERROR;
	}
	//set LDPC
	switch(pCmmbServiceInfo->LDPCRate_Cmct)
	{
		case Zi_LDPC_MODE_1_DIV_2:
			if (channelIndex%2 == 0)
			{
				Zi_WriteRegFields(pDevice, *m_regTable, 2, 1, 0x0);
			}
			else
			{
				Zi_WriteRegFields(pDevice, *m_regTable, 5, 1, 0x0);
			}
			break;
		case Zi_LDPC_MODE_3_DIV_4:
			if (channelIndex%2 == 0)
			{
				Zi_WriteRegFields(pDevice, *m_regTable, 2, 1, 0x1);
			}
			else
			{
				Zi_WriteRegFields(pDevice, *m_regTable, 5, 1, 0x1);
			}
			break;
		default:
			Zi_log("Illegal LDPC Type!\n");
			return Zi_GENERAL_ERROR;
	}
	m_regTable++;
	// set de-interleave
	switch(pCmmbServiceInfo->ByteInterleaveMode_Cmct)
	{
		case Zi_INTERLEAVE_MODE_RERSERVE:
		case Zi_INTERLEAVE_MODE_MODE_1:
			Zi_WriteRegFields(pDevice, *m_regTable, 5, 2, 0x01);
			m_inerleaveMode = 1;
			break;
		case Zi_INTERLEAVE_MODE_MODE_2:
			Zi_WriteRegFields(pDevice,  *m_regTable, 5, 2, 0x02);
			m_inerleaveMode = 2;
			break;
		case Zi_INTERLEAVE_MODE_MODE_3:			
			Zi_WriteRegFields(pDevice,  *m_regTable, 5, 2, 0x03);
			m_inerleaveMode = 4;
			break;
		default:
			Zi_log("Illegal Interleave mode!\n");
			return Zi_GENERAL_ERROR;
	}

	m_regTable++;
	//set RS type
	switch(pCmmbServiceInfo->RsDecodeType_Cmct)
	{
		case Zi_RS_MODE_240_240:
			Zi_WriteRegFields(pDevice, *m_regTable, 5, 3, 0x00);
			m_rsmode = 240;
			break;
		case Zi_RS_MODE_240_224:
			Zi_WriteRegFields(pDevice, *m_regTable, 5, 3, 0x01);
			m_rsmode = 224;
			break;
		case Zi_RS_MODE_240_192:
			Zi_WriteRegFields(pDevice, *m_regTable, 5, 3, 0x02);
			m_rsmode = 192;
			break;
		case Zi_RS_MODE_240_176:
			Zi_WriteRegFields(pDevice, *m_regTable, 5, 3, 0x03);
			m_rsmode = 176;
			break;
		default:
			Zi_log("Illegal RS mode!\n");
			return Zi_GENERAL_ERROR;
		//break;
	}
	m_regTable++;
	m_DeblocNum = Zi_CaculateBlockNum(pDevice, serviceID);

	if (!m_DeblocNum)
	{
		Zi_log("Calculate incorrect block nums!\n");
		return Zi_GENERAL_ERROR;
	}
#if 0
	if(Zi_RTN_OK != Zi_FindMemForService(pDevice, m_DeblocNum, &m_cuurStartBlk))
	{
		Zi_log("Service memory bloc is full!\n");
		return Zi_GENERAL_ERROR;
	}
	else
	{
		Zi_log("serviceID = %d,  memory bloc start = %d, memory bloc  = %d\n", serviceID, m_cuurStartBlk, m_DeblocNum);
		Zi_WriteRegFields(pDevice, Zi_scConfigRegTable[channelIndex][2], 0, 5, m_cuurStartBlk);
		Zi_WriteRegFields(pDevice, Zi_scConfigRegTable[channelIndex][1], 0, 5, m_DeblocNum);
	}
#endif	
	if(Zi_RTN_OK != Zi_SetMemForService(pDevice, m_DeblocNum, channelIndex))
	{
		return Zi_GENERAL_ERROR;
	}
	
	m_schDataThr = (pCmmbServiceInfo->TsCount_Cmct * m_qamType) / (2 * m_inerleaveMode);

	if (((pCmmbServiceInfo->TsCount_Cmct * m_qamType) % (2 * m_inerleaveMode) != 0) && (0 == m_schDataThr))	
	{
		m_schDataThr += 1;
	}

	if (channelIndex%2 == 0)
		Zi_WriteRegFields(pDevice, *m_regTable, 4, 4, m_schDataThr);
	else
		Zi_WriteRegFields(pDevice, *m_regTable, 0, 4, m_schDataThr);

	return Zi_RTN_OK;
}

////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_SetMemForService(Zi_HANDLE hDevice, Zi_UINT8 blockNum, Zi_UINT8 channelIndex)
{
	Zi_DEVICE_HANDLE *pDevice = (Zi_DEVICE_HANDLE *)hDevice;
	Zi_UINT8 i = 0;
	Zi_UINT8 m_curStartBlk = 0;

	if(Zi_RTN_OK != Zi_FindMemForService(pDevice, blockNum, &m_curStartBlk))
	{
		Zi_log("Service memory bloc is full!\n");
		return Zi_GENERAL_ERROR;
	}
	else
	{
		Zi_log("Service channel = %d,  memory bloc start = %d, memory bloc  = %d\n", channelIndex, m_curStartBlk, blockNum);
		Zi_WriteRegFields(pDevice, Zi_scConfigRegTable[channelIndex][2], 0, 5, m_curStartBlk);
		Zi_WriteRegFields(pDevice, Zi_scConfigRegTable[channelIndex][1], 0, 5, blockNum);
		return Zi_RTN_OK;
	}

	return Zi_GENERAL_ERROR;
}

////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_TrigeServiceReceive(Zi_HANDLE hDevice, Zi_UINT32 serviceID, Zi_UINT8 channelIndex)
{
	Zi_UINT8 i = 0;//j = 0;
	Zi_UINT8* m_regTable = NULL;
	Zi_DEVICE_HANDLE *pDevice = (Zi_DEVICE_HANDLE *)hDevice;
	Zi_CMMBSERVICE_INFO* pCmmbServiceInfo = NULL;

	if (NULL == pDevice || !pDevice->pDemuxerPrivateStruct)
	{
		return Zi_GENERAL_ERROR;
	}	

	//Get service info handle  
	pCmmbServiceInfo = ((Zi_DEMUXER_CONTEXT*)pDevice->pDemuxerPrivateStruct)->pSeviceChannelList;
	for(i = 0; i < ((Zi_DEMUXER_CONTEXT*)pDevice->pDemuxerPrivateStruct)->nServiceCount; i++)
	{
		if (serviceID == pCmmbServiceInfo->ServiceID_Cmct)
		{
			break;
		}
		pCmmbServiceInfo++;
	}
	if(i == ((Zi_DEMUXER_CONTEXT*)pDevice->pDemuxerPrivateStruct)->nServiceCount)
		return Zi_GENERAL_ERROR;
	
	m_regTable = Zi_scRegTable[channelIndex];
	//clear interrupt
	Zi_WriteRegFields(pDevice, REG_HIC1_INT_CLEAR, channelIndex, 1, 0x1);
	Zi_WriteRegFields(pDevice, REG_OTDD_INT_CLEAR, channelIndex, 1, 0x1);
	//set data interrupt thr;
	//set scramble number
	if(channelIndex % 2 == 0)
		Zi_WriteRegFields(pDevice, *m_regTable, 0, 3, pCmmbServiceInfo->nDisturbMode);
	else
		Zi_WriteRegFields(pDevice, *m_regTable, 3, 3, pCmmbServiceInfo->nDisturbMode);
	m_regTable++;
	//set sc0 begin slot
	Zi_WriteRegFields(pDevice, *m_regTable, 0, 6, pCmmbServiceInfo->TsStartNumber_Cmct);
	m_regTable++;
	//set sc0 slot number
	Zi_WriteRegFields(pDevice, *m_regTable , 0, 6, pCmmbServiceInfo->TsCount_Cmct);

	//set sc valid
	Zi_WriteRegFields(pDevice, REG_SC_VALID_MISC, channelIndex, 1, 0x1);
	return Zi_RTN_OK;
}

////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_CaculateBlockNum(Zi_HANDLE hDevice, Zi_UINT32 serviceID)
{
	Zi_UINT8  i = 0;
	Zi_UINT8  m_qamType = 0;
	//  Zi_UINT8  m_codeRate = 0;
	Zi_UINT8  m_inerleaveMode = 0;
	//  Zi_UINT8  m_rsmode = 0;
	Zi_UINT8  m_DeblocNumPerBY = 0;
	Zi_UINT8  m_TsNum = 0;
	Zi_UINT8  m_DeInerBloc = 0;
	Zi_UINT8  m_memBlocNum = 0;
	Zi_UINT8  m_IDeInterleave = 0;
	Zi_UINT8  m_FDeInterleave = 0;
	Zi_DEVICE_HANDLE *pDevice = (Zi_DEVICE_HANDLE *)hDevice;
	Zi_CMMBSERVICE_INFO* pCmmbServiceInfo = NULL;

	if (NULL == pDevice || !pDevice->pDemuxerPrivateStruct)
	{
		return Zi_GENERAL_ERROR;
	}	

	//Get service info handle  
	pCmmbServiceInfo = ((Zi_DEMUXER_CONTEXT*)pDevice->pDemuxerPrivateStruct)->pSeviceChannelList;
	for(i = 0; i < ((Zi_DEMUXER_CONTEXT*)pDevice->pDemuxerPrivateStruct)->nServiceCount; i++)
	{
		if (serviceID == pCmmbServiceInfo->ServiceID_Cmct)
		{
			break;
		}
		pCmmbServiceInfo++;
	}
	if(i == ((Zi_DEMUXER_CONTEXT*)pDevice->pDemuxerPrivateStruct)->nServiceCount)
		return Zi_GENERAL_ERROR;

	switch(pCmmbServiceInfo->ModulateType_Cmct)
	{
		case 0:
			m_qamType = 1;
			break;
		case 1:
			m_qamType = 2;
			break;
		case 2:
			m_qamType = 4;
			break;
		default:
			Zi_log("Illegal qamType!\n");
	}
	switch(pCmmbServiceInfo->ByteInterleaveMode_Cmct)
	{
		case 0:
		case 1:
			m_inerleaveMode = 1;
			break;
		case 2:
			m_inerleaveMode = 2;
			break;
		case 3:
			m_inerleaveMode = 4;
			break;
		default:
			Zi_log("Illegal Interleave mode!\n");
	}

	m_DeblocNumPerBY = (m_inerleaveMode*2/m_qamType);	 //(m_qamType*1/pCmmbServiceInfo->eInterleaveMode*0.5)
	m_TsNum = pCmmbServiceInfo->TsCount_Cmct;

	if (m_DeblocNumPerBY > 0)
	{
		m_IDeInterleave =  m_TsNum/m_DeblocNumPerBY;		//int
		m_FDeInterleave =  m_TsNum%m_DeblocNumPerBY;		//Fac
	}
	else
	{
		m_IDeInterleave = m_TsNum * 2;
		m_FDeInterleave = 0;
	}

	if (m_IDeInterleave == 0) 
	{
		while (m_IDeInterleave == 0) 
		{
			m_TsNum = m_TsNum + m_FDeInterleave;
			m_IDeInterleave =  m_TsNum / m_DeblocNumPerBY;	  //int
			m_FDeInterleave =  m_TsNum % m_DeblocNumPerBY;	  //Fac
		}
		if (0 == m_FDeInterleave)
			m_DeInerBloc = m_IDeInterleave;
		else
			m_DeInerBloc = m_IDeInterleave + 1;

	}
	else 
	{
		if (0 == m_FDeInterleave)
		{
			m_DeInerBloc = m_IDeInterleave;
		}
		else 
		{
			m_TsNum = m_TsNum + m_FDeInterleave;
			m_IDeInterleave =  m_TsNum / m_DeblocNumPerBY;	  //int
			m_FDeInterleave =  m_TsNum % m_DeblocNumPerBY;	  //Fac
			if (0 == m_FDeInterleave)
				m_DeInerBloc = m_IDeInterleave;
			else
				m_DeInerBloc = m_IDeInterleave + 1;
		}
	}
	switch (m_inerleaveMode)//Byte De-Interleave
	{
		case 1: 
			m_memBlocNum = (pCmmbServiceInfo->LDPCRate_Cmct == 0) ? m_DeInerBloc*2 : m_DeInerBloc*3;
			break;
		case 2: 
			m_memBlocNum = (pCmmbServiceInfo->LDPCRate_Cmct == 0) ? m_DeInerBloc*4 : m_DeInerBloc*6;
			break;
		case 4: 
			m_memBlocNum = (pCmmbServiceInfo->LDPCRate_Cmct == 0) ? m_DeInerBloc*8 : m_DeInerBloc*12;
			break;
		default:
			Zi_log("Illegal Interleave mode!\n ");
	}
	
	return m_memBlocNum;
}

////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_FindMemForService(Zi_HANDLE hDevice, Zi_UINT8 nMemReq, Zi_UINT8 *pMemStart)
{
	Zi_UINT8 nMemInd[MAX_MEMORY_NUM], i, nStartBlk, nBlockNum, j;

	if (NULL == hDevice)
	{
		return Zi_GENERAL_ERROR;
	}
	
	Zi_memset(&nMemInd, 0, sizeof(nMemInd));

	if(nMemReq > MAX_MEMORY_NUM)
		return Zi_GENERAL_ERROR;

	for(i=0; i<6; i++)
	{
		Zi_ReadRegFields(hDevice, Zi_scConfigRegTable[i][2], 0, 5, &nStartBlk);
		Zi_ReadRegFields(hDevice, Zi_scConfigRegTable[i][1], 0, 5, &nBlockNum);

		for(j = nStartBlk; j < nStartBlk+nBlockNum; j++)
			nMemInd[j] = 1;
	}

	Zi_PrintMsg(nMemInd, MAX_MEMORY_NUM, 4);

	for(i = 0; i < MAX_MEMORY_NUM; i++)
	{
		if(nMemInd[i] == 0)
		{
			if(i % 8)
				continue;
			for(j = i; (j < i+nMemReq) && (j < MAX_MEMORY_NUM); j++)
				if(nMemInd[j] == 1)
					break;
			if(j == i+nMemReq)
			{
				*pMemStart = i;
				return Zi_RTN_OK;
			}
		}
	}
	return Zi_GENERAL_ERROR;
}

/////////////////////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_GetServiceData(Zi_HANDLE hDevice, Zi_UINT8 *pbuffer, Zi_UINT32 bufferlen, Zi_UINT8 channelIndex)
{
	Zi_DEVICE_HANDLE *pDevice = (Zi_DEVICE_HANDLE *)hDevice;
	Zi_RETURN_CODE eRtnCode = Zi_RTN_OK;
	Zi_UINT8 m_intOverflow = 0, valid;
	Zi_UINT8    uIndex = 0, i; 
	Zi_UINT8    RegVal = 0;
	Zi_UINT8    nRegStc,nRegSc;
	Zi_UINT8    FtsDelayH = 0,FtsDelayL = 0;
	Zi_UINT16   FtsDelay = 0;
	
	if (NULL == hDevice)
	{
		return Zi_GENERAL_ERROR;
	}

	eRtnCode = Zi_GetSystemStatus(pDevice);
	if(Zi_SYSTEM_UNLOCK == eRtnCode)
	{
		pDevice->bSystemLockStatus = FALSE;
		Zi_Wait_ReLockFreq(pDevice, 500);
	}
	else
	{

		if(0 != pDevice->nRefTick)
		{ 
			//for fts parameter from 0x50 to 0x6d
			if(Zi_POOR_SIGNAL == eRtnCode)
			{
				Zi_ReadReg(hDevice,REG_FTS_MISC_DENO,&RegVal);
				if (RegVal == 0x50)
				{
					Zi_WriteReg(hDevice,REG_FTS_MISC_DENO,0x6d);
				}
				Zi_ReadReg(hDevice,REG_FTS_MISC_DENO,&RegVal);
				Zi_log("Begin to parameter optimization from 50 to 6d,now 0xd9 = %x\n" ,RegVal);
			}

			if(((Zi_POOR_SIGNAL == eRtnCode))&&((Zi_GetTickCount(hDevice) - pDevice->nRefTick) > LONG_TIME_RECOVERY_THLD))
			{
				if(0 != LONG_TIME_RECOVERY_THLD)
				{
					pDevice->bSystemLockStatus = FALSE;
					Zi_log("Long time data error,begin to recovery!\n");
					Zi_Wait_ReLockFreq(pDevice, 500);					  
				}             
			}
			else if ((Zi_POOR_SIGNAL == eRtnCode)&&((Zi_GetTickCount(hDevice) - pDevice->nRefTick) > 3000))
			{
				//remove ahead slot setting because they are all well set in open/close function
				Zi_WriteReg(pDevice, REG_STC_PAR_TH, 0x66);  // enable STC notch and set to auto mode
				Zi_WriteReg(hDevice, REG_STC_MISC, 0x95);   // stc notch open
				Zi_WriteRegFields(hDevice,REG_SC_VALID_MISC, 6, 1, 0x1); //enable play stc detect
				Zi_log("3s data error,begin to STC detect and FTS parameter optimize!\n");
                        
                          
				Zi_WriteRegFields(hDevice, REG_HN_DBG_DLY_FRZ,1,1,1);  //Freeze FTS register value

				Zi_ReadReg(hDevice,REG_WIEN_DLY_SPD, &FtsDelayH);   // read FTS delay spread
				Zi_ReadReg(hDevice,REG_STR_DLY_SPD_L, &FtsDelayL);  // read FTS delay spread
				FtsDelay = FtsDelayH & 0x03;
				FtsDelay = (FtsDelay << 8) + FtsDelayL;
				Zi_ReadReg(hDevice,REG_FTS_MISC_DENO,&RegVal);      // get The FTS parameter

				if (RegVal == 0x6d && FtsDelay > 700)                 // if current value is 0x6d and delay spread>700,change from 0x6d to 0x50
				{
					Zi_WriteReg(hDevice,REG_FTS_MISC_DENO,0x50);
				}
				Zi_ReadReg(hDevice,REG_FTS_MISC_DENO,&RegVal);      // get The FTS parameter
				Zi_log("Begin to parameter optimization from 6d to 50,Delay Spread is %d now 0xd9 = %x\n",FtsDelay ,RegVal);
                
			}

		}
		else
		{
			if (Zi_POOR_SIGNAL != eRtnCode)
			{
				Zi_WriteRegFields(hDevice, REG_SC_VALID_MISC, 6, 1, 0x00); //disable stc detect
			}
			pDevice->nRefTick = Zi_GetTickCount(hDevice);
		}
		
		if(0 == bufferlen)
		{
			Zi_WriteRegFields(hDevice, REG_HIC1_INT_CLEAR, channelIndex, 1, 0x1);
			return Zi_GENERAL_ERROR;
		}
		Zi_WriteRegFields(hDevice, REG_HIC1_INT_CLEAR, channelIndex, 1, 0x1);
		
		Zi_ReadReg(hDevice, REG_OTDD_INT_STATUS, &m_intOverflow);
		if(m_intOverflow & (1 << channelIndex))
		{
			//clear overflow interrupt
			Zi_WriteRegFields(hDevice, REG_OTDD_INT_CLEAR, channelIndex, 1, 0x1);

			Zi_ReadRegFields(hDevice, REG_SC_VALID_MISC, channelIndex, 1, &valid);
			if (valid)
			{
				Zi_WriteRegFields(hDevice, REG_SC_VALID_MISC, channelIndex, 1, 0x0);
				Zi_WriteRegFields(hDevice, REG_SC_VALID_MISC, channelIndex, 1, 0x1);
			}		
		}
		
		eRtnCode = Zi_BurstRead(hDevice, Zi_dataReg[channelIndex], bufferlen, pbuffer);
		if (Zi_RTN_OK != eRtnCode)
		{
			Zi_log("Spi read data err!\n");
			return Zi_GENERAL_ERROR;
		}

	}

	return eRtnCode;
}

/////////////////////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_SccSendComand(	Zi_HANDLE hDevice,
					Zi_UINT8 *pBufIn, 
					Zi_UINT32 bufInLen)
{
	Zi_UINT8 cmd[500] = {0};
	Zi_RETURN_CODE eRtnCode = Zi_RTN_OK;
	Zi_UINT8 sccStatus=0;
	Zi_UINT32 txLen =0;
	Zi_UINT8 i;

	if (NULL == hDevice)
	{
		return Zi_GENERAL_ERROR;
	}
	
	if((hDevice== NULL)||(pBufIn == NULL))
	{
		return Zi_GENERAL_ERROR;
	}
	Zi_WriteReg(hDevice, REG_SOFT_RST, 0xbf); //soft reset scc
	Zi_WriteReg(hDevice, REG_SOFT_RST, 0xff);
	if (bufInLen == 5)	// cmd length =5:  read cmd.
	{
		Zi_memcpy(cmd, pBufIn, 5);
		eRtnCode = Zi_BurstWriteReg(hDevice, REG_7816_CMD_QUEUE, cmd ,5);
		if(eRtnCode!=Zi_RTN_OK)
		{
			Zi_log("write cmd error !\n");
			return eRtnCode;
		}
	}
	else if (bufInLen > 5 && bufInLen == (int)pBufIn[4] + 5)	// write cmd.
	{
		Zi_memcpy(cmd, pBufIn, bufInLen);
		txLen = (Zi_UINT8)cmd[4];
		eRtnCode = Zi_BurstWriteReg(hDevice, REG_7816_DATA_QUEUE, &cmd[5] ,txLen);
		eRtnCode |= Zi_BurstWriteReg(hDevice, REG_7816_CMD_QUEUE, cmd ,5);
		if(eRtnCode != Zi_RTN_OK)
		{
			Zi_log("write cmd error !\n");
			return eRtnCode;	
	   	}
	}
	else if (bufInLen > 5 && bufInLen > (int)pBufIn[4] + 5)
	{

		Zi_log("Cmd Error \n");
		return Zi_GENERAL_ERROR;
	}
	
	//Zi_PrintMsg(pBufIn, bufInLen, 3);
	return Zi_RTN_OK;
}

/////////////////////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_SccGetResponse(Zi_HANDLE hDevice,Zi_UINT8 *pBufIn, Zi_UINT32 bufInLen, Zi_UINT8 *pBufOut, Zi_UINT32 *pBufOutLen, Zi_UINT16 *sw, Zi_UINT8 *sccType)
{	   
	Zi_UINT8 cmd[10] = {0}, rsp[256] = {0}; 
	Zi_RETURN_CODE eRtnCode = Zi_RTN_OK;
	Zi_UINT8 sccStatus=0;
	Zi_UINT32 rxLen=0;
	Zi_UINT32 txLen =0;
	Zi_UINT8 i;

	if (NULL == hDevice)
	{
		return Zi_GENERAL_ERROR;
	}

	if(5 == bufInLen)  // read CMD
	{
		*sccType = Zi_7816_TYPE_READ;
		Zi_memcpy(cmd, pBufIn, 5);
		rxLen = cmd[4]+2;
		Zi_ReadReg(hDevice, REG_SCC_INT_STATUS, &sccStatus);
		if(REG_SCC_IR_TRANS_CMPLT_STATUS_BIT == (sccStatus & REG_SCC_IR_TRANS_CMPLT_STATUS_BIT))
		{
			Zi_log("trans complete : 0x%x!\n", sccStatus);
			Zi_BurstRead(hDevice, REG_7816_DATA_QUEUE, rxLen, rsp);
			*sw = (Zi_UINT16)rsp[rxLen-2]<<8 + (Zi_UINT16)rsp[rxLen-1] ;
			*pBufOutLen = rxLen;
			Zi_memcpy(pBufOut, rsp, *pBufOutLen);									  
			eRtnCode = Zi_RTN_OK;
		}	   
		if(REG_SCC_IR_TRANS_NACK_STATUS_BIT == (sccStatus & REG_SCC_IR_TRANS_NACK_STATUS_BIT))
		{
			Zi_log("trans no ack: 0x%x!\n", sccStatus);
			eRtnCode =  Zi_GENERAL_ERROR;
		}
		if(REG_SCC_IR_TRANS_PERR_STATUS_BIT == (sccStatus & REG_SCC_IR_TRANS_PERR_STATUS_BIT))
		{
			Zi_log("trans perr: 0x%x!\n", sccStatus);			
			eRtnCode =  Zi_GENERAL_ERROR;
		}
		if(REG_SCC_IR_TRANS_TIME_OUT_STATUS_BIT == (sccStatus & REG_SCC_IR_TRANS_TIME_OUT_STATUS_BIT))
		{
			Zi_log("trans timeout : 0x%x!\n", sccStatus);
			eRtnCode =  Zi_GENERAL_ERROR;
		}
		Zi_WriteReg(hDevice, REG_SCC_INT_CLEAR, 0xff);
	}
	else if (bufInLen > 5 && bufInLen == (int)pBufIn[4] + 5)	//check write CMD status.
	{
		*sccType = Zi_7816_TYPE_WRITE;
		Zi_ReadReg(hDevice, REG_SCC_INT_STATUS, &sccStatus);
		if(REG_SCC_IR_TRANS_CMPLT_STATUS_BIT == (sccStatus & REG_SCC_IR_TRANS_CMPLT_STATUS_BIT))
		{
			Zi_log("trans complete : 0x%x!\n", sccStatus);
			rxLen = 3-1;
			Zi_BurstRead(hDevice, REG_7816_DATA_QUEUE, rxLen, rsp);
			*sw = (((Zi_UINT16)rsp[rxLen-2]<<8)&0xff00)|(((Zi_UINT16)rsp[rxLen-1])&0x00ff);
			*pBufOutLen = rxLen;
			if(*sw == 0x6984)
			{
				rsp[rxLen - 2] = 0x69;
				rsp[rxLen - 1] = 0x85;
				*sw = 0x6985;
			}
			Zi_memcpy(pBufOut, rsp, *pBufOutLen);
			if(*sw == 0x6988)
			{
				Zi_BurstRead(hDevice, REG_7816_DATA_QUEUE, 253, rsp);
			}
			eRtnCode = Zi_RTN_OK;
		}	   
		if(REG_SCC_IR_TRANS_NACK_STATUS_BIT == (sccStatus & REG_SCC_IR_TRANS_NACK_STATUS_BIT))
		{
			Zi_log("trans no ack: 0x%x!\n", sccStatus);
			eRtnCode = Zi_GENERAL_ERROR;
		}
		if(REG_SCC_IR_TRANS_PERR_STATUS_BIT == (sccStatus & REG_SCC_IR_TRANS_PERR_STATUS_BIT))
		{
			Zi_log("trans perr: 0x%x!\n", sccStatus);
			eRtnCode = Zi_GENERAL_ERROR;
		}
		if(REG_SCC_IR_TRANS_TIME_OUT_STATUS_BIT == (sccStatus & REG_SCC_IR_TRANS_TIME_OUT_STATUS_BIT))
		{
			Zi_log("trans timeout : 0x%x!\n", sccStatus);
			eRtnCode = Zi_GENERAL_ERROR;
		}
		Zi_WriteReg(hDevice, REG_SCC_INT_CLEAR, 0xff);			
	}	   
	else if (bufInLen > 5 && bufInLen > (int)pBufIn[4] + 5)
	{
		Zi_log("Cmd bufInLen error!!!\n");
		eRtnCode = Zi_GENERAL_ERROR;
	}
	
	if(eRtnCode == Zi_RTN_OK)
	{
	Zi_log("APDU: inlen = %d, outlen = %d, SW: %x\n", bufInLen, *pBufOutLen, *sw);
		//Zi_PrintMsg(pBufOut, *pBufOutLen, 2);
	}
	  
	Zi_WriteReg(hDevice, REG_SOFT_RST, 0xbf); //soft reset scc
	Zi_WriteReg(hDevice, REG_SOFT_RST, 0xff);
	return eRtnCode;
}

/////////////////////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_SetSFOAheadSlot(Zi_HANDLE hDevice)
{
	Zi_DEVICE_HANDLE *pDevice = (Zi_DEVICE_HANDLE *)hDevice;
	Zi_CMMBSERVICE_INFO* pCmmbServiceInfo = NULL;
	Zi_UINT8  nTsInd[MAX_TS_NUM], i, j, SFOTrackSlot=0, STCAheadSlot=0, regVal, bTsOpened;

	if (NULL == pDevice || !pDevice->pDemuxerPrivateStruct)
	{
		return Zi_GENERAL_ERROR;
	}	
        
	bTsOpened = FALSE;
	for( i=0; i<40; i++)
	{
		nTsInd[i] = 0;
	}
        
	for(i=0; i<6; i++)
	{
		if(pDevice->ActiveService[i].nActiveServiceID != 0 && pDevice->ActiveService[i].nActiveServiceID != 0xffff)
		{
			pCmmbServiceInfo = ((Zi_DEMUXER_CONTEXT*)pDevice->pDemuxerPrivateStruct)->pSeviceChannelList;
			for(j = 0; j < ((Zi_DEMUXER_CONTEXT*)pDevice->pDemuxerPrivateStruct)->nServiceCount; j++)
			{
				if (pDevice->ActiveService[i].nActiveServiceID == pCmmbServiceInfo->ServiceID_Cmct)
				{
					bTsOpened = TRUE;
					break;
				}
				pCmmbServiceInfo++;
			}
			for( j = 0; j < pCmmbServiceInfo->TsCount_Cmct; j++ )
			{
				nTsInd[pCmmbServiceInfo->TsStartNumber_Cmct + j] = 1;
			}
		}
		else if(pDevice->ActiveService[i].nActiveServiceID == 0xffff)
		{
			bTsOpened = TRUE;
			nTsInd[0] = 1;
		}
	}
	for( i = 0; i < MAX_TS_NUM; i++ )
	{
		if(i == 0)
		{
			if(nTsInd[MAX_TS_NUM - 1] == 0 && nTsInd[i] == 1)
			{
				SFOTrackSlot = i;
				STCAheadSlot = MAX_TS_NUM - 1;
				break;
			}
		}
		else
		{
			if(nTsInd[i - 1] == 0 && nTsInd[i] == 1)
			{
				SFOTrackSlot = i;
				STCAheadSlot = i - 1;
				break;
			}
		}
	}

	Zi_ReadReg( pDevice, REG_SC_VALID_MISC, &regVal );
	if((regVal & 0x3f) == 0x20 && bTsOpened == FALSE)
	{
		SFOTrackSlot = 0;
		STCAheadSlot = MAX_TS_NUM - 1;
	}

	Zi_WriteReg(pDevice, REG_SFO_TRACK_TS_NUM, SFOTrackSlot);
	Zi_WriteReg(pDevice, REG_AHEAD_SLOT, STCAheadSlot);

	return Zi_RTN_OK;
}

/////////////////////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_SetLDPCRSWindow(Zi_HANDLE hDevice)
{
	Zi_DEVICE_HANDLE* pDevice = (Zi_DEVICE_HANDLE*) hDevice;
	Zi_CMMBSERVICE_INFO* pCmmbServiceInfo = NULL;	
	Zi_UINT8  m_qamType = 0;
	Zi_UINT16 m_rsmode = 0;
	Zi_UINT16 m_rswindow = 0;
	Zi_UINT8  m_ldpcwindow = 0;
	Zi_UINT8  i, j = 0;
	Zi_UINT8 maxService = 5;
	Zi_UINT8 maxCurMode = 0;
	Zi_UINT8 curMode = 0;
	Zi_UINT8 regVal = 0;

	if (NULL == pDevice || !pDevice->pDemuxerPrivateStruct)
	{
		return Zi_GENERAL_ERROR;
	}	

	for(i = 0; i < 6; i++)
	{
		if(pDevice->ActiveService[i].nActiveServiceID != 0 && pDevice->ActiveService[i].nActiveServiceID != 0xffff)
		{
			pCmmbServiceInfo = ((Zi_DEMUXER_CONTEXT *)pDevice->pDemuxerPrivateStruct)->pSeviceChannelList;
			for(j = 0; j < ((Zi_DEMUXER_CONTEXT*)pDevice->pDemuxerPrivateStruct)->nServiceCount; j++)
			{
				if (pDevice->ActiveService[i].nActiveServiceID == pCmmbServiceInfo->ServiceID_Cmct)
				{
					break;
				}
				pCmmbServiceInfo++;
			}
			switch(pCmmbServiceInfo->ModulateType_Cmct)
			{
				case Zi_MODULATE_TYPE_BPSK://BPSK
					m_qamType = 1;
					m_rsmode = (pCmmbServiceInfo->LDPCRate_Cmct==0)?pCmmbServiceInfo->TsCount_Cmct*2:pCmmbServiceInfo->TsCount_Cmct*3;
					break;
				case Zi_MODULATE_TYPE_QPSK://QPSK
					m_qamType = 2;
					m_rsmode = (pCmmbServiceInfo->LDPCRate_Cmct==0)?pCmmbServiceInfo->TsCount_Cmct*4:pCmmbServiceInfo->TsCount_Cmct*6;
					break;
				case Zi_MODULATE_TYPE_16QAM://16QAM
					//set LDPC
					m_qamType = 4;
					m_rsmode = (pCmmbServiceInfo->LDPCRate_Cmct==0)?pCmmbServiceInfo->TsCount_Cmct*8:pCmmbServiceInfo->TsCount_Cmct*12;
					break;
				default:
					Zi_log("Illegal QamType!\n");
					break;
			}
			m_ldpcwindow += pCmmbServiceInfo->TsCount_Cmct * m_qamType;
			m_rswindow   += m_rsmode;
		}
		else if (pDevice->ActiveService[i].nActiveServiceID == 0xffff)
		{
			m_ldpcwindow  += 1;
			m_rswindow    += 2;
		}
		 
	}
	//set concatenate rs err threshold 
	Zi_WriteReg(pDevice, REG_CONCATENATE_RS_ERR_NUM_L, m_rswindow&0xff);
	Zi_WriteReg(pDevice, REG_CONCATENATE_RS_ERR_NUM_H, (m_rswindow>>8)&0xff);
	//set RS Window
	Zi_WriteReg(pDevice, REG_RS_NUM_L, m_rswindow&0xff);
	Zi_WriteReg(pDevice, REG_RS_NUM_H, (m_rswindow>>8)&0xff);
	//set bler window(LDPC)
	Zi_WriteReg(pDevice, REG_LDPC_STA_SIZE, m_ldpcwindow);

	//set LDPC iter
	Zi_ReadReg(pDevice, REG_SC_VALID_MISC, &regVal);
	Zi_log("REG_SC_VALID_MISC = 0x%x\n", regVal);
	for(i = 0; i < 5; i++)
	{
		if(1 == ((regVal >> i) & 0x1))
		{
			switch(i)
			{
				case 0:
					Zi_ReadRegFields(hDevice, REG_SC_INFO_A, 0, 2, &curMode);
					break;
				case 1:
					Zi_ReadRegFields(hDevice, REG_SC_INFO_A, 3, 2, &curMode);
					break;
				case 2:
					Zi_ReadRegFields(hDevice, REG_SC_INFO_B, 0, 2, &curMode);
					break;
				case 3:
					Zi_ReadRegFields(hDevice, REG_SC_INFO_B, 3, 2, &curMode);
					break;
				case 4:
					Zi_ReadRegFields(hDevice, REG_SC_INFO_C, 0, 2, &curMode);
					break;
			}
			if(curMode > maxCurMode)
			{
				maxCurMode = curMode;
				maxService = i;
			}
		}
	}

	Zi_WriteRegFields(hDevice, REG_LDPC_CONFIG, 0x3, 3, maxService);	
	
	return Zi_RTN_OK;
}

/////////////////////////////////////////////////////////////////////////////////////////
Zi_INT8 Zi_GetSignalPwr(Zi_HANDLE hDevice)
{
	Zi_DEVICE_HANDLE *pDevice = (Zi_DEVICE_HANDLE *)hDevice;
	Zi_INT8 ltaGain[] = {8,1,-3,-11};//dB
	Zi_INT8 lnaGain[] = {28,24,16,10,7,3,-2,-7};//dB
	Zi_INT8 signalPwr = -70;
	Zi_UINT8 pgaGain = 0;
	Zi_UINT8 mixerGain = 0;
	Zi_UINT8 ltaVal = 0, lnaVal = 0;

	Zi_ReadTunerReg(pDevice, 0x70, &ltaVal);
	lnaVal = ltaVal & 0x0F;
	ltaVal = ltaVal & 0xF0 ;
	ltaVal = ltaVal >> 4;

	Zi_ReadTunerReg(pDevice, 0x71, &mixerGain);

	Zi_ReadTunerReg(pDevice, 0x72, &pgaGain);
	pgaGain = -18 + pgaGain / 4;
	signalPwr = -11 - ltaGain[ltaVal] - lnaGain[lnaVal] - mixerGain - pgaGain;

	return signalPwr;
}

/////////////////////////////////////////////////////////////////////////////////////////
Zi_INT8 Zi_GetInBandPwr(Zi_HANDLE hDevice)
{
	Zi_INT8 rssi = 0;
	Zi_UINT8 regVal = 0;
	rssi = Zi_GetSignalPwr(hDevice);
	return rssi;
}

/////////////////////////////////////////////////////////////////////////////////////////
Zi_UINT8 Zi_GetSystemSnr(Zi_HANDLE hDevice , Zi_SYS_STATUS *sys_status)
{
	Zi_INT8 snr = 0;
	Zi_INT8 signalPwr;
	Zi_UINT16 ldpcErr;
	Zi_UINT16 ldpcWindow;
	Zi_UINT8 maxIterNum[3]={19,19,15};
	Zi_UINT8 iterThld[3] = {9,9,9};
	Zi_UINT8 realIter;
	Zi_UINT8 curMode = 0;

	Zi_UINT8 maxCurMode = 0;
	Zi_UINT16 blerVal= 0;
	Zi_DEVICE_HANDLE *pDevice = (Zi_DEVICE_HANDLE *)hDevice;

	signalPwr = Zi_GetSignalPwr(hDevice);
	sys_status->nSignalStrength = signalPwr;    
	if(!pDevice || !pDevice->bSystemLockStatus)
	{
		sys_status->nLdpcErrCount = 0;
		sys_status->nLdpcWindow = 0;
		sys_status->nLdpcErrPercent = 100;
		sys_status->nSignalQuality = 0;
		sys_status->nRSErrCount = 0;
		sys_status->nRSWindow = 0;
		sys_status->bLock = FALSE;
		return 0;
	}
	else
	{
		sys_status->bLock = TRUE;
	}

	Zi_GetRSErr(hDevice, &(sys_status->nRSErrCount), &(sys_status->nRSWindow));
	Zi_GetBler(hDevice, &ldpcErr, &ldpcWindow);
	Zi_log("ldpcErr = %d, ldpcWindow = %d\n", ldpcErr, ldpcWindow);
	if(0 != ldpcWindow)
	{
		blerVal = ldpcErr*100/ldpcWindow;	
		if(blerVal>100)
		{
			Zi_log("nLdpcErrPercent > 100");
			blerVal = 100;
		}
	}

	sys_status->nLdpcErrPercent = blerVal;
	sys_status->nLdpcErrCount  = ldpcErr;
	sys_status->nLdpcWindow = ldpcWindow;	

	Zi_ReadReg(hDevice, REG_ITER_NUM, &realIter);
	if((0 == ldpcWindow)||(0 == realIter))
	{
		Zi_log("(0 == ldpcWindow)||(0 == realIter)\n");
		return 0;
	}    
	if((0 == ldpcErr) && (realIter <= iterThld[maxCurMode]))
	{
		snr = SNR_ITER_THRD_FACTOR + (100-SNR_ITER_THRD_FACTOR)*(iterThld[maxCurMode]-realIter)/(iterThld[maxCurMode]-3);
	}
	else if(blerVal > BLER_THLD)
	{
		snr = (SNR_BLER_THRD_FACTOR-14)*(100-blerVal)/100 + (signalPwr+90)/6 ;
	}
	else if ((/*(blerVal>=0)&&*/(blerVal < BLER_THLD)) || ((realIter > iterThld[maxCurMode]) && (realIter <= maxIterNum[maxCurMode])))
	{
		snr = SNR_BLER_THRD_FACTOR + (SNR_ITER_THRD_FACTOR - SNR_BLER_THRD_FACTOR)*(maxIterNum[curMode]-realIter)/((maxIterNum[curMode]- iterThld[maxCurMode])*2)
            + (SNR_ITER_THRD_FACTOR - SNR_BLER_THRD_FACTOR)*(BLER_THLD-blerVal)/(BLER_THLD*2) ;
	}
	if(snr > 100)
	{
		snr = 100;
	}
	if(snr < 0)
	{
		snr = 0;
	}

	sys_status->nSignalNoiseRatio = snr;
	return snr;
}

/////////////////////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_GetBler(Zi_HANDLE hDevice, Zi_UINT16 *m_bler, Zi_UINT16 *m_windowSize)
{
	Zi_UINT8 m_lblerValue = 0;
	Zi_UINT16 m_hblerValue = 0;
	Zi_UINT16 m_ldpcwindow = 0;
	Zi_DEVICE_HANDLE *pDevice = (Zi_DEVICE_HANDLE *)hDevice;
	if (pDevice == NULL)
	{
		return Zi_GENERAL_ERROR;
	}

	Zi_WriteRegFields(pDevice,REG_QBL_BLER_FREEZE, 0, 1, 0x01);
	Zi_ReadReg(pDevice, REG_BLER_L, (Zi_UINT8 *)&m_lblerValue);
	Zi_ReadReg(pDevice, REG_BLER_H, (Zi_UINT8 *)&m_hblerValue);
	Zi_ReadReg(pDevice, REG_LDPC_STA_SIZE, (Zi_UINT8 *)&m_ldpcwindow);
	*m_windowSize = m_ldpcwindow*15;
	*m_bler = (Zi_UINT16)((m_hblerValue<<8) + m_lblerValue);
	return Zi_RTN_OK;
}

/////////////////////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_GetRSErr(Zi_HANDLE hDevice, Zi_UINT16 *pRsError, Zi_UINT32 *pRsWindow)
{
	Zi_UINT8  rserr_h=0;
	Zi_UINT8  rserr_l=0;
	Zi_UINT8  rserr_head = 0;
	Zi_UINT16 rserr_sum  = 0;
	Zi_UINT32 nRsWindow=0;
	Zi_UINT8 regVal = 0;
	Zi_UINT8  i = 0;
	Zi_DEVICE_HANDLE *pDevice = (Zi_DEVICE_HANDLE *)hDevice;
	if (pDevice == NULL)
	{
		return Zi_GENERAL_ERROR;
	}
	for(i = 0; i < 20; i++)
	{
		Zi_ReadReg(pDevice, REG_RSD_8ERRNUM_H, &rserr_h);
		Zi_ReadReg(pDevice, REG_RSD_8ERRNUM_L, &rserr_l);
		Zi_ReadReg(pDevice, REG_RSD_8ERRNUM_H, &regVal);
		if( (rserr_h&0xc0) == (regVal&0xc0) )
		{		
			rserr_h= regVal;
			rserr_sum = (Zi_UINT16)(rserr_h&0x3f);
			rserr_sum = (rserr_sum<<8)+rserr_l;
			break;
		}
	}
	Zi_ReadReg(pDevice, REG_RS_NUM_H, &regVal);
	nRsWindow= regVal;
	nRsWindow= nRsWindow<<8;
	Zi_ReadReg(pDevice, REG_RS_NUM_L, &regVal);
	nRsWindow += regVal;
	*pRsWindow= nRsWindow*18;
	*pRsError = rserr_sum;
	//Zi_log("rs window=%d rsErr = %d\n", *pRsWindow, *pRsError );
	return Zi_RTN_OK;
}

/////////////////////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_GetSignalStatus(Zi_HANDLE hDevice)
{
	Zi_DEVICE_HANDLE *pDevice = (Zi_DEVICE_HANDLE *)hDevice;
	Zi_UINT8 HIC1IntStatus, HIC2IntStatus, OTDDIntStatus, MISCIntStatus, SCCIntStatus;
	Zi_SYS_STATUS *sys_status;
	Zi_SYS_STATUS dcc_sys_status ;
	Zi_UINT8 regVal=0;
	if((NULL == pDevice) || (NULL == pDevice->Zi_SysStatus))
	{
		return Zi_GENERAL_ERROR;
	}
	sys_status = pDevice->Zi_SysStatus;
	
	Zi_memset(sys_status, 0, sizeof(Zi_SYS_STATUS));

	Zi_irq_level(4);
		
	Zi_ReadReg(pDevice, REG_HIC1_INT_STATUS, &HIC1IntStatus);
	Zi_ReadReg(pDevice, REG_HIC2_INT_STATUS, &HIC2IntStatus);
	Zi_ReadReg(pDevice, REG_OTDD_INT_STATUS, &OTDDIntStatus);
	Zi_ReadReg(pDevice, REG_MISC_INT_STATUS, &MISCIntStatus);
	Zi_ReadReg(pDevice, REG_SCC_INT_STATUS, &SCCIntStatus);
	Zi_log("INT_STATUS = 0x%x, 0x%x, 0x%x, 0x%x, 0x%x\n", HIC1IntStatus, HIC2IntStatus, OTDDIntStatus, MISCIntStatus, SCCIntStatus);

	if((Zi_irq_count == 0) && ((HIC1IntStatus & 0x3f) ||(OTDDIntStatus & 0x80) || (SCCIntStatus & 0x0f)))
	{
		Zi_log("Attention!!!INT_STATUS = 0x%x, 0x%x, 0x%x\n", HIC1IntStatus, OTDDIntStatus, SCCIntStatus);
		Zi_EnableInt(pDevice, 0);
		Zi_Sleep(pDevice, 15);
		Zi_EnableInt(pDevice, 1);
	}
	
	sys_status->bLock = pDevice->bSystemLockStatus;
	sys_status->nCurrentFrequency = pDevice->nCurrentFreqkhz * 1000;

	sys_status->nSignalNoiseRatio = Zi_GetSystemSnr(pDevice, &dcc_sys_status);

	sys_status->nSignalStrength = dcc_sys_status.nSignalStrength;
	sys_status->nLdpcErrPercent = dcc_sys_status.nLdpcErrPercent;
	sys_status->nLdpcErrCount= dcc_sys_status.nLdpcErrCount;
	sys_status->nLdpcWindow = dcc_sys_status.nLdpcWindow;
	sys_status->nRSWindow= dcc_sys_status.nRSWindow;
	sys_status->nRSErrCount= dcc_sys_status.nRSErrCount;

	if (sys_status->bLock)
	{
		if (sys_status->nLdpcErrPercent==0)
		{
			if(sys_status->nSignalStrength >(256- 65)) 
			{
				sys_status->nSignalQuality = 5;
			}
			else if(sys_status->nSignalStrength >(256 - 80))
			{
				sys_status->nSignalQuality = 4;
			}
			else if(sys_status->nSignalStrength >(256 - 90))   
			{
				sys_status->nSignalQuality = 3;
			}
			else
			{
				sys_status->nSignalQuality = 3;
			}
		}
		else 
		{
			if( (sys_status->nRSWindow != 0)&& (sys_status->nRSErrCount == 0))
			{
			 	sys_status->nSignalQuality = 3;
			}
			else if (sys_status->nLdpcErrPercent < 40)
			{
				sys_status->nSignalQuality = 2;
			}
			else
			{
				sys_status->nSignalQuality = 1;
			}
		}       
	}
	else
	{
		if(sys_status->nSignalStrength >(256 - 70))
			sys_status->nSignalQuality = 2;
		else  if(sys_status->nSignalStrength >(256 - 80))
			sys_status->nSignalQuality = 1;
		else
			sys_status->nSignalQuality = 0;
	}

	if(sys_status->nSignalNoiseRatio > 40)
	{
		sys_status->nSignalNoiseRatio= (sys_status->nSignalNoiseRatio - 40)/6;
	}
	else
	{
		sys_status->nSignalNoiseRatio = 0;
	}
	
	if (sys_status->nLdpcErrPercent == 0)
	{
		if(sys_status->nSignalStrength >= 226)
		{
			sys_status->nSignalNoiseRatio = 15 + sys_status->nSignalNoiseRatio;
		}
		if(sys_status->nSignalStrength >= 161 ||sys_status->nSignalStrength <= 226)
		{
			sys_status->nSignalNoiseRatio = (sys_status->nSignalStrength - 156)/5 + sys_status->nSignalNoiseRatio;
		}
	}
	else if(sys_status->nLdpcErrPercent < 40)
	{
		sys_status->nSignalNoiseRatio = sys_status->nSignalNoiseRatio/2;
	}
	else
	{
		sys_status->nSignalNoiseRatio = 0;
	}

	Zi_log("BER = %d, InBandPwr = %d, SNR = %d, SignalQuality = %d, freq = %d \n", 
	                                sys_status->nLdpcErrPercent,
	                                sys_status->nSignalStrength - 256,
	                                sys_status->nSignalNoiseRatio,
	                                sys_status->nSignalQuality,
	                                sys_status->nCurrentFrequency);
	return Zi_RTN_OK;
}
/////////////////////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_SetTimerIntVal(Zi_HANDLE hDevice, Zi_UINT32 timerInterruptMs)
{
	Zi_UINT8 regVal;

	if (hDevice == NULL)
	{
		return Zi_GENERAL_ERROR;
	}

	if(timerInterruptMs > 255*5)
	{
		return Zi_GENERAL_ERROR;
	}
			 
	Zi_log("Timerout set to %dms-\n", timerInterruptMs);
	regVal =  timerInterruptMs/5;
			 
	if (regVal == 0)
		regVal = 1;

	//Zi_WriteRegFields(hDevice, REG_OTDD_INT_CLEAR, 7, 1, 0x1);
	Zi_WriteReg(hDevice, REG_TIMER_OUT, 0);//clr old timeout
	Zi_WriteReg(hDevice, REG_TIMER_OUT, regVal);//enable new old timeout
	return Zi_RTN_OK;

}

/////////////////////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_Wait_ReLockFreq(Zi_HANDLE hDevice, Zi_UINT32 nTimeOut)
{
	Zi_DEVICE_HANDLE *pDevice = (Zi_DEVICE_HANDLE *) hDevice;
	Zi_RETURN_CODE eRtnCode = Zi_GENERAL_ERROR;	
	Zi_UINT32 nStartTime = 0;

	if (NULL == pDevice)
	{
		return Zi_GENERAL_ERROR;
	}

	Zi_log("Chip unlock!!!\n");
	Zi_WriteReg(pDevice, REG_TIMER_OUT, 0);
	Zi_WriteRegFields(pDevice, REG_OTDD_INT_CLEAR, 7, 1, 0x1);

	if(Zi_RTN_OK != Zi_SyncSignal(pDevice))
	{
		pDevice->bSystemLockStatus = FALSE;
		return Zi_GENERAL_ERROR;		 
	}

	nStartTime = Zi_GetTickCount(pDevice);
	while(Zi_GetTickCount(hDevice) < (nStartTime + nTimeOut))
	{
		eRtnCode = Zi_IsSignalLocked(pDevice);
		switch(eRtnCode)
		{
			case Zi_RTN_OK:
				pDevice->bSystemLockStatus = TRUE;
				Zi_log("Chip relock freq success!!!\n");
				return Zi_RTN_OK;
				break;
			case Zi_POLLING_STATUS:
				//do nothing, remain current state.
				break;
			case Zi_CLCHCRC_FAIL:			   
				break;
			case Zi_FTS_FAIL_INT:
			case Zi_TIME_OUT:
			case Zi_FTS_FAIL_CURRENT:
				pDevice->bSystemLockStatus = FALSE;
				Zi_SetTimerIntVal(pDevice, 500);
				return eRtnCode; 
				break;

			default:
				break;		  	
		}
	}

	return eRtnCode;	
}

/////////////////////////////////////////////////////////////////////////////////////////
Zi_RETURN_CODE Zi_GetSystemStatus(Zi_HANDLE hDevice)
{
	Zi_DEVICE_HANDLE* pDevice = (Zi_DEVICE_HANDLE*) hDevice;
	Zi_UINT8 regVal;
	Zi_UINT16 blerVal = 0;
	Zi_UINT16 blerWindow = 30;
	Zi_UINT16 bler = 0;
	Zi_UINT8 maxDelayH;
	Zi_UINT8 maxDelayL;
	Zi_UINT8 secondPathH;
	Zi_UINT8 secondPathL;
	Zi_UINT16 maxDelayVal;
	Zi_UINT16 secondPathVal;
	Zi_UINT8 cheCfg;
	Zi_RETURN_CODE eRtnCode = Zi_RTN_OK;

	if (NULL == pDevice)
	{
		return Zi_GENERAL_ERROR;
	}

	if(!pDevice->bSystemLockStatus)
	{
		return Zi_SYSTEM_UNLOCK;
	}

	eRtnCode = Zi_ReadReg(pDevice, REG_HIC1_INT_STATUS ,&regVal);
	if(Zi_RTN_OK != eRtnCode)
	{
		Zi_log("Read Reg error!\n");
		return eRtnCode;
	}
	if (REG_TDP_IR_FTS_FAIL_STATUS_BIT == (regVal & REG_TDP_IR_FTS_FAIL_STATUS_BIT))
	{
		Zi_WriteReg(pDevice, REG_HIC1_INT_CLEAR, REG_TDP_IR_FTS_FAIL_CLEAR_BIT );
		Zi_log("FTS fail in normal stage !\n" );
		return Zi_SYSTEM_UNLOCK;
	}

	Zi_ReadReg(hDevice, REG_MISC_INT_STATUS, &regVal );
	if(REG_TDP_IR_STC_FOUND_STATUS_BIT == (regVal & REG_TDP_IR_STC_FOUND_STATUS_BIT))
	{
		Zi_log("STC found,status:0x%x!\n",regVal );
		Zi_WriteReg(pDevice, REG_MISC_INT_CLEAR, REG_TDP_IR_STC_FOUND_CLEAN_BIT);
    	}

	Zi_GetBler(pDevice, &blerVal, &blerWindow);
	if(0 != blerWindow)
	{
		bler = blerVal*100/blerWindow;
	}
	if(bler > BLER_THLD)
	{ 
		Zi_log("bler is %d at time:%d!\n",bler, Zi_GetTickCount(pDevice));
		eRtnCode = Zi_POOR_SIGNAL;
	}
	else
	{
		pDevice->nRefTick = 0;
	}

    	return eRtnCode;
}

Zi_RETURN_CODE Zi_DebugReadReg(Zi_HANDLE hDevice)
{
	Zi_UINT8 regAddr1[]={REG_HIC1_INT_STATUS, REG_MISC_INT_STATUS, REG_WIEN_DLY_SPD, REG_STR_DLY_SPD_L, REG_TSD_STAT, REG_AGC_RSSI_VAL_L, REG_AGC_GAIN_CW, REG_ITER_NUM, REG_CLP_STATUS, REG_BLER_H, REG_BLER_L, REG_FTS_DLY_SPD_L, REG_FTS_DLY_SPD_H, REG_RSD_8ERRNUM_H, REG_RSD_8ERRNUM_L};
	Zi_UINT8 regAddr2[]={REG_HIC1_INT_STATUS, REG_MISC_INT_STATUS, REG_WIEN_DLY_SPD, REG_STR_DLY_SPD_L, REG_TSD_STAT, REG_AGC_RSSI_VAL_L, REG_AGC_GAIN_CW, REG_ITER_NUM, REG_CLP_STATUS };
	Zi_UINT8 tunerAddr[]={0x6d,0x6e,0x70,0x71,0x72,0x77,0x78,0x79};
	Zi_UINT32 i;
	Zi_UINT8 regVal;
	Zi_UINT8 fts_delay_h,fts_delay_l;
	Zi_UINT16 fts_delay = 0;

	Zi_UINT8 ncoH,ncoM,ncoL;
	Zi_UINT32 ncoVal;
	Zi_INT32 ifoVal;
	Zi_UINT32 ifo;
	Zi_UINT8 sfoH,sfoM,sfoL;
	Zi_UINT32 sfoVal;
	Zi_INT32 sfo_buma;
	Zi_UINT32 sfo;
	static Zi_UINT8 flag = 0;

	Zi_UINT8 miscIntStatus = 0;
	Zi_UINT8 syncStatus = 0;
	Zi_UINT8 StcIdx_L = 0;
	Zi_UINT8 StcIdx_H = 0;
	Zi_UINT8 StcPeak_L = 0;
	Zi_UINT8 StcPeak_H = 0;
	Zi_UINT8 StcAvg_L = 0;
	Zi_UINT8 StcAvg_H = 0;
	Zi_INT32 StcIdx = 0;
	Zi_INT32 StcPeak = 0;
	Zi_INT32 StcAvg = 0;
	Zi_UINT8 rs_error_l = 0;
	Zi_UINT8 rs_error_h = 0;
	Zi_UINT16 rs_error = 0;
	Zi_UINT8 winer_coeff = 0;
	Zi_INT8 signalPwr = -70;

	Zi_WriteRegFields(hDevice,REG_QBL_BLER_FREEZE,0,1,1);
	Zi_WriteRegFields(hDevice,REG_HN_DBG_DLY_FRZ,1,1,1);
	Zi_WriteReg(hDevice,REG_TDP_MISC_FRZ,0xff);

	for(i=0; i<sizeof(regAddr1); i++)
	{
		Zi_ReadReg(hDevice, regAddr1[i], &regVal);
		Zi_logg("0x%x=0x%x,",regAddr1[i],regVal);
		if (regAddr1[i] == 0x75 && regVal != 0)
		{
			Zi_ReadReg(hDevice, regAddr1[i], &rs_error_l);
			Zi_ReadReg(hDevice, regAddr1[i-1], &rs_error_h);
			rs_error = (Zi_UINT16)(rs_error_h<<8) + (Zi_UINT16)(rs_error_l);
			Zi_logg("________RS error = 0x%x________",rs_error);
		}

	}

	for(i=0;i<sizeof(regAddr2);i++)
	{
		Zi_ReadReg(hDevice, regAddr2[i], &regVal);
		Zi_logg("0x%x=0x%x,",regAddr2[i],regVal);

	}

	Zi_logg("\nTuner");
	for(i=0;i<sizeof(tunerAddr);i++)
	{
		Zi_ReadTunerReg(hDevice, tunerAddr[i], &regVal);
		Zi_logg("0x%x=0x%x,",tunerAddr[i],regVal);

	}
	Zi_logg("\n");

	Zi_WriteReg(hDevice,REG_TDP_MISC_FRZ,0xff);
	Zi_WriteRegFields(hDevice, REG_HN_DBG_DLY_FRZ,1,1,1); //by liujun 0602
	//Zi_WriteRegFields(hDevice,REG_TDP_MISC_FRZ ,1,1,1);

	Zi_ReadReg(hDevice,REG_WIEN_DLY_SPD, &fts_delay_h);
	Zi_ReadReg(hDevice,REG_STR_DLY_SPD_L, &fts_delay_l);
	winer_coeff = (fts_delay_h >> 2) & 0xf;

	fts_delay = fts_delay_h & 0x03;
	fts_delay = (fts_delay << 8) + fts_delay_l;

	//	fts_delay = (Zi_UINT16)(fts_delay_h<<8) + fts_delay_l;

	Zi_ReadReg(hDevice,REG_NCO_FCW_H,&ncoH);
	Zi_ReadReg(hDevice,REG_NCO_FCW_M,&ncoM);
	Zi_ReadReg(hDevice,REG_NCO_FCW_L,&ncoL);

	ncoVal = (Zi_UINT32)(ncoH<<16)+(Zi_UINT16)(ncoM<<8)+ncoL;
	if (ncoVal>(1<<23))
	{
		ifoVal = (Zi_INT32)(ncoVal - (1<<24));
	}
	else
		ifoVal = ncoVal;
	ifo = ifoVal*15/1000;//10e6/(1<<26);

	//CFOVal = ifo_buma/2^26*10e6;

	Zi_ReadReg(hDevice,REG_SFO_VAL_H,&sfoH);
	Zi_ReadReg(hDevice,REG_SFO_VAL_M,&sfoM);
	Zi_ReadReg(hDevice,REG_SFO_VAL_L,&sfoL);

	sfoVal = (Zi_UINT32)(sfoH<<16) + (Zi_UINT16)(sfoM<<8) + sfoL;
	if (sfoVal > (1<<23))
	{
		sfo_buma = sfoVal - (1<<24);
	}
	else
		sfo_buma = sfoVal;

	sfo =  sfo_buma * 15/1000;// 10e7 / (1<<24) / 39;
	Zi_logg("fts delay spread :%d uS, winer coeff num : %d  ifo: %d Hz , sfo: %d Hz !\n", fts_delay/10 ,winer_coeff, ifo, sfo);

	Zi_WriteRegFields(hDevice, REG_MISC_CTRL, 6,1,0); // Close TDP clock gating

	Zi_Sleep(hDevice,100);
	Zi_WriteReg(hDevice, REG_TDP_MISC_FRZ, 0xff); // Freeze the TDP result

	Zi_ReadReg(hDevice, REG_STC_NOTCH_CTRL, &miscIntStatus); // Read notch result

	if (flag == 0)
	{
		if ((miscIntStatus & 0x01) == 1) // Notch occur
		{

			Zi_Sleep(hDevice,100);
			Zi_WriteReg(hDevice, REG_TDP_MISC_FRZ, 0xff); // Freeze the TDP result
			Zi_ReadReg(hDevice, REG_STC_PEAK_IDX_L, &StcIdx_L); // Read notch result L
			Zi_ReadReg(hDevice, REG_STC_PEAK_IDX_H, &StcIdx_H); // Read notch result H
			StcIdx = (StcIdx_H << 8) + StcIdx_L;

			Zi_ReadReg(hDevice, REG_STC_PEAK_VAL_L, &StcPeak_L); // Read STC peak L
			Zi_ReadReg(hDevice, REG_STC_PEAK_VAL_H, &StcPeak_H); // Read STC peak H
			StcPeak = (StcPeak_H << 8) + StcPeak_L;

			Zi_ReadReg(hDevice, REG_STC_AVG_VAL_L, &StcAvg_L); // Read STC average L
			Zi_ReadReg(hDevice, REG_STC_AVG_VAL_H, &StcAvg_H); // Read STC average H
			StcAvg = (StcAvg_H << 8)+ StcAvg_L;
			Zi_WriteRegFields(hDevice, REG_MISC_CTRL, 6,1,1); // Close TDP clock gating
			Zi_logg("STC exist in initial stage: index: %d, peak: %d, average: %d\n" ,StcIdx,StcPeak,StcAvg);

		}
		else
		{
			Zi_logg("no STC in initial stage!");
		}
		flag = 1;
	}

	Zi_ReadReg(hDevice, REG_SC_VALID_MISC, &miscIntStatus); // if STC detect is on

	if ((miscIntStatus & (1<< 6)) == 0x40)

	{
		Zi_ReadReg(hDevice, REG_MISC_INT_STATUS, &miscIntStatus); // Read notch result

		if ((miscIntStatus & (1<< 7)) == 0x80) // Notch occur
		{
			Zi_Sleep(hDevice,100);
			Zi_WriteReg(hDevice, REG_TDP_MISC_FRZ, 0xff); // Freeze the TDP result

			Zi_ReadReg(hDevice, REG_STC_PEAK_IDX_L, &StcIdx_L); // Read notch result L
			Zi_ReadReg(hDevice, REG_STC_PEAK_IDX_H, &StcIdx_H); // Read notch result H
			StcIdx = (StcIdx_H << 8) + StcIdx_L;

			Zi_ReadReg(hDevice, REG_STC_PEAK_VAL_L, &StcPeak_L); // Read STC peak L
			Zi_ReadReg(hDevice, REG_STC_PEAK_VAL_H, &StcPeak_H); // Read STC peak H
			StcPeak = (StcPeak_H << 8) + StcPeak_L;

			Zi_ReadReg(hDevice, REG_STC_AVG_VAL_L, &StcAvg_L); // Read STC average L
			Zi_ReadReg(hDevice, REG_STC_AVG_VAL_H, &StcAvg_H); // Read STC average H
			StcAvg = (StcAvg_H << 8)+ StcAvg_L;
			Zi_WriteRegFields(hDevice, REG_MISC_CTRL, 6,1,1); // Close TDP clock gating
			Zi_logg("STC exist in normal stage: index: %d, peak: %d, average: %d\n" ,StcIdx,StcPeak,StcAvg);
		}
		else
		{
			Zi_logg("no STC exist in normal stage!");
		}

	}

	signalPwr = Zi_GetSignalPwr(hDevice);

	Zi_logg("Signal power:: %d\n" ,signalPwr);
#if 0
	Zi_WriteReg(hDevice, REG_HIC1_INT_CLEAR, 0xff);
	Zi_WriteReg(hDevice, REG_HIC2_INT_CLEAR, 0xff);
	Zi_WriteReg(hDevice, REG_OTDD_INT_CLEAR, 0xff);
	Zi_WriteReg(hDevice, REG_MISC_INT_CLEAR, 0xff);
#endif
}